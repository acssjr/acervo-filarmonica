[{"url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859836","pull_request_review_id":3800542859,"id":2806859836,"node_id":"PRRC_kwDOQfTkdM6nTUg8","diff_hunk":"@@ -129,38 +131,82 @@ const EditarEnsaioModal = ({ ensaio, usuarios, onClose, onUpdate, addNotificatio\n     }));\n     setPartiturasDisponiveis(prev => prev.filter(p => p.id !== partituraId));\n     setBuscaPartitura('');\n-    try {\n-      await API.addPartituraEnsaio(ensaio.data_ensaio, partituraId);\n-      onUpdate?.();\n-    } catch (error) {\n-      carregarDetalhe();\n-      addNotification?.('Erro ao adicionar partitura', 'error');\n-    }\n+    setHasChanges(true);\n   };\n \n-  const handleRemoverPartitura = async (epId, _partituraId) => {\n+  const handleRemoverPartitura = (epId, _partituraId) => {\n+    // If it's a real record (not optimistic), mark for deletion\n+    if (!epId.toString().startsWith('optimistic-')) {\n+      setPartiturasRemovidasIds(prev => new Set(prev).add(epId));\n+    }\n+\n     setDetalhe(prev => ({\n       ...prev,\n       partituras: prev.partituras.filter(p => p.id !== epId),\n       total_partituras: prev.total_partituras - 1\n     }));\n+    setHasChanges(true);\n+  };","path":"frontend/src/screens/admin/modals/EditarEnsaioModal.jsx","commit_id":"e50e8e98f326d3c44fd687e698543667489bb1ac","original_commit_id":"19c0c5513788df4f814aff423612c5bbb8d02eb6","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_‚ö†Ô∏è Potential issue_ | _üî¥ Critical_\n\n<details>\n<summary>üß© Analysis chain</summary>\n\nüèÅ Script executed:\n\n```shell\n# Find API definition for removePartituraEnsaio\nrg -n \"removePartituraEnsaio\" -g '*.{js,jsx,ts,tsx}' -B3 -A5\n```\n\nRepository: acssjr/acervo-filarmonica\n\nLength of output: 3723\n\n---\n\nüèÅ Script executed:\n\n```shell\n# Check the AdminPresenca.jsx file around the claimed lines\nfd AdminPresenca.jsx -x cat -n {} | sed -n '660,670p;1425,1435p'\n```\n\nRepository: acssjr/acervo-filarmonica\n\nLength of output: 1145\n\n---\n\nüèÅ Script executed:\n\n```shell\n# Check EditarEnsaioModal.jsx around lines 137-177 to verify current code\nfd EditarEnsaioModal.jsx -x cat -n {} | sed -n '137,177p'\n```\n\nRepository: acssjr/acervo-filarmonica\n\nLength of output: 1805\n\n---\n\nüèÅ Script executed:\n\n```shell\n# Find the API service file\nfd -e js -e jsx -e ts -e tsx | xargs grep -l \"removePartituraEnsaio\" | grep -i api\n```\n\nRepository: acssjr/acervo-filarmonica\n\nLength of output: 97\n\n---\n\nüèÅ Script executed:\n\n```shell\n# Verify where handleRemoverPartitura is called in EditarEnsaioModal to confirm p.id vs p.partitura_id\nfd EditarEnsaioModal.jsx -x grep -n \"handleRemoverPartitura\" {}\n```\n\nRepository: acssjr/acervo-filarmonica\n\nLength of output: 233\n\n---\n\n\n\n</details>\n\n**Bug: `partiturasRemovidasIds` stores `ensaios_partituras.id` but `API.removePartituraEnsaio` expects `partitura_id`.**\n\nAt line 140, `epId` (which is `p.id` ‚Äî the `ensaios_partituras` record ID) is stored in `partiturasRemovidasIds`. At line 176, these IDs are passed to `API.removePartituraEnsaio(ensaio.data_ensaio, id)`. The backend service (ensaioService.js) deletes records WHERE `partitura_id = ?`, matching against the partitura ID, not the ensaios_partituras record ID. This causes the deletion to fail or delete incorrect records.\n\nThe `_partituraId` parameter (received at line 137 from line 537 as `p.partitura_id`) is never used‚Äîit should be tracked instead of `epId`.\n\n<details>\n<summary>üêõ Proposed fix: track partitura_id instead of epId</summary>\n\n```diff\n-  const handleRemoverPartitura = (epId, _partituraId) => {\n-    // If it's a real record (not optimistic), mark for deletion\n-    if (!epId.toString().startsWith('optimistic-')) {\n-      setPartiturasRemovidasIds(prev => new Set(prev).add(epId));\n-    }\n+  const handleRemoverPartitura = (epId, partituraId) => {\n+    // If it's a real record (not optimistic), mark for deletion by partitura_id\n+    if (!epId.toString().startsWith('optimistic-')) {\n+      setPartiturasRemovidasIds(prev => new Set(prev).add(partituraId));\n+    }\n```\n</details>\n\n<!-- suggestion_start -->\n\n<details>\n<summary>üìù Committable suggestion</summary>\n\n> ‚ÄºÔ∏è **IMPORTANT**\n> Carefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation. Thoroughly test & benchmark the code to ensure it meets the requirements.\n\n```suggestion\n  const handleRemoverPartitura = (epId, partituraId) => {\n    // If it's a real record (not optimistic), mark for deletion by partitura_id\n    if (!epId.toString().startsWith('optimistic-')) {\n      setPartiturasRemovidasIds(prev => new Set(prev).add(partituraId));\n    }\n\n    setDetalhe(prev => ({\n      ...prev,\n      partituras: prev.partituras.filter(p => p.id !== epId),\n      total_partituras: prev.total_partituras - 1\n    }));\n    setHasChanges(true);\n  };\n```\n\n</details>\n\n<!-- suggestion_end -->\n\n<details>\n<summary>ü§ñ Prompt for AI Agents</summary>\n\n```\nIn `@frontend/src/screens/admin/modals/EditarEnsaioModal.jsx` around lines 137 -\n149, The handler handleRemoverPartitura currently adds the ensaios_partituras\nrecord id (epId) into partiturasRemovidasIds but the API.removePartituraEnsaio\nexpects the partitura_id; update handleRemoverPartitura to store _partituraId\n(the partitura_id argument) into partiturasRemovidasIds (use\nsetPartiturasRemovidasIds(prev => new Set(prev).add(_partituraId))) and keep the\nUI removal logic that filters by epId in setDetalhe (so you still remove the\ncorrect UI item), and ensure API.removePartituraEnsaio is called with the stored\npartitura_id values rather than ensaios_partituras ids.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:medusa:phoenix -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-02-14T03:02:27Z","updated_at":"2026-02-14T03:02:28Z","html_url":"https://github.com/acssjr/acervo-filarmonica/pull/95#discussion_r2806859836","pull_request_url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/95","_links":{"self":{"href":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859836"},"html":{"href":"https://github.com/acssjr/acervo-filarmonica/pull/95#discussion_r2806859836"},"pull_request":{"href":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/95"}},"reactions":{"url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859836/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":137,"original_start_line":137,"start_side":"RIGHT","line":149,"original_line":149,"side":"RIGHT","author_association":"NONE","original_position":145,"position":145,"subject_type":"line"},{"url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859839","pull_request_review_id":3800542859,"id":2806859839,"node_id":"PRRC_kwDOQfTkdM6nTUg_","diff_hunk":"@@ -129,38 +131,82 @@ const EditarEnsaioModal = ({ ensaio, usuarios, onClose, onUpdate, addNotificatio\n     }));\n     setPartiturasDisponiveis(prev => prev.filter(p => p.id !== partituraId));\n     setBuscaPartitura('');\n-    try {\n-      await API.addPartituraEnsaio(ensaio.data_ensaio, partituraId);\n-      onUpdate?.();\n-    } catch (error) {\n-      carregarDetalhe();\n-      addNotification?.('Erro ao adicionar partitura', 'error');\n-    }\n+    setHasChanges(true);\n   };\n \n-  const handleRemoverPartitura = async (epId, _partituraId) => {\n+  const handleRemoverPartitura = (epId, _partituraId) => {\n+    // If it's a real record (not optimistic), mark for deletion\n+    if (!epId.toString().startsWith('optimistic-')) {\n+      setPartiturasRemovidasIds(prev => new Set(prev).add(epId));\n+    }\n+\n     setDetalhe(prev => ({\n       ...prev,\n       partituras: prev.partituras.filter(p => p.id !== epId),\n       total_partituras: prev.total_partituras - 1\n     }));\n+    setHasChanges(true);\n+  };\n+\n+  const handleSalvar = async () => {\n+    setSaving(true);\n     try {\n-      await API.removePartituraEnsaio(ensaio.data_ensaio, epId);\n-      onUpdate?.();\n+      const promises = [];\n+\n+      // 1. Process Presences\n+      const currentIds = new Set(detalhe.presentes.map(p => p.usuario_id));\n+      const toAdd = [...currentIds].filter(id => !originalPresenteIds.has(id));\n+      const toRemove = [...originalPresenteIds].filter(id => !currentIds.has(id));\n+\n+      if (toAdd.length > 0) {\n+        promises.push(API.registrarPresencas(ensaio.data_ensaio, toAdd));\n+      }\n+      toRemove.forEach(id => {\n+        promises.push(API.removerPresenca(ensaio.data_ensaio, id));\n+      });\n+\n+      // 2. Process Partituras\n+      // Add new ones\n+      const partiturasToAdd = detalhe.partituras.filter(p => p._optimistic);\n+      partiturasToAdd.forEach(p => {\n+        promises.push(API.addPartituraEnsaio(ensaio.data_ensaio, p.partitura_id));\n+      });\n+      // Remove deleted ones\n+      partiturasRemovidasIds.forEach(id => {\n+        promises.push(API.removePartituraEnsaio(ensaio.data_ensaio, id));\n+      });\n+\n+      await Promise.all(promises);\n+\n+      onUpdate?.(); // Refreshes parent data\n+      onClose();    // Closes modal\n+      addNotification?.('Ensaio atualizado com sucesso', 'success');\n+\n     } catch (error) {\n-      carregarDetalhe();\n-      addNotification?.('Erro ao remover partitura', 'error');\n+      console.error(error);\n+      addNotification?.('Erro ao salvar algumas altera√ß√µes.', 'error');\n+    } finally {\n+      setSaving(false);\n     }\n   };\n \n+  // Filtered lists\n   // Filtered lists","path":"frontend/src/screens/admin/modals/EditarEnsaioModal.jsx","commit_id":"e50e8e98f326d3c44fd687e698543667489bb1ac","original_commit_id":"19c0c5513788df4f814aff423612c5bbb8d02eb6","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_‚ö†Ô∏è Potential issue_ | _üü° Minor_\n\n**Duplicate comment: `// Filtered lists` appears twice.**\n\nLines 193-194 have the same comment repeated.\n\n<details>\n<summary>‚úèÔ∏è Remove duplicate</summary>\n\n```diff\n-  // Filtered lists\n   // Filtered lists\n```\n</details>\n\n<!-- suggestion_start -->\n\n<details>\n<summary>üìù Committable suggestion</summary>\n\n> ‚ÄºÔ∏è **IMPORTANT**\n> Carefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation. Thoroughly test & benchmark the code to ensure it meets the requirements.\n\n```suggestion\n  // Filtered lists\n```\n\n</details>\n\n<!-- suggestion_end -->\n\n<details>\n<summary>ü§ñ Prompt for AI Agents</summary>\n\n```\nIn `@frontend/src/screens/admin/modals/EditarEnsaioModal.jsx` around lines 193 -\n194, Remove the duplicated inline comment by deleting one of the two \"//\nFiltered lists\" occurrences in the EditarEnsaioModal component\n(EditarEnsaioModal.jsx) so the comment appears only once; locate the repeated\ncomments near the filtered lists logic and keep the single, most contextually\nplaced comment.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:medusa:phoenix -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-02-14T03:02:27Z","updated_at":"2026-02-14T03:02:28Z","html_url":"https://github.com/acssjr/acervo-filarmonica/pull/95#discussion_r2806859839","pull_request_url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/95","_links":{"self":{"href":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859839"},"html":{"href":"https://github.com/acssjr/acervo-filarmonica/pull/95#discussion_r2806859839"},"pull_request":{"href":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/95"}},"reactions":{"url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859839/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":193,"original_start_line":193,"start_side":"RIGHT","line":194,"original_line":194,"side":"RIGHT","author_association":"NONE","original_position":194,"position":194,"subject_type":"line"},{"url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859841","pull_request_review_id":3800542859,"id":2806859841,"node_id":"PRRC_kwDOQfTkdM6nTUhB","diff_hunk":"@@ -89,21 +71,50 @@ export async function calcularStreak(env, usuarioId) {\n  * @returns {Promise<Object>} - Payload completo com streak, hist√≥rico, etc\n  */\n export async function getPresencaUsuario(env, usuarioId) {\n-  // Calcular streak e estat√≠sticas\n-  const streakData = await calcularStreak(env, usuarioId);\n+  // 1. Buscar os √∫ltimos 7 ensaios REAIS registrados no banco\n+  // (datas onde houve pelo menos uma presen√ßa registrada por qualquer pessoa)\n+  const ultimasDatas = await env.DB.prepare(`\n+    SELECT DISTINCT data_ensaio\n+    FROM presencas\n+    ORDER BY data_ensaio DESC\n+    LIMIT 100\n+  `).all();","path":"worker/src/domain/presenca/presencaService.js","commit_id":"e50e8e98f326d3c44fd687e698543667489bb1ac","original_commit_id":"19c0c5513788df4f814aff423612c5bbb8d02eb6","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_‚ö†Ô∏è Potential issue_ | _üü° Minor_\n\n**Comment says \"√∫ltimos 7\" but code fetches 100.**\n\nLine 74 comment reads `\"Buscar os √∫ltimos 7 ensaios REAIS\"` but the query uses `LIMIT 100`. Update the comment to match the actual behavior.\n\n\n\n<details>\n<summary>‚úèÔ∏è Fix comment</summary>\n\n```diff\n-  // 1. Buscar os √∫ltimos 7 ensaios REAIS registrados no banco\n+  // 1. Buscar os √∫ltimos 100 ensaios REAIS registrados no banco\n```\n</details>\n\n<!-- suggestion_start -->\n\n<details>\n<summary>üìù Committable suggestion</summary>\n\n> ‚ÄºÔ∏è **IMPORTANT**\n> Carefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation. Thoroughly test & benchmark the code to ensure it meets the requirements.\n\n```suggestion\n  // 1. Buscar os √∫ltimos 100 ensaios REAIS registrados no banco\n  // (datas onde houve pelo menos uma presen√ßa registrada por qualquer pessoa)\n  const ultimasDatas = await env.DB.prepare(`\n    SELECT DISTINCT data_ensaio\n    FROM presencas\n    ORDER BY data_ensaio DESC\n    LIMIT 100\n  `).all();\n```\n\n</details>\n\n<!-- suggestion_end -->\n\n<details>\n<summary>ü§ñ Prompt for AI Agents</summary>\n\n```\nIn `@worker/src/domain/presenca/presencaService.js` around lines 74 - 81, The\ninline comment above the SQL that fetches distinct data_ensaio (the comment\nbefore const ultimasDatas) incorrectly says \"√∫ltimos 7\" while the query uses\nLIMIT 100; update that comment to reflect the actual behavior (e.g., \"Buscar os\n√∫ltimos 100 ensaios REAIS registrados no banco\") so the comment matches the SQL\nused by ultimasDatas.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:medusa:phoenix -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-02-14T03:02:27Z","updated_at":"2026-02-14T03:02:28Z","html_url":"https://github.com/acssjr/acervo-filarmonica/pull/95#discussion_r2806859841","pull_request_url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/95","_links":{"self":{"href":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859841"},"html":{"href":"https://github.com/acssjr/acervo-filarmonica/pull/95#discussion_r2806859841"},"pull_request":{"href":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/95"}},"reactions":{"url":"https://api.github.com/repos/acssjr/acervo-filarmonica/pulls/comments/2806859841/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":74,"original_start_line":74,"start_side":"RIGHT","line":81,"original_line":81,"side":"RIGHT","author_association":"NONE","original_position":106,"position":106,"subject_type":"line"}]