<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Acervo Digital | Filarmônica 25 de Março</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --primary: #E85A4F;
      --primary-light: #FF7B6F;
      --primary-dark: #C94A40;
      
      /* Light theme */
      --bg-primary: #F8F6F2;
      --bg-secondary: #FFFFFF;
      --bg-card: #FFFFFF;
      --bg-card-hover: #F5F3EF;
      --text-primary: #1A1A1A;
      --text-secondary: #5A5A5A;
      --text-muted: #9A9A9A;
      --border: #EEEBE6;
      --shadow: 0 2px 12px rgba(0,0,0,0.06);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.08);
      
      --radius-lg: 24px;
      --radius: 18px;
      --radius-sm: 12px;
    }

    [data-theme="dark"] {
      --bg-primary: #121212;
      --bg-secondary: #1A1A1A;
      --bg-card: #1E1E1E;
      --bg-card-hover: #262626;
      --text-primary: #FFFFFF;
      --text-secondary: #A0A0A0;
      --text-muted: #666666;
      --border: #2A2A2A;
      --shadow: 0 2px 12px rgba(0,0,0,0.3);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.4);
    }

    html, body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.3s ease, color 0.3s ease;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: auto;
    }
    
    /* Efeito elástico no iOS/Safari */
    @supports (-webkit-touch-callout: none) {
      body {
        overflow-y: scroll;
      }
    }

    #root {
      min-height: 100vh;
      padding-bottom: 100px;
    }
    
    /* Garantir cores corretas em formulários */
    input, select, textarea, button {
      font-family: 'Outfit', sans-serif;
      color: inherit;
    }
    
    select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    
    /* Fix para inputs no modo claro */
    input::placeholder {
      color: var(--text-muted);
    }
    
    @media (min-width: 768px) {
      #root {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px 40px 100px;
      }
      
      /* Categorias em 4 colunas no desktop */
      .categories-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
      }
      
      /* Partituras em grid melhor distribuído */
      .sheets-grid {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }
    }
    
    /* Layout Desktop com Sidebar - a partir de 1024px */
    @media (min-width: 1024px) {
      #root {
        max-width: 100%;
        margin: 0;
        padding: 0;
      }
      
      .desktop-layout {
        display: flex;
        min-height: 100vh;
        width: 100%;
        overflow: visible;
      }
      
      .desktop-sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 260px;
        background: linear-gradient(165deg, rgba(114, 47, 55, 0.95) 0%, rgba(92, 26, 27, 0.98) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255,255,255,0.1);
        padding: 24px 0;
        display: flex;
        flex-direction: column;
        z-index: 100;
        overflow: visible;
        box-shadow: 4px 0 24px rgba(0,0,0,0.15);
      }
      
      .desktop-sidebar-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        -ms-scroll-chaining: none;
        scrollbar-width: thin;
        scrollbar-color: rgba(255,255,255,0.2) transparent;
      }
      
      .desktop-sidebar-content::-webkit-scrollbar {
        width: 6px;
      }
      
      .desktop-sidebar-content::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .desktop-sidebar-content::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
      }
      
      .desktop-sidebar-content::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.3);
      }
      
      .desktop-main {
        margin-left: 260px;
        padding: 24px 40px;
        min-height: 100vh;
        width: calc(100% - 260px);
        box-sizing: border-box;
        overscroll-behavior: contain;
        overflow: visible;
      }
      
      .mobile-only {
        display: none !important;
      }
      
      /* Esconder header mobile no desktop */
      .desktop-main > div > header:first-child {
        display: none;
      }
      
      /* Seção de destaque padding */
      .featured-section {
        padding: 0 !important;
        margin-bottom: 32px !important;
      }
      
      /* Categorias em linha no desktop */
      .categories-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
        gap: 16px !important;
        padding: 0 !important;
      }
      
      /* Partituras em grid de 3 colunas */
      .sheets-grid {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 16px !important;
        padding: 0 !important;
      }
      
      .sheets-grid .file-card {
        margin: 0 !important;
      }
    }
    
    /* Telas muito grandes */
    @media (min-width: 1400px) {
      .desktop-main {
        padding: 24px 60px;
      }
    }
    
    /* File card margin no mobile quando não está em grid */
    .file-card {
      margin: 0 20px 12px;
    }
    
    .sheets-grid .file-card {
      margin: 0;
    }
    
    /* Gap no sheets-grid mobile */
    .sheets-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 2px; }

    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Admin Mobile Responsive */
    @media (max-width: 767px) {
      .admin-content-wrapper {
        padding: 16px !important;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, createContext, useContext } = React;

    const AppContext = createContext();
    const useApp = () => useContext(AppContext);

    // Icons
    const Icons = {
      Home: ({ filled }) => filled ? (
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.71 2.29a1 1 0 0 0-1.42 0l-9 9a1 1 0 0 0 0 1.42A1 1 0 0 0 3 13h1v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7h1a1 1 0 0 0 .71-1.71zM12 17a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
      ) : (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
      ),
      Folder: ({ filled }) => filled ? (
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>
      ) : (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      ),
      Search: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      ),
      User: ({ filled }) => filled ? (
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      ) : (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      ),
      Download: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      ),
      Upload: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      ),
      Plus: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      ),
      Back: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15,18 9,12 15,6"/></svg>
      ),
      Close: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      ),
      Check: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20,6 9,17 4,12"/></svg>
      ),
      Bell: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      ),
      Menu: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
      ),
      Moon: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      ),
      Sun: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      ),
      Settings: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      ),
      Monitor: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      ),
      Logout: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      ),
      File: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>
      ),
      Music: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
      ),
      Heart: ({ filled }) => filled ? (
        <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
      ) : (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
      ),
      HeartFilled: () => (
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      ),
      Coreto: ({ filled }) => filled ? (
        <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="0.5">
          <path d="M12 2L3 7v2h18V7L12 2z"/>
          <path d="M5 10v8h2v-8H5zM11 10v8h2v-8h-2zM17 10v8h2v-8h-2z"/>
          <path d="M3 19v2h18v-2H3z"/>
          <circle cx="12" cy="5.5" r="1"/>
        </svg>
      ) : (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M12 2L3 7v2h18V7L12 2z"/>
          <path d="M5 10v8M12 10v8M19 10v8"/>
          <path d="M3 19h18v2H3z"/>
          <circle cx="12" cy="5.5" r="1" fill="currentColor"/>
        </svg>
      ),
      ChevronLeft: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="15,18 9,12 15,6"/>
        </svg>
      ),
      ChevronRight: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="9,6 15,12 9,18"/>
        </svg>
      ),
      ChevronDown: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="6,9 12,15 18,9"/>
        </svg>
      ),
      ChevronUp: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="18,15 12,9 6,15"/>
        </svg>
      ),
      // Ícones de gêneros musicais
      Trumpet: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M3 12h4l2-3h6l2 3h4"/>
          <circle cx="19" cy="12" r="2"/>
          <path d="M7 9v6"/>
          <path d="M9 10v4"/>
          <path d="M11 9v6"/>
        </svg>
      ),
      Drum: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <ellipse cx="12" cy="10" rx="8" ry="4"/>
          <path d="M4 10v6c0 2.2 3.6 4 8 4s8-1.8 8-4v-6"/>
          <path d="M4 14c0 2.2 3.6 4 8 4s8-1.8 8-4"/>
        </svg>
      ),
      Dancers: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="8" cy="5" r="2"/>
          <path d="M8 7v4l-3 5"/>
          <path d="M8 11l3 5"/>
          <path d="M5 9l6 0"/>
          <circle cx="17" cy="6" r="2"/>
          <path d="M17 8v3l2 4"/>
          <path d="M17 11l-2 4"/>
        </svg>
      ),
      Sparkles: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"/>
          <path d="M5 18l1 2 2 1-2 1-1 2-1-2-2-1 2-1 1-2z"/>
          <path d="M19 14l.5 1.5 1.5.5-1.5.5-.5 1.5-.5-1.5-1.5-.5 1.5-.5.5-1.5z"/>
        </svg>
      ),
      Crown: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M2 17l3-8 4 4 3-6 3 6 4-4 3 8H2z"/>
          <path d="M2 17h20v2H2z"/>
        </svg>
      ),
      Rose: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M12 5c-1.5-1.5-4-2-5.5-.5S5.5 9 7 10.5c1.5 1.5 4 2 5 0 1 2 3.5.5 5-1s1-4-.5-5.5S13.5 3.5 12 5z"/>
          <path d="M12 10v10"/>
          <path d="M9 14c-2 0-3 1-3 3"/>
          <path d="M15 14c2 0 3 1 3 3"/>
        </svg>
      ),
      MicrophoneStage: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="6" r="4"/>
          <path d="M12 10v4"/>
          <path d="M8 18h8"/>
          <path d="M10 18v3"/>
          <path d="M14 18v3"/>
          <path d="M8 21h8"/>
        </svg>
      ),
      MusicNotes: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M9 18V5l12-2v13"/>
          <circle cx="6" cy="18" r="3"/>
          <circle cx="18" cy="16" r="3"/>
        </svg>
      ),
      Church: () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M12 3v4"/>
          <path d="M10 5h4"/>
          <path d="M12 7l6 5v9H6v-9l6-5z"/>
          <path d="M10 21v-4h4v4"/>
        </svg>
      )
    };

    // Categories com ícones - 11 gêneros
    const CATEGORIES = [
      { id: 'dobrado', name: 'Dobrados', color: '#722F37', bgColor: '#F5E6E8', icon: 'Trumpet' },
      { id: 'marcha', name: 'Marchas', color: '#8B4513', bgColor: '#F5EDE6', icon: 'Drum' },
      { id: 'marcha-funebre', name: 'Marchas Fúnebres', color: '#4A3728', bgColor: '#EDE8E4', icon: 'Church' },
      { id: 'fantasia', name: 'Fantasias', color: '#B8860B', bgColor: '#F9F3E6', icon: 'Sparkles' },
      { id: 'polaca', name: 'Polacas', color: '#D4AF37', bgColor: '#FBF6E8', icon: 'Crown' },
      { id: 'bolero', name: 'Boleros', color: '#8B2252', bgColor: '#F5E6EC', icon: 'Rose' },
      { id: 'valsa', name: 'Valsas', color: '#6B3A3A', bgColor: '#F2E8E8', icon: 'Dancers' },
      { id: 'arranjo', name: 'Arranjos', color: '#5C4033', bgColor: '#F0EAE6', icon: 'MusicNotes' },
      { id: 'hino', name: 'Hinos', color: '#996515', bgColor: '#F7F0E4', icon: 'Crown' },
      { id: 'hino-religioso', name: 'Hinos Religiosos', color: '#4A2C2A', bgColor: '#EDE6E6', icon: 'Church' },
      { id: 'preludio', name: 'Prelúdios', color: '#7B3F3F', bgColor: '#F3E8E8', icon: 'Sparkles' }
    ];

    // Componente CategoryIcon - renderiza SVG baseado no ID da categoria
    const CategoryIcon = ({ categoryId, size = 24, color = '#fff' }) => {
      const categoryMap = {
        'dobrado': (
          // Trompete militar - símbolo do dobrado brasileiro
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M3 12h3l2-2h4"/>
            <path d="M12 10v4"/>
            <circle cx="12" cy="12" r="6"/>
            <path d="M18 12h3"/>
            <path d="M6 9v6"/>
          </svg>
        ),
        'marcha': (
          // Tambor com baquetas
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <ellipse cx="12" cy="9" rx="7" ry="3"/>
            <path d="M5 9v7c0 1.7 3.1 3 7 3s7-1.3 7-3V9"/>
            <path d="M5 13c0 1.7 3.1 3 7 3s7-1.3 7-3"/>
            <path d="M3 4l4 5M21 4l-4 5"/>
          </svg>
        ),
        'marcha-funebre': (
          // Vela memorial
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M12 2c0 2-2 4-2 6s2 3 2 3 2-1 2-3-2-4-2-6z"/>
            <rect x="10" y="11" width="4" height="10" rx="1"/>
            <path d="M8 21h8"/>
          </svg>
        ),
        'valsa': (
          // Clave de sol elegante
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M12 3c2.5 0 4 1.5 4 3.5 0 3-4 4-4 8"/>
            <circle cx="12" cy="17" r="3"/>
            <path d="M12 14v-3"/>
            <path d="M9 17c0 1.7 1.3 3 3 3"/>
          </svg>
        ),
        'fantasia': (
          // Estrela brilhante
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/>
          </svg>
        ),
        'polaca': (
          // Coroa real (origem polonesa)
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M3 18l2-10 4 4 3-6 3 6 4-4 2 10H3z"/>
            <circle cx="5" cy="6" r="1.5"/>
            <circle cx="12" cy="4" r="1.5"/>
            <circle cx="19" cy="6" r="1.5"/>
            <path d="M3 18h18v2H3z"/>
          </svg>
        ),
        'bolero': (
          // Rosa elegante
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="10" r="4"/>
            <path d="M12 6c-2-2-4-1-4 1s2 3 4 3 4-1 4-3-2-3-4-1"/>
            <path d="M12 14v7"/>
            <path d="M9 18c-1.5 0-2.5.5-2.5 1.5"/>
            <path d="M15 18c1.5 0 2.5.5 2.5 1.5"/>
          </svg>
        ),
        'hino': (
          // Bandeira
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M4 4v17"/>
            <path d="M4 4h12c2 0 3 1 3 2s-1 2-3 2H8c-2 0-3 1-3 2s1 2 3 2h11"/>
            <circle cx="4" cy="4" r="1.5" fill={color}/>
          </svg>
        ),
        'hino-religioso': (
          // Cruz estilizada
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M12 3v18"/>
            <path d="M7 8h10"/>
            <circle cx="12" cy="8" r="5"/>
          </svg>
        ),
        'arranjo': (
          // Partitura com notas
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M7 8h10M7 12h10M7 16h6"/>
            <circle cx="17" cy="16" r="2" fill={color}/>
          </svg>
        ),
        'preludio': (
          // Clave de sol simplificada
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M9 18c0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3"/>
            <path d="M12 15V6c0-2 2-3 3-3"/>
            <path d="M12 10c2-1 3-3 3-5"/>
          </svg>
        )
      };

      // Fallback para nota musical elegante
      const defaultIcon = (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="8" cy="18" r="3"/>
          <circle cx="18" cy="16" r="3"/>
          <path d="M11 18V6l10-2v12"/>
        </svg>
      );

      return categoryMap[categoryId] || defaultIcon;
    };

    // Sample Data - Compositores do Recôncavo Baiano e Feira de Santana
    const generateSampleData = () => [
      // Dobrados
      { id: '1', title: 'Verde e Branco', composer: 'Estevam Moura', category: 'dobrado', year: 1940, downloads: 567, featured: true },
      { id: '2', title: 'Magnata', composer: 'Estevam Moura', category: 'dobrado', year: 1945, downloads: 489, featured: true },
      { id: '3', title: 'Tusca', composer: 'Estevam Moura', category: 'dobrado', year: 1942, downloads: 423, featured: false },
      { id: '4', title: 'Dois Corações', composer: 'Pedro Salgado', category: 'dobrado', year: 1935, downloads: 512, featured: true },
      { id: '5', title: 'Os Corujas', composer: 'Heráclio Guerreiro', category: 'dobrado', year: 1920, downloads: 298, featured: true },
      { id: '6', title: 'Coronel Pedra', composer: 'João Alves Souza', category: 'dobrado', year: 1934, downloads: 234, featured: false },
      
      // Marchas
      { id: '7', title: 'A Airosa Passeiata', composer: 'Tranquilino Bastos', category: 'marcha', year: 1888, downloads: 445, featured: true },
      { id: '8', title: 'Marcha Triunfal', composer: 'Tertuliano Santos', category: 'marcha', year: 1948, downloads: 267, featured: false },
      { id: '9', title: 'Marcha Nº 5', composer: 'Estevam Moura', category: 'marcha', year: 1934, downloads: 312, featured: false },
      
      // Marchas Fúnebres
      { id: '10', title: 'Saudade Eterna', composer: 'Amando Nobre', category: 'marcha-funebre', year: 1955, downloads: 189, featured: false },
      { id: '11', title: 'Lágrimas do Recôncavo', composer: 'Waldemar da Paixão', category: 'marcha-funebre', year: 1960, downloads: 156, featured: false },
      
      // Fantasias
      { id: '12', title: 'Ave Libertas', composer: 'Waldemar da Paixão', category: 'fantasia', year: 1958, downloads: 378, featured: true },
      { id: '13', title: 'Fantasia Sertaneja', composer: 'Estevam Moura', category: 'fantasia', year: 1942, downloads: 234, featured: false },
      
      // Polacas
      { id: '14', title: 'Polaca Sertaneja', composer: 'Estevam Moura', category: 'polaca', year: 1938, downloads: 267, featured: true },
      { id: '15', title: 'Polaca Brasileira', composer: 'Tertuliano Santos', category: 'polaca', year: 1952, downloads: 198, featured: false },
      
      // Boleros
      { id: '16', title: 'Noites do Recôncavo', composer: 'Amando Nobre', category: 'bolero', year: 1962, downloads: 345, featured: true },
      { id: '17', title: 'Amor de Filarmônica', composer: 'Antonio França', category: 'bolero', year: 1958, downloads: 289, featured: false },
      
      // Valsas
      { id: '18', title: 'Valsa Feirense', composer: 'Estevam Moura', category: 'valsa', year: 1944, downloads: 312, featured: true },
      { id: '19', title: 'Valsa do Paraguaçu', composer: 'Heráclio Guerreiro', category: 'valsa', year: 1928, downloads: 234, featured: false },
      { id: '20', title: 'Valsa Primaveril', composer: 'Tertuliano Santos', category: 'valsa', year: 1950, downloads: 198, featured: false },
      
      // Arranjos
      { id: '21', title: 'Asa Branca', composer: 'Tertuliano Santos', category: 'arranjo', year: 1955, downloads: 534, featured: true },
      { id: '22', title: 'Aquarela do Brasil', composer: 'Amando Nobre', category: 'arranjo', year: 1960, downloads: 445, featured: false },
      
      // Hinos
      { id: '23', title: 'Hino à Feira', composer: 'Georgina Erismann', category: 'hino', year: 1950, downloads: 623, featured: true },
      { id: '24', title: 'Hino ao 2 de Julho', composer: 'Tranquilino Bastos', category: 'hino', year: 1895, downloads: 489, featured: false },
      
      // Hinos Religiosos
      { id: '25', title: 'Ária das Adeptas', composer: 'João Mariano Sobral', category: 'hino-religioso', year: 1905, downloads: 312, featured: false },
      { id: '26', title: 'Ave Maria Sertaneja', composer: 'Antenor Bastos', category: 'hino-religioso', year: 1948, downloads: 267, featured: false },
      
      // Prelúdios
      { id: '27', title: 'Prelúdio do Sertão', composer: 'Waldemar da Paixão', category: 'preludio', year: 1965, downloads: 198, featured: false },
      { id: '28', title: 'Aurora Baiana', composer: 'Amando Nobre', category: 'preludio', year: 1958, downloads: 178, featured: false }
    ];

    // ============ API CONFIGURATION ============
    const API_BASE_URL = 'https://acervo-filarmonica-api.acssjr.workers.dev';
    
    // API Service - Conecta com o backend real
    const API = {
      // Helper para fazer requisições
      async request(endpoint, options = {}) {
        try {
          const token = Storage.get('authToken', null);
          const headers = {
            'Content-Type': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` }),
            ...options.headers
          };
          
          const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            headers
          });
          
          if (!response.ok) {
            const error = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
            throw new Error(error.error || `HTTP ${response.status}`);
          }
          
          return await response.json();
        } catch (error) {
          console.error(`API Error [${endpoint}]:`, error);
          throw error;
        }
      },
      
      // Partituras
      async getPartituras(filters = {}) {
        const params = new URLSearchParams();
        if (filters.categoria) params.append('categoria', filters.categoria);
        if (filters.busca) params.append('busca', filters.busca);
        if (filters.destaque) params.append('destaque', '1');
        
        const query = params.toString();
        return this.request(`/api/partituras${query ? `?${query}` : ''}`);
      },
      
      async getPartitura(id) {
        return this.request(`/api/partituras/${id}`);
      },
      
      async createPartitura(formData) {
        const token = Storage.get('authToken', null);
        const response = await fetch(`${API_BASE_URL}/api/partituras`, {
          method: 'POST',
          headers: {
            ...(token && { 'Authorization': `Bearer ${token}` })
          },
          body: formData
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Erro no upload' }));
          throw new Error(error.error);
        }
        
        return response.json();
      },
      
      async updatePartitura(id, data) {
        return this.request(`/api/partituras/${id}`, {
          method: 'PUT',
          body: JSON.stringify(data)
        });
      },
      
      async deletePartitura(id) {
        return this.request(`/api/partituras/${id}`, {
          method: 'DELETE'
        });
      },
      
      // Download
      getDownloadUrl(id, instrumento = null) {
        let url = `${API_BASE_URL}/api/download/${id}`;
        if (instrumento) url += `?instrumento=${instrumento}`;
        return url;
      },
      
      // Categorias e Instrumentos
      async getCategorias() {
        return this.request('/api/categorias');
      },
      
      async getInstrumentos() {
        return this.request('/api/instrumentos');
      },
      
      // Estatísticas
      async getEstatisticas() {
        return this.request('/api/estatisticas');
      },
      
      // Atividades
      async getAtividades() {
        return this.request('/api/atividades');
      },
      
      async getMinhasAtividades() {
        return this.request('/api/minhas-atividades');
      },
      
      // Auth
      async login(username, pin) {
        const result = await this.request('/api/login', {
          method: 'POST',
          body: JSON.stringify({ username, pin })
        });
        
        if (result.token) {
          Storage.set('authToken', result.token);
        }
        
        return result;
      },
      
      async changePin(currentPin, newPin) {
        try {
          const result = await this.request('/api/change-pin', {
            method: 'POST',
            body: JSON.stringify({ currentPin, newPin })
          });
          return result;
        } catch (error) {
          return { success: false, error: error.message };
        }
      },
      
      logout() {
        Storage.remove('authToken');
      },
      
      // Health check
      async healthCheck() {
        try {
          const result = await this.request('/api/health');
          return result.status === 'ok';
        } catch {
          return false;
        }
      },
      
      // ============ PERFIL ============
      
      async getPerfil() {
        return this.request('/api/perfil');
      },
      
      async updatePerfil(data) {
        return this.request('/api/perfil', {
          method: 'PUT',
          body: JSON.stringify(data)
        });
      },
      
      async uploadFotoPerfil(file) {
        const token = Storage.get('authToken', null);
        const formData = new FormData();
        formData.append('foto', file);
        
        const response = await fetch(`${API_BASE_URL}/api/perfil/foto`, {
          method: 'POST',
          headers: {
            ...(token && { 'Authorization': `Bearer ${token}` })
          },
          body: formData
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Erro no upload' }));
          throw new Error(error.error);
        }
        
        return response.json();
      },
      
      // ============ FAVORITOS ============
      
      async getFavoritos() {
        return this.request('/api/favoritos');
      },
      
      async getFavoritosIds() {
        return this.request('/api/favoritos/ids');
      },
      
      async addFavorito(partituraId) {
        return this.request(`/api/favoritos/${partituraId}`, {
          method: 'POST'
        });
      },
      
      async removeFavorito(partituraId) {
        return this.request(`/api/favoritos/${partituraId}`, {
          method: 'DELETE'
        });
      },
      
      // ============ USUÁRIOS (ADMIN) ============
      
      async getUsuarios() {
        return this.request('/api/usuarios');
      },
      
      async getUsuario(id) {
        return this.request(`/api/usuarios/${id}`);
      },
      
      async createUsuario(data) {
        return this.request('/api/usuarios', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      },
      
      async updateUsuario(id, data) {
        return this.request(`/api/usuarios/${id}`, {
          method: 'PUT',
          body: JSON.stringify(data)
        });
      },
      
      async deleteUsuario(id) {
        return this.request(`/api/usuarios/${id}`, {
          method: 'DELETE'
        });
      },
      
      // ============ CATEGORIAS (ADMIN) ============
      
      async createCategoria(data) {
        return this.request('/api/categorias', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      },
      
      async updateCategoria(id, data) {
        return this.request(`/api/categorias/${id}`, {
          method: 'PUT',
          body: JSON.stringify(data)
        });
      },
      
      async deleteCategoria(id) {
        return this.request(`/api/categorias/${id}`, {
          method: 'DELETE'
        });
      },
      
      async reorderCategorias(ordens) {
        return this.request('/api/categorias/reorder', {
          method: 'POST',
          body: JSON.stringify({ ordens })
        });
      },
      
      // ============ ESTATÍSTICAS ADMIN ============
      
      async getEstatisticasAdmin() {
        return this.request('/api/admin/estatisticas');
      }
    };
    
    // Flag para usar API ou dados locais (fallback)
    const USE_API = true; // Mude para false para usar dados locais

    // Storage
    const Storage = {
      get: (key, def) => { try { const i = localStorage.getItem(`fil_${key}`); return i ? JSON.parse(i) : def; } catch { return def; } },
      set: (key, val) => { try { localStorage.setItem(`fil_${key}`, JSON.stringify(val)); } catch {} },
      clear: (key) => { try { localStorage.removeItem(`fil_${key}`); } catch {} },
      remove: (key) => { try { localStorage.removeItem(`fil_${key}`); } catch {} }
    };
    
    // Versão dos dados - incrementar quando mudar estrutura
    const DATA_VERSION = 7;
    const storedVersion = Storage.get('version', 0);
    if (storedVersion < DATA_VERSION) {
      Storage.clear('sheets');
      Storage.clear('user');
      Storage.set('version', DATA_VERSION);
    }

    // Fuzzy Search - Levenshtein Distance
    const levenshteinDistance = (str1, str2) => {
      const s1 = str1.toLowerCase();
      const s2 = str2.toLowerCase();
      const costs = [];
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) costs[j] = j;
          else if (j > 0) {
            let newValue = costs[j - 1];
            if (s1.charAt(i - 1) !== s2.charAt(j - 1))
              newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
            costs[j - 1] = lastValue;
            lastValue = newValue;
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return costs[s2.length];
    };

    const findSimilar = (query, items, threshold = 3) => {
      const q = query.toLowerCase().trim();
      if (q.length < 2) return null;
      
      let bestMatch = null;
      let bestDistance = Infinity;
      
      items.forEach(item => {
        // Check title
        const titleDist = levenshteinDistance(q, item.title);
        const titleWords = item.title.toLowerCase().split(' ');
        const wordDistances = titleWords.map(word => levenshteinDistance(q, word));
        const minWordDist = Math.min(...wordDistances);
        
        const minDist = Math.min(titleDist, minWordDist);
        
        if (minDist < bestDistance && minDist <= threshold && minDist > 0) {
          bestDistance = minDist;
          bestMatch = item.title;
        }
        
        // Check composer
        const composerDist = levenshteinDistance(q, item.composer);
        if (composerDist < bestDistance && composerDist <= threshold && composerDist > 0) {
          bestDistance = composerDist;
          bestMatch = item.composer;
        }
      });
      
      return bestMatch;
    };

    // Global Styles
    const GlobalStyles = () => (
      <style>{`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUpModal { 
          from { opacity: 0; transform: translateY(100%); } 
          to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes slideDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100px); opacity: 0; } }
        @keyframes slideUpNav { from { transform: translateX(-50%) translateY(100px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes popIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        @keyframes scaleIn { 
          from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } 
          to { opacity: 1; transform: translate(-50%, -50%) scale(1); } 
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.6; transform: scale(1.2); }
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        @keyframes scaleInLogin {
          from { opacity: 0; transform: scale(0.95) translateY(10px); }
          to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
          20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        @keyframes marqueeScroll { 
          0% { transform: translateX(0); } 
          100% { transform: translateX(-50%); } 
        }
        
        /* Transição suave entre telas */
        @keyframes screenFadeIn {
          from { opacity: 0; transform: translateY(8px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .screen-container {
          animation: screenFadeIn 0.3s ease-out;
        }
        
        .card-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .card-hover:active { transform: scale(0.98); }
        .btn-hover { transition: all 0.2s ease; }
        .btn-hover:hover { opacity: 0.9; }
        .btn-hover:active { transform: scale(0.96); }
        .modal-btn { 
          transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease; 
        }
        .modal-btn:hover { 
          opacity: 0.9;
          box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        .modal-btn:active { 
          transform: scale(0.97); 
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .instrument-item {
          transition: background 0.15s ease;
        }
        .instrument-item:hover {
          background: var(--bg-card) !important;
        }
        .instrument-item:active {
          background: var(--border) !important;
        }
        .animate-in { animation: slideUp 0.4s ease backwards; }
        .stagger-1 { animation-delay: 0.03s; }
        .stagger-2 { animation-delay: 0.06s; }
        .stagger-3 { animation-delay: 0.09s; }
        .stagger-4 { animation-delay: 0.12s; }
        .stagger-5 { animation-delay: 0.15s; }
        .stagger-6 { animation-delay: 0.18s; }
        .stagger-7 { animation-delay: 0.21s; }
        .stagger-8 { animation-delay: 0.24s; }
        input:focus, select:focus { outline: none; border-color: var(--primary) !important; }
        
        /* ===== BARRA DE PESQUISA PROFISSIONAL ===== */
        .search-bar {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 16px;
          background: var(--bg-card);
          border: 1.5px solid var(--border);
          border-radius: 12px;
          transition: all 0.2s ease;
          box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .search-bar:hover {
          border-color: var(--text-muted);
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .search-bar:focus-within {
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15), 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-bar input {
          flex: 1;
          background: transparent;
          border: none;
          outline: none;
          color: var(--text-primary);
          font-family: 'Outfit', sans-serif;
          font-size: 15px;
          font-weight: 400;
        }
        .search-bar input::placeholder {
          color: var(--text-muted);
          opacity: 0.8;
        }
        .search-bar .search-icon {
          color: var(--text-muted);
          flex-shrink: 0;
          transition: color 0.2s ease;
        }
        .search-bar:focus-within .search-icon {
          color: var(--primary);
        }
        .search-bar .clear-btn {
          background: var(--bg-secondary);
          border: none;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: var(--text-muted);
          transition: all 0.15s ease;
          padding: 0;
        }
        .search-bar .clear-btn:hover {
          background: var(--border);
          color: var(--text-primary);
        }
        
        /* Tema claro - ajustes específicos para legibilidade */
        [data-theme="light"] .search-bar {
          background: #ffffff;
          border-color: #e0e0e0;
          box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        [data-theme="light"] .search-bar:hover {
          border-color: #c0c0c0;
          box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        [data-theme="light"] .search-bar:focus-within {
          border-color: #B8960C;
          box-shadow: 0 0 0 3px rgba(184, 150, 12, 0.15), 0 2px 8px rgba(0,0,0,0.1);
        }
        [data-theme="light"] .search-bar input::placeholder {
          color: #888888;
          opacity: 1;
        }
        [data-theme="light"] .search-bar .search-icon {
          color: #666666;
        }
        [data-theme="light"] .search-bar:focus-within .search-icon {
          color: #B8960C;
        }
        
        /* Placeholder do login */
        input::placeholder {
          color: rgba(244, 228, 188, 0.4);
        }
        
        .progress-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: var(--border); }
        .progress-segment { height: 100%; transition: width 0.5s ease; }
        
        /* Shimmer animation for featured cards */
        @keyframes shimmer {
          0% { left: -100%; }
          50%, 100% { left: 100%; }
        }
        
        /* Animação da borda dourada - só pulse de brilho, sem mover */
        @keyframes borderGlow {
          0%, 100% { 
            filter: brightness(1);
            opacity: 0.85;
          }
          50% { 
            filter: brightness(1.3);
            opacity: 1;
          }
        }
        
        .featured-card {
          position: relative;
          overflow: hidden;
          transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        
        .featured-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 12px 28px rgba(0,0,0,0.35);
        }
        
        .featured-card:active {
          transform: scale(0.97);
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Mobile: apenas active, sem hover */
        @media (max-width: 1023px) {
          .featured-card:hover {
            transform: none;
            box-shadow: none;
          }
          .featured-card:active {
            transform: scale(0.97);
          }
        }
        
        .featured-scroll::-webkit-scrollbar {
          display: none;
        }
        
        .featured-scroll {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
        
        /* Desktop responsive */
        @media (min-width: 768px) {
          .categories-grid {
            grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
          }
          .files-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0 20px;
          }
          .files-grid > div {
            margin-left: 0 !important;
            margin-right: 0 !important;
          }
        }
        
        @media (min-width: 1024px) {
          .categories-grid {
            grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
            gap: 16px !important;
          }
          .files-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
          }
        }
      `}</style>
    );

    // Toast
    const Toast = ({ message, type = 'success', onClose }) => {
      // Download fica mais tempo na tela
      const isDownload = message.toLowerCase().includes('download') || message.toLowerCase().includes('preparando');
      const duration = isDownload ? 4000 : 3000;
      
      useEffect(() => { const t = setTimeout(onClose, duration); return () => clearTimeout(t); }, [onClose, duration]);
      
      // Ícone de download
      const DownloadIcon = () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      );
      
      return (
        <div style={{
          position: 'fixed', bottom: '100px', left: '20px', right: '20px', maxWidth: '390px', margin: '0 auto',
          background: type === 'success' ? (isDownload ? 'linear-gradient(145deg, #2D8A5F 0%, #236B4A 100%)' : '#2D8A5F') : '#D64545', 
          color: '#fff', borderRadius: 'var(--radius-md)',
          padding: isDownload ? '16px 20px' : '14px 18px', 
          display: 'flex', alignItems: 'center', gap: '12px', 
          boxShadow: isDownload ? '0 8px 32px rgba(45, 138, 95, 0.4)' : 'var(--shadow-lg)',
          zIndex: 3000, animation: 'slideUp 0.3s ease',
          border: isDownload ? '1px solid rgba(255,255,255,0.2)' : 'none'
        }}>
          <div style={{ width: '24px', height: '24px', flexShrink: 0 }}>
            {isDownload ? <DownloadIcon /> : (type === 'success' ? <Icons.Check /> : <Icons.Close />)}
          </div>
          <div style={{ flex: 1 }}>
            <span style={{ fontSize: isDownload ? '15px' : '14px', fontWeight: '600', display: 'block' }}>{message}</span>
            {isDownload && (
              <span style={{ fontSize: '12px', opacity: 0.85, marginTop: '2px', display: 'block' }}>
                Verifique a barra de notificações
              </span>
            )}
          </div>
        </div>
      );
    };

    // Função utilitária para calcular próximo ensaio
    // Ensaios: Segunda e Quarta, 19h-21h
    const getNextRehearsal = () => {
      const now = new Date();
      const currentDay = now.getDay(); // 0=dom, 1=seg, 2=ter, 3=qua, 4=qui, 5=sex, 6=sab
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      
      // Dias de ensaio: 1 (segunda) e 3 (quarta)
      const rehearsalDays = [1, 3];
      const rehearsalHour = 19;
      const rehearsalEndHour = 21;
      
      // Verifica se está em ensaio agora
      const isRehearsalDay = rehearsalDays.includes(currentDay);
      const isDuringRehearsal = isRehearsalDay && currentHour >= rehearsalHour && currentHour < rehearsalEndHour;
      
      if (isDuringRehearsal) {
        const minutesLeft = (rehearsalEndHour - currentHour - 1) * 60 + (60 - currentMinute);
        return { isNow: true, minutesLeft };
      }
      
      // Encontra próximo dia de ensaio
      let daysUntil = 0;
      let nextDay = currentDay;
      
      // Se hoje é dia de ensaio mas já passou das 19h, vai para o próximo
      if (isRehearsalDay && currentHour >= rehearsalHour) {
        nextDay = (currentDay + 1) % 7;
        daysUntil = 1;
      }
      
      // Encontra o próximo dia de ensaio
      while (!rehearsalDays.includes(nextDay)) {
        nextDay = (nextDay + 1) % 7;
        daysUntil++;
      }
      
      // Calcula tempo restante
      const nextRehearsal = new Date(now);
      nextRehearsal.setDate(now.getDate() + daysUntil);
      nextRehearsal.setHours(rehearsalHour, 0, 0, 0);
      
      const diff = nextRehearsal - now;
      const totalMinutes = Math.floor(diff / (1000 * 60));
      const days = Math.floor(totalMinutes / (60 * 24));
      const hours = Math.floor((totalMinutes % (60 * 24)) / 60);
      const minutes = totalMinutes % 60;
      
      const dayName = nextDay === 1 ? 'segunda' : 'quarta';
      
      return { isNow: false, days, hours, minutes, dayName };
    };

    // Header
    const Header = ({ title, subtitle, showBack, onBack, actions }) => (
      <header style={{
        padding: '16px 20px', paddingTop: 'max(env(safe-area-inset-top), 16px)',
        display: 'flex', justifyContent: 'space-between', alignItems: 'center'
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
          {showBack && (
            <button className="btn-hover" style={{
              width: '40px', height: '40px', borderRadius: 'var(--radius-sm)', background: 'var(--bg-card)',
              border: '1px solid var(--border)', color: 'var(--text-primary)', display: 'flex',
              alignItems: 'center', justifyContent: 'center', cursor: 'pointer'
            }} onClick={onBack}>
              <div style={{ width: '20px', height: '20px' }}><Icons.Back /></div>
            </button>
          )}
          <div>
            <h1 style={{
              fontFamily: "Outfit, sans-serif", fontSize: subtitle ? '28px' : '26px',
              fontWeight: '700', letterSpacing: '-0.5px', color: 'var(--text-primary)'
            }}>{title}</h1>
            {subtitle && <p style={{ fontSize: '14px', color: 'var(--text-muted)', marginTop: '2px' }}>{subtitle}</p>}
          </div>
        </div>
        {actions && <div style={{ display: 'flex', gap: '10px' }}>{actions}</div>}
      </header>
    );

    // Home Header - Header especial para tela inicial com nome e instrumento
    const HomeHeader = ({ userName, instrument, actions }) => {
      const { theme } = useApp();
      const isDark = theme === 'dark';
      const [isDesktop, setIsDesktop] = React.useState(window.innerWidth >= 1024);
      
      React.useEffect(() => {
        const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      return (
        <>
          {/* Header institucional - apenas mobile */}
          {!isDesktop && (
            <div style={{ 
              background: 'linear-gradient(135deg, #722F37 0%, #5C1A1B 100%)',
              padding: '14px 20px 18px',
              paddingTop: 'max(env(safe-area-inset-top), 14px)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                {/* Logo circular */}
                <div style={{ 
                  width: '38px',
                  height: '38px',
                  borderRadius: '50%',
                  background: 'rgba(244, 228, 188, 0.15)',
                  border: '2px solid rgba(244, 228, 188, 0.3)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0,
                  overflow: 'hidden',
                  padding: '4px'
                }}>
                  <img 
                    src="/assets/images/ui/brasao-256x256.png" 
                    alt="Brasão"
                    style={{
                      width: '100%',
                      height: '100%',
                      objectFit: 'contain'
                    }}
                  />
                </div>
                <div>
                  <h2 style={{ 
                    fontFamily: 'Outfit, sans-serif', 
                    fontSize: '14px', 
                    fontWeight: '700',
                    color: '#F4E4BC',
                    marginBottom: '1px',
                    lineHeight: '1.2'
                  }}>
                    S.F. 25 de Março
                  </h2>
                  <p style={{ 
                    fontFamily: 'Outfit, sans-serif', 
                    fontSize: '9px', 
                    fontWeight: '600',
                    color: '#D4AF37',
                    letterSpacing: '1px',
                    textTransform: 'uppercase'
                  }}>Acervo Digital</p>
                </div>
              </div>
              
              {/* Actions no header institucional */}
              <HeaderActions inDarkHeader={true} />
            </div>
          )}
          
          {/* Header de saudação */}
          <header style={{
            padding: isDesktop ? '20px 20px 24px' : '16px 20px 20px',
            paddingTop: isDesktop ? 'max(env(safe-area-inset-top), 20px)' : '16px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'flex-start',
            marginBottom: '8px',
            borderBottom: '1px solid var(--border)',
            background: isDark 
              ? 'linear-gradient(180deg, rgba(212,175,55,0.06) 0%, transparent 100%)'
              : 'linear-gradient(180deg, rgba(114,47,55,0.04) 0%, transparent 100%)'
          }}>
            <div style={{ flex: 1 }}>
              {/* Saudação pequena */}
              <p style={{
                fontFamily: 'Outfit, sans-serif',
                fontSize: '14px',
                color: isDark ? 'rgba(255,255,255,0.7)' : 'rgba(26,26,26,0.6)',
                marginBottom: '2px'
              }}>
                Olá,
              </p>
              
              {/* Nome + Badge na mesma linha */}
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '12px',
                flexWrap: 'wrap'
              }}>
                {/* Nome com destaque */}
                <h1 style={{
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '28px',
                  fontWeight: '800',
                  letterSpacing: '-0.5px',
                  position: 'relative',
                  display: 'inline-flex',
                  alignItems: 'center',
                  color: isDark ? '#FFFFFF' : '#1a1a1a',
                  margin: 0
                }}>
                  {userName}
                  {/* Brilho sutil */}
                  <span style={{
                    marginLeft: '4px',
                    fontSize: '16px'
                  }}>✨</span>
                </h1>
                
                {/* Instrumento como badge */}
                <div style={{
                  background: '#D4AF37',
                  color: '#3D1518',
                  fontSize: '10px',
                  fontFamily: 'Outfit, sans-serif',
                  fontWeight: '700',
                  padding: '5px 10px',
                  borderRadius: '8px',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  whiteSpace: 'nowrap'
                }}>
                  {instrument}
                </div>
              </div>
              
              {/* Contador do próximo ensaio - apenas mobile */}
              {!isDesktop && (() => {
                const rehearsalInfo = getNextRehearsal();
                return rehearsalInfo.isNow ? (
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    marginTop: '12px'
                  }}>
                    <div style={{
                      width: '10px',
                      height: '10px',
                      borderRadius: '50%',
                      background: '#22C55E',
                      animation: 'pulse 2s ease-in-out infinite'
                    }} />
                    <span style={{
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '14px',
                      fontWeight: '700',
                      color: '#22C55E'
                    }}>
                      Ensaio acontecendo agora!
                    </span>
                  </div>
                ) : (
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    marginTop: '12px'
                  }}>
                    <span style={{
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '13px',
                      fontWeight: '700',
                      color: 'var(--text-muted)'
                    }}>
                      Próximo ensaio:
                    </span>
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      background: 'rgba(212, 175, 55, 0.15)',
                      padding: '4px 10px',
                      borderRadius: '8px'
                    }}>
                      {rehearsalInfo.days > 0 && (
                        <span style={{
                          fontFamily: 'Outfit, sans-serif',
                          fontSize: '14px',
                          fontWeight: '800',
                          color: '#D4AF37'
                        }}>
                          {rehearsalInfo.days}d
                        </span>
                      )}
                      <span style={{
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '14px',
                        fontWeight: '800',
                        color: '#D4AF37'
                      }}>
                        {rehearsalInfo.hours}h{rehearsalInfo.minutes > 0 ? ` ${rehearsalInfo.minutes}m` : ''}
                      </span>
                      <span style={{
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '12px',
                        color: 'var(--text-muted)',
                        fontWeight: '500'
                      }}>
                        ({rehearsalInfo.dayName})
                      </span>
                    </div>
                  </div>
                );
              })()}
            </div>
            
            {/* Actions no desktop */}
            {isDesktop && actions && <div style={{ display: 'flex', gap: '10px' }}>{actions}</div>}
          </header>
        </>
      );
    };

    // Icon Button
    const IconButton = ({ icon: Icon, onClick, primary, style }) => (
      <button className="btn-hover" style={{
        width: '44px', height: '44px', borderRadius: 'var(--radius-sm)',
        background: primary ? 'var(--primary)' : 'var(--bg-card)',
        border: primary ? 'none' : '1px solid var(--border)',
        color: primary ? '#fff' : 'var(--text-primary)',
        display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', ...style
      }} onClick={onClick}>
        <div style={{ width: '20px', height: '20px' }}><Icon /></div>
      </button>
    );

    // Theme Selector - Seletor de tema com 3 opções
    const ThemeSelector = ({ inDarkHeader = false, compact = false, inline = false }) => {
      const { theme, themeMode, setThemeMode } = useApp();
      const [isOpen, setIsOpen] = useState(false);
      const selectorRef = React.useRef(null);
      const isMobile = window.innerWidth < 768;
      
      const options = [
        { id: 'light', label: 'Claro', icon: Icons.Sun },
        { id: 'dark', label: 'Escuro', icon: Icons.Moon },
        { id: 'system', label: 'Sistema', icon: Icons.Monitor }
      ];
      
      // Função para ciclar entre temas
      const cycleTheme = () => {
        const order = ['light', 'dark', 'system'];
        const currentIndex = order.indexOf(themeMode);
        const nextIndex = (currentIndex + 1) % order.length;
        setThemeMode(order[nextIndex]);
      };
      
      // Versão inline (3 botões lado a lado) para header desktop
      if (inline) {
        return (
          <div style={{
            display: 'flex',
            gap: '4px',
            background: 'var(--bg-secondary)',
            borderRadius: '10px',
            padding: '4px',
            border: '1px solid var(--border)'
          }}>
            {options.map((option) => {
              const Icon = option.icon;
              const isActive = themeMode === option.id;
              
              return (
                <button
                  key={option.id}
                  onClick={() => setThemeMode(option.id)}
                  title={option.label}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '8px',
                    background: isActive ? 'var(--primary)' : 'transparent',
                    border: 'none',
                    borderRadius: '8px',
                    color: isActive ? '#fff' : 'var(--text-muted)',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                >
                  <div style={{ width: '16px', height: '16px' }}>
                    <Icon />
                  </div>
                </button>
              );
            })}
          </div>
        );
      }
      
      // Fecha ao clicar fora
      React.useEffect(() => {
        const handleClickOutside = (e) => {
          if (selectorRef.current && !selectorRef.current.contains(e.target)) {
            setIsOpen(false);
          }
        };
        if (isOpen) {
          document.addEventListener('mousedown', handleClickOutside);
          document.addEventListener('touchstart', handleClickOutside);
        }
        return () => {
          document.removeEventListener('mousedown', handleClickOutside);
          document.removeEventListener('touchstart', handleClickOutside);
        };
      }, [isOpen]);
      
      const currentOption = options.find(o => o.id === themeMode);
      const CurrentIcon = currentOption?.icon || Icons.Sun;
      
      // Estilos para o header vinho (institucional)
      const darkHeaderStyles = {
        background: 'rgba(255,255,255,0.15)',
        border: '1px solid rgba(255,255,255,0.2)',
        color: '#F4E4BC'
      };
      
      // Estilos normais
      const normalStyles = {
        background: 'var(--bg-card)',
        border: '1px solid var(--border)',
        color: 'var(--text-primary)'
      };
      
      const buttonStyles = inDarkHeader ? darkHeaderStyles : normalStyles;
      
      // No mobile, clique direto muda o tema (cicla)
      const handleClick = () => {
        if (isMobile) {
          cycleTheme();
        } else {
          setIsOpen(!isOpen);
        }
      };
      
      return (
        <div ref={selectorRef} style={{ position: 'relative' }}>
          {/* Botão de toggle */}
          <button 
            className="btn-hover"
            onClick={handleClick}
            style={{
              width: compact ? '36px' : '40px', 
              height: compact ? '36px' : '40px', 
              borderRadius: '10px',
              ...buttonStyles,
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center', 
              cursor: 'pointer',
              transition: 'all 0.2s ease'
            }}
          >
            <div style={{ width: '18px', height: '18px' }}>
              <CurrentIcon />
            </div>
          </button>
          
          {/* Dropdown de opções */}
          {isOpen && (
            <div style={{
              position: 'absolute',
              top: 'calc(100% + 8px)',
              right: 0,
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '12px',
              padding: '6px',
              boxShadow: '0 10px 40px rgba(0,0,0,0.2)',
              zIndex: 1000,
              minWidth: '140px',
              animation: 'fadeIn 0.15s ease'
            }}>
              {options.map((option) => {
                const Icon = option.icon;
                const isActive = themeMode === option.id;
                
                return (
                  <button
                    key={option.id}
                    onClick={() => {
                      setThemeMode(option.id);
                      setIsOpen(false);
                    }}
                    style={{
                      width: '100%',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px',
                      padding: '10px 12px',
                      background: isActive ? 'var(--primary)' : 'transparent',
                      border: 'none',
                      borderRadius: '8px',
                      color: isActive ? '#fff' : 'var(--text-primary)',
                      cursor: 'pointer',
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '13px',
                      fontWeight: isActive ? '600' : '500',
                      transition: 'all 0.15s ease'
                    }}
                  >
                    <div style={{ width: '16px', height: '16px', opacity: isActive ? 1 : 0.7 }}>
                      <Icon />
                    </div>
                    <span>{option.label}</span>
                    {isActive && (
                      <div style={{ marginLeft: 'auto', width: '14px', height: '14px' }}>
                        <Icons.Check />
                      </div>
                    )}
                  </button>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // Header Actions - Tema + Notificações (apenas mobile)
    const HeaderActions = ({ inDarkHeader = false }) => {
      const { setShowNotifications, unreadCount } = useApp();
      const [isDesktop, setIsDesktop] = React.useState(window.innerWidth >= 1024);
      
      React.useEffect(() => {
        const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      // No desktop, não mostra nada (já está na sidebar)
      if (isDesktop) return null;
      
      // Estilos para o header vinho (institucional)
      const darkHeaderStyles = {
        background: 'rgba(255,255,255,0.15)',
        border: '1px solid rgba(255,255,255,0.2)',
        color: '#F4E4BC'
      };
      
      // Estilos normais
      const normalStyles = {
        background: 'var(--bg-card)',
        border: '1px solid var(--border)',
        color: 'var(--text-primary)'
      };
      
      const buttonStyles = inDarkHeader ? darkHeaderStyles : normalStyles;
      
      return (
        <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
          {/* Seletor de tema */}
          <ThemeSelector inDarkHeader={inDarkHeader} compact />
          
          {/* Sininho de notificações */}
          <button 
            className="btn-hover"
            onClick={() => setShowNotifications(true)}
            style={{
              width: '36px', 
              height: '36px', 
              borderRadius: '10px',
              ...buttonStyles,
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center', 
              cursor: 'pointer',
              position: 'relative'
            }}
          >
            <div style={{ width: '18px', height: '18px' }}>
              <Icons.Bell />
            </div>
            
            {/* Badge de contagem */}
            {unreadCount > 0 && (
              <div style={{
                position: 'absolute',
                top: '4px',
                right: '4px',
                width: '14px',
                height: '14px',
                borderRadius: '50%',
                background: inDarkHeader ? '#D4AF37' : 'var(--primary)',
                color: inDarkHeader ? '#3D1518' : '#fff',
                fontSize: '9px',
                fontWeight: '700',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                border: inDarkHeader ? '2px solid #722F37' : '2px solid var(--bg-card)'
              }}>
                {unreadCount > 9 ? '9+' : unreadCount}
              </div>
            )}
          </button>
        </div>
      );
    };

    // Category Card
    const CategoryCard = ({ category, count, onClick, index }) => {
      const { theme } = useApp();
      
      return (
        <div className={`card-hover animate-in stagger-${index + 1}`} style={{
          background: theme === 'dark' ? 'rgba(58, 58, 74, 0.5)' : 'rgba(244, 228, 188, 0.15)',
          borderRadius: 'var(--radius)', padding: '14px', cursor: 'pointer',
          position: 'relative', display: 'flex', flexDirection: 'row', alignItems: 'center', gap: '12px',
          border: '1px solid rgba(212, 175, 55, 0.15)'
        }} onClick={onClick}>
          <div style={{
            width: '42px', height: '42px', borderRadius: '12px',
            background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
            border: '1px solid rgba(212, 175, 55, 0.2)',
            display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0
          }}>
            <CategoryIcon categoryId={category.id} size={20} color="#D4AF37" />
          </div>
          <div style={{ minWidth: 0 }}>
            <h3 style={{
              fontFamily: "Outfit, sans-serif", fontSize: '14px', fontWeight: '600',
              color: 'var(--text-primary)', marginBottom: '1px',
              whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'
            }}>{category.name}</h3>
            <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{count} partitura{count !== 1 ? 's' : ''}</span>
          </div>
        </div>
      );
    };

    // Featured Sheets - Partituras em Destaque (sendo estudadas)
    // Featured Card - Componente separado para evitar re-renders
    const FeaturedCard = React.memo(({ sheet, category, bgImage, isFav, onToggleFavorite, isDesktop, stopAnimation }) => {
      const { setSelectedSheet } = useApp();
      
      // Ref local para drag no desktop
      const cardMouseStart = React.useRef({ x: 0, y: 0 });
      
      const handleMouseDown = (e) => {
        if (isDesktop) {
          cardMouseStart.current = { x: e.clientX, y: e.clientY };
        }
        stopAnimation();
      };
      
      const handleClick = (e) => {
        // No mobile sempre abre
        if (!isDesktop) {
          setSelectedSheet(sheet);
          return;
        }
        
        // No desktop, verifica se moveu (drag) ou foi click simples
        const dx = Math.abs(e.clientX - cardMouseStart.current.x);
        const dy = Math.abs(e.clientY - cardMouseStart.current.y);
        
        // Se moveu menos de 5px, é um click
        if (dx < 5 && dy < 5) {
          setSelectedSheet(sheet);
        }
      };
      
      return (
        <div 
          className="featured-card"
          onMouseDown={handleMouseDown}
          onTouchStart={stopAnimation}
          onClick={handleClick}
          style={{
            width: isDesktop ? '280px' : '200px',
            minWidth: isDesktop ? '280px' : '200px',
            maxWidth: isDesktop ? '280px' : '200px',
            height: 'auto',
            flexShrink: 0,
            alignSelf: 'flex-start',
            background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
            borderRadius: '20px',
            padding: isDesktop ? '24px' : '20px',
            position: 'relative',
            overflow: 'hidden',
            cursor: 'pointer',
            boxSizing: 'border-box'
          }}
        >
          {/* Borda dourada */}
          <div style={{
            position: 'absolute', top: 0, left: 0, right: 0, bottom: 0,
            borderRadius: '20px', padding: '2px',
            background: 'linear-gradient(135deg, #D4AF37 0%, #F4E4BC 25%, #D4AF37 50%, #AA8C2C 75%, #D4AF37 100%)',
            WebkitMask: 'linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)',
            mask: 'linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)',
            WebkitMaskComposite: 'xor', maskComposite: 'exclude',
            pointerEvents: 'none', animation: 'borderGlow 2s ease-in-out infinite'
          }} />
          
          {/* Imagem decorativa */}
          <div style={{
            position: 'absolute', top: 0, right: 0, width: '120px', height: '120px',
            backgroundImage: `url(${bgImage})`, backgroundSize: 'cover', backgroundPosition: 'center',
            opacity: 0.15, pointerEvents: 'none',
            maskImage: 'radial-gradient(ellipse at top right, black 0%, transparent 70%)',
            WebkitMaskImage: 'radial-gradient(ellipse at top right, black 0%, transparent 70%)'
          }} />
          
          {/* Badge */}
          <div style={{
            position: 'absolute', top: '12px', right: '12px',
            background: '#D4AF37', color: '#3D1518',
            fontSize: '9px', fontFamily: 'Outfit, sans-serif', fontWeight: '700',
            padding: '4px 8px', borderRadius: '8px',
            textTransform: 'uppercase', letterSpacing: '0.5px', zIndex: 2
          }}>Em estudo</div>
          
          {/* Conteúdo */}
          <div style={{ position: 'relative', zIndex: 1 }}>
            <div style={{
              width: '48px', height: '48px', borderRadius: '12px',
              background: 'rgba(255,255,255,0.15)', backdropFilter: 'blur(8px)',
              border: '1px solid rgba(255,255,255,0.1)',
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              marginBottom: '14px'
            }}>
              <div style={{ width: '24px', height: '24px', color: '#F4E4BC' }}><Icons.Music /></div>
            </div>
            
            <h4 style={{
              fontSize: '16px', fontWeight: '700', marginBottom: '4px',
              color: '#FFFFFF', fontFamily: 'Outfit, sans-serif'
            }}>{sheet.title}</h4>
            
            <p style={{
              fontSize: '13px', fontFamily: 'Outfit, sans-serif',
              color: 'rgba(255,255,255,0.7)', marginBottom: '14px',
              whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'
            }}>{sheet.composer}</p>
            
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{
                padding: '5px 10px', background: 'rgba(212,175,55,0.2)',
                borderRadius: '8px', border: '1px solid rgba(212,175,55,0.3)'
              }}>
                <span style={{ fontSize: '11px', fontFamily: 'Outfit, sans-serif', color: '#D4AF37', fontWeight: '600' }}>
                  {category?.name}
                </span>
              </div>
              
              <button
                onClick={(e) => { e.stopPropagation(); onToggleFavorite(sheet.id); }}
                style={{
                  background: isFav ? 'rgba(212,175,55,0.3)' : 'rgba(255,255,255,0.15)',
                  border: '1px solid ' + (isFav ? 'rgba(212,175,55,0.5)' : 'rgba(255,255,255,0.1)'),
                  color: isFav ? '#D4AF37' : 'rgba(255,255,255,0.7)',
                  cursor: 'pointer', padding: '6px', borderRadius: '8px',
                  width: '30px', height: '30px',
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                  transition: 'all 0.2s ease'
                }}
              >
                <div style={{ width: '16px', height: '16px' }}><Icons.Heart filled={isFav} /></div>
              </button>
            </div>
          </div>
        </div>
      );
    });

    // Featured Sheets Section
    const FeaturedSheets = ({ sheets, onToggleFavorite, favorites }) => {
      const { theme, setActiveTab, setSelectedCategory } = useApp();
      const [isDesktop, setIsDesktop] = React.useState(window.innerWidth >= 1024);
      const scrollRef = React.useRef(null);
      const [hasInteracted, setHasInteracted] = React.useState(false);
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      React.useEffect(() => {
        const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      const categoryImages = {
        dobrado: 'https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?w=400&q=80',
        marcha: 'https://images.unsplash.com/photo-1519892300165-cb5542fb47c7?w=400&q=80',
        valsa: 'https://images.unsplash.com/photo-1507838153414-b4b713384a76?w=400&q=80',
        fantasia: 'https://images.unsplash.com/photo-1465847899084-d164df4dedc6?w=400&q=80',
        polaca: 'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?w=400&q=80',
        bolero: 'https://images.unsplash.com/photo-1511192336575-5a79af67a629?w=400&q=80',
        popular: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=400&q=80',
        hinos: 'https://images.unsplash.com/photo-1438232992991-995b7058bbb3?w=400&q=80'
      };
      
      const featuredSheets = useMemo(() => {
        // Mostra apenas partituras marcadas como destaque
        const featured = sheets.filter(s => s.featured);
        return featured.slice(0, 8);
      }, [sheets]);
      
      // Não mostra a seção se não houver destaques
      if (featuredSheets.length === 0) return null;
      
      // Refs para scroll e animação
      const innerRef = React.useRef(null);
      
      // Só duplica os cards se tiver mais de 2 (para animação fluida)
      const duplicatedSheets = featuredSheets.length > 2 
        ? [...featuredSheets, ...featuredSheets] 
        : featuredSheets;
      
      // Para a animação quando o usuário interage
      const stopAnimation = React.useCallback(() => {
        if (!hasInteracted) {
          // Captura a posição atual da animação
          if (innerRef.current && scrollRef.current) {
            const computedStyle = window.getComputedStyle(innerRef.current);
            const transform = computedStyle.transform;
            
            if (transform && transform !== 'none') {
              const matrix = new DOMMatrix(transform);
              const currentX = matrix.m41;
              scrollRef.current.scrollLeft = Math.abs(currentX);
            }
          }
          setHasInteracted(true);
        }
      }, [hasInteracted]);
      
      return (
        <div style={{ marginBottom: '32px', width: '100%', overflow: 'visible' }}>
          {/* Header */}
          <div style={{ 
            display: 'flex', justifyContent: 'space-between', alignItems: 'center',
            padding: isDesktop ? '0' : '0 20px', marginBottom: '16px'
          }}>
            <div>
              <h2 style={{ fontFamily: 'Outfit, sans-serif', fontSize: '18px', fontWeight: '700', marginBottom: '2px' }}>
                ✨ Em Destaque
              </h2>
              <p style={{ fontSize: '13px', color: 'var(--text-muted)' }}>Partituras em estudo</p>
            </div>
            {!hasInteracted && (
              <div style={{ display: 'flex', alignItems: 'center', gap: '4px', color: 'var(--text-muted)', fontSize: '12px' }}>
                <span>Arraste</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
              </div>
            )}
          </div>
          
          {/* Cards - Scroll fluido tanto no desktop quanto mobile */}
          <div 
            ref={scrollRef}
            onMouseDown={(e) => {
              if (isDesktop && scrollRef.current) {
                scrollRef.current.dataset.startX = e.pageX;
                scrollRef.current.dataset.scrollLeft = scrollRef.current.scrollLeft;
                scrollRef.current.dataset.isDragging = 'true';
              }
            }}
            onMouseMove={(e) => {
              if (!isDesktop || !scrollRef.current || scrollRef.current.dataset.isDragging !== 'true') return;
              const startX = parseFloat(scrollRef.current.dataset.startX);
              const scrollLeft = parseFloat(scrollRef.current.dataset.scrollLeft);
              const diff = e.pageX - startX;
              scrollRef.current.scrollLeft = scrollLeft - diff;
            }}
            onMouseUp={() => {
              if (scrollRef.current) scrollRef.current.dataset.isDragging = 'false';
            }}
            onMouseLeave={() => {
              if (scrollRef.current) scrollRef.current.dataset.isDragging = 'false';
            }}
            style={{
              overflowX: hasInteracted ? 'auto' : 'hidden',
              overflowY: 'visible',
              paddingTop: '8px',
              paddingBottom: '16px',
              paddingLeft: isDesktop ? '0' : '20px',
              paddingRight: isDesktop ? '0' : '20px',
              marginBottom: '-8px',
              WebkitOverflowScrolling: 'touch',
              scrollbarWidth: 'none',
              msOverflowStyle: 'none',
              cursor: isDesktop ? 'grab' : 'default'
            }}
          >
            <div 
              ref={innerRef}
              style={{
                display: 'inline-flex',
                alignItems: 'flex-start',
                gap: isDesktop ? '20px' : '14px',
                animation: (!hasInteracted && featuredSheets.length > 2) 
                  ? `marqueeScroll ${isDesktop ? '80s' : '60s'} linear infinite` 
                  : 'none'
              }}
            >
              {(hasInteracted || featuredSheets.length <= 2 ? featuredSheets : duplicatedSheets).map((sheet, index) => (
                <FeaturedCard 
                  key={`${sheet.id}-${index}`} 
                  sheet={sheet}
                  category={CATEGORIES.find(c => c.id === sheet.category)}
                  bgImage={categoryImages[sheet.category]}
                  isFav={favorites.includes(sheet.id)}
                  onToggleFavorite={onToggleFavorite}
                  isDesktop={isDesktop}
                  stopAnimation={stopAnimation}
                />
              ))}
            </div>
          </div>
        </div>
      );
    };

    // File Card
    const FileCard = ({ sheet, category, onDownload, isFavorite, onToggleFavorite }) => {
      const { theme, setSelectedSheet } = useApp();
      const [isPressed, setIsPressed] = React.useState(false);
      
      const handleDownloadClick = (e) => {
        e.stopPropagation();
        // Abre o modal da partitura para escolher instrumento e baixar
        setSelectedSheet(sheet);
      };
      
      const handleCardClick = () => {
        setSelectedSheet(sheet);
      };
      
      const handleMouseDown = (e) => {
        // Só aplica animação se clicar no card diretamente (não nos botões)
        if (e.target.closest('button')) return;
        setIsPressed(true);
      };
      
      const handleMouseUp = () => {
        setIsPressed(false);
      };
      
      return (
        <div 
          className="file-card" 
          onClick={handleCardClick}
          onMouseDown={handleMouseDown}
          onMouseUp={handleMouseUp}
          onMouseLeave={handleMouseUp}
          onTouchStart={handleMouseDown}
          onTouchEnd={handleMouseUp}
          style={{
            display: 'flex', alignItems: 'center', gap: '14px', padding: '14px',
            background: 'var(--bg-card)', borderRadius: 'var(--radius)',
            cursor: 'pointer', border: '1px solid var(--border)',
            transition: 'transform 0.2s ease, box-shadow 0.2s ease',
            transform: isPressed ? 'scale(0.98)' : 'none'
          }}
        >
          <div style={{
            width: '52px', height: '52px', borderRadius: 'var(--radius-sm)',
            background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
            border: '1px solid rgba(212, 175, 55, 0.2)',
            display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0,
            position: 'relative'
          }}>
            <CategoryIcon categoryId={category?.id} size={24} color="#D4AF37" />
          </div>
          <div style={{ flex: 1, minWidth: 0 }}>
            <h4 style={{
              fontSize: '15px', fontWeight: '600', marginBottom: '3px',
              whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', color: 'var(--text-primary)'
            }}>{sheet.title}</h4>
            <p style={{ fontSize: '13px', color: 'var(--text-muted)' }}>{sheet.composer}</p>
          </div>
          <button style={{
            width: '32px', height: '32px', borderRadius: '8px', background: isFavorite ? 'rgba(232,90,79,0.1)' : 'transparent',
            border: 'none', color: isFavorite ? 'var(--primary)' : 'var(--text-muted)', 
            display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer',
            transition: 'color 0.15s ease, background 0.15s ease'
          }} onClick={(e) => { e.stopPropagation(); onToggleFavorite?.(); }}>
            <div style={{ width: '16px', height: '16px' }}><Icons.Heart filled={isFavorite} /></div>
          </button>
          <button style={{
            width: '32px', height: '32px', borderRadius: '8px', background: 'transparent',
            border: 'none', color: 'var(--primary)', display: 'flex', alignItems: 'center',
            justifyContent: 'center', cursor: 'pointer',
            transition: 'all 0.15s ease'
          }} onClick={handleDownloadClick}>
            <div style={{ width: '18px', height: '18px' }}><Icons.Download /></div>
          </button>
        </div>
      );
    };

    // Sheet Detail Modal - Modal de detalhes da partitura
    const SheetDetailModal = () => {
      const { selectedSheet, setSelectedSheet, favorites, toggleFavorite, showToast, user } = useApp();
      const [isDesktop, setIsDesktop] = React.useState(window.innerWidth >= 1024);
      const [showInstrumentPicker, setShowInstrumentPicker] = React.useState(false);
      const [confirmInstrument, setConfirmInstrument] = React.useState(null);
      const [partes, setPartes] = React.useState([]);
      const [loadingPartes, setLoadingPartes] = React.useState(false);
      const [showPartePicker, setShowPartePicker] = React.useState(false);
      const [partesDisponiveis, setPartesDisponiveis] = React.useState([]);
      const [downloading, setDownloading] = React.useState(false);
      const [selectedParte, setSelectedParte] = React.useState(null); // Para confirmação de outro instrumento
      
      React.useEffect(() => {
        const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      // Buscar partes da partitura quando abrir o modal
      React.useEffect(() => {
        if (selectedSheet) {
          setShowInstrumentPicker(false);
          setConfirmInstrument(null);
          setShowPartePicker(false);
          setPartesDisponiveis([]);
          
          // Busca as partes disponíveis para esta partitura
          const fetchPartes = async () => {
            setLoadingPartes(true);
            try {
              const response = await fetch(`${API_BASE_URL}/api/partituras/${selectedSheet.id}/partes`);
              if (response.ok) {
                const data = await response.json();
                setPartes(data || []);
              } else {
                setPartes([]);
              }
            } catch (e) {
              console.error('Erro ao buscar partes:', e);
              setPartes([]);
            }
            setLoadingPartes(false);
          };
          
          fetchPartes();
        }
      }, [selectedSheet]);
      
      if (!selectedSheet) return null;
      
      const category = CATEGORIES.find(c => c.id === selectedSheet.category);
      const isFavorite = favorites.includes(selectedSheet.id);
      const userInstrument = user?.instrument || 'Trompete Bb';
      const isMaestro = userInstrument?.toLowerCase() === 'maestro';
      
      // Lista de instrumentos disponíveis (da API ou fallback)
      const availableInstruments = partes.length > 0 
        ? partes.map(p => p.instrumento)
        : [
            'Grade', 'Flautim', 'Flauta', 'Requinta',
            'Clarinete Bb', 'Clarinete Bb 1', 'Clarinete Bb 2',
            'Sax. Soprano', 'Sax. Alto', 'Sax. Alto 1', 'Sax. Alto 2',
            'Sax. Tenor', 'Sax. Tenor 1', 'Sax. Tenor 2', 'Sax. Barítono',
            'Trompete Bb', 'Trompete Bb 1', 'Trompete Bb 2',
            'Trompa F', 'Trompa Eb', 'Trompa Eb 1', 'Trompa Eb 2',
            'Barítono Bb', 'Barítono Bb 1', 'Barítono Bb 2',
            'Trombone', 'Trombone 1', 'Trombone 2',
            'Bombardino', 'Bombardino Bb',
            'Baixo Eb', 'Baixo Bb',
            'Caixa', 'Bombo', 'Pratos'
          ];
      
      // Verifica se o instrumento do usuário está disponível
      const userInstrumentAvailable = availableInstruments.some(
        i => i.toLowerCase() === userInstrument.toLowerCase()
      );
      
      // Encontra TODAS as partes correspondentes ao instrumento
      const findPartesCorrespondentes = (instrumento) => {
        if (!instrumento || partes.length === 0) return [];
        
        const instrLower = instrumento.toLowerCase();
        // Remove números e "bb/eb" para busca mais ampla
        const instrBase = instrLower.replace(/\s*(bb|eb)?\s*\d*$/i, '').trim();
        
        // Encontra todas as partes que correspondem ao instrumento base
        const correspondentes = partes.filter(p => {
          const parteLower = p.instrumento.toLowerCase();
          const parteBase = parteLower.replace(/\s*(bb|eb)?\s*\d*$/i, '').trim();
          
          return parteLower === instrLower || // Match exato
                 parteLower.startsWith(instrLower) || // Começa com
                 parteBase === instrBase || // Base igual (ex: "Trompete" = "Trompete")
                 instrLower.startsWith(parteBase); // Instrumento do usuário é mais específico
        });
        
        return correspondentes;
      };
      
      // Encontra uma parte específica pelo nome exato
      const findParteExata = (instrumento) => {
        return partes.find(p => p.instrumento.toLowerCase() === instrumento.toLowerCase());
      };
      
      // Função de download direto
      const downloadParteDireta = async (parte) => {
        if (downloading) return;
        setDownloading(true);
        
        showToast(`Preparando "${selectedSheet.title}" - ${parte.instrumento}...`);
        
        try {
          const response = await fetch(`${API_BASE_URL}/api/download/parte/${parte.id}`, {
            headers: { 'Authorization': `Bearer ${Storage.get('authToken')}` }
          });
          
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedSheet.title} - ${parte.instrumento}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showToast('Iniciando download...');
          } else {
            showToast('Erro ao baixar arquivo', 'error');
          }
        } catch (e) {
          showToast('Erro ao baixar arquivo', 'error');
        }
        
        setDownloading(false);
        setShowPartePicker(false);
        setConfirmInstrument(null);
      };
      
      // Quando clica em "Meu Instrumento" ou seleciona um instrumento
      const handleSelectInstrument = (instrument) => {
        const correspondentes = findPartesCorrespondentes(instrument);
        
        if (correspondentes.length === 0) {
          // Nenhuma parte encontrada - mostra confirmação para buscar manual
          setConfirmInstrument(instrument);
        } else if (correspondentes.length === 1) {
          // Apenas uma parte - download direto
          downloadParteDireta(correspondentes[0]);
        } else {
          // Múltiplas partes - mostra seletor
          setPartesDisponiveis(correspondentes);
          setShowPartePicker(true);
          setConfirmInstrument(instrument);
        }
      };
      
      // Seleção direta de uma parte específica (ex: da lista de instrumentos)
      // Agora SEMPRE pede confirmação para evitar toque acidental
      const handleSelectParteEspecifica = (instrumento) => {
        const parte = findParteExata(instrumento);
        if (parte) {
          // Em vez de download direto, mostra confirmação
          setConfirmInstrument(instrumento);
          setSelectedParte(parte); // Guarda a parte para download posterior
        } else {
          showToast('Parte não encontrada', 'error');
        }
      };
      
      const handleConfirmDownload = async () => {
        // Se já temos uma parte selecionada (de "outro instrumento"), usa ela diretamente
        if (selectedParte) {
          downloadParteDireta(selectedParte);
          setConfirmInstrument(null);
          setSelectedParte(null);
          setShowInstrumentPicker(false);
          return;
        }
        
        // Caso contrário, busca correspondentes
        const correspondentes = findPartesCorrespondentes(confirmInstrument);
        
        if (correspondentes.length > 0) {
          downloadParteDireta(correspondentes[0]);
        } else {
          // Fallback: download da partitura principal
          setDownloading(true);
          showToast(`Preparando "${selectedSheet.title}"...`);
          try {
            const response = await fetch(`${API_BASE_URL}/api/download/${selectedSheet.id}`, {
              headers: { 'Authorization': `Bearer ${Storage.get('authToken')}` }
            });
            
            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `${selectedSheet.title}.pdf`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              a.remove();
              showToast('Iniciando download...');
            } else {
              showToast('Erro ao baixar arquivo', 'error');
            }
          } catch (e) {
            showToast('Erro ao baixar arquivo', 'error');
          }
          setDownloading(false);
        }
        
        setConfirmInstrument(null);
        setShowInstrumentPicker(false);
      };
      
      const handleCancelDownload = () => {
        setConfirmInstrument(null);
        setSelectedParte(null);
      };
      
      const handleClose = () => {
        setSelectedSheet(null);
      };
      
      return (
        <>
          {/* Overlay */}
          <div 
            onClick={handleClose}
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.6)',
              backdropFilter: 'blur(4px)',
              WebkitBackdropFilter: 'blur(4px)',
              zIndex: 2000,
              animation: 'fadeIn 0.2s ease'
            }}
          />
          
          {/* Modal de Seleção de Partes Múltiplas */}
          {showPartePicker && partesDisponiveis.length > 0 && (
            <>
              {/* Overlay */}
              <div 
                onClick={() => { setShowPartePicker(false); setConfirmInstrument(null); }}
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0,0,0,0.6)',
                  zIndex: 2002,
                  animation: 'fadeIn 0.15s ease'
                }}
              />
              <div style={{
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                background: 'var(--bg-card)',
                borderRadius: '20px',
                padding: '24px',
                zIndex: 2003,
                width: '340px',
                maxWidth: '90vw',
                boxShadow: '0 25px 50px rgba(0,0,0,0.4)',
                animation: 'scaleIn 0.25s cubic-bezier(0.16, 1, 0.3, 1)'
              }}>
                {/* Header com ícone */}
                <div style={{ textAlign: 'center', marginBottom: '20px' }}>
                  <div style={{
                    width: '56px',
                    height: '56px',
                    borderRadius: '50%',
                    background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    margin: '0 auto 12px',
                    boxShadow: '0 4px 12px rgba(114, 47, 55, 0.3)'
                  }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F4E4BC" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M9 18V5l12-2v13"/>
                      <circle cx="6" cy="18" r="3"/>
                      <circle cx="18" cy="16" r="3"/>
                    </svg>
                  </div>
                  <h3 style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '18px',
                    fontWeight: '700',
                    color: 'var(--text-primary)',
                    marginBottom: '6px'
                  }}>Escolha sua parte</h3>
                  <p style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '13px',
                    color: 'var(--text-muted)'
                  }}>
                    Encontramos {partesDisponiveis.length} partes de <strong style={{ color: '#D4AF37' }}>{confirmInstrument}</strong>
                  </p>
                </div>
                
                {/* Lista de partes */}
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px',
                  marginBottom: '20px',
                  maxHeight: '200px',
                  overflowY: 'auto'
                }}>
                  {partesDisponiveis.map((parte, idx) => (
                    <button
                      key={parte.id}
                      onClick={() => downloadParteDireta(parte)}
                      disabled={downloading}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        padding: '14px 16px',
                        borderRadius: '12px',
                        background: 'var(--bg-secondary)',
                        border: '1px solid var(--border)',
                        color: 'var(--text-primary)',
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: downloading ? 'wait' : 'pointer',
                        transition: 'all 0.2s ease',
                        opacity: downloading ? 0.6 : 1
                      }}
                      onMouseEnter={(e) => {
                        if (!downloading) {
                          e.currentTarget.style.background = 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)';
                          e.currentTarget.style.color = '#F4E4BC';
                          e.currentTarget.style.border = '1px solid transparent';
                        }
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = 'var(--bg-secondary)';
                        e.currentTarget.style.color = 'var(--text-primary)';
                        e.currentTarget.style.border = '1px solid var(--border)';
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <span style={{
                          width: '28px',
                          height: '28px',
                          borderRadius: '50%',
                          background: 'rgba(212, 175, 55, 0.15)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          fontSize: '12px',
                          fontWeight: '700',
                          color: '#D4AF37'
                        }}>
                          {idx + 1}
                        </span>
                        <span>{parte.instrumento}</span>
                      </div>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                      </svg>
                    </button>
                  ))}
                </div>
                
                {/* Botão Cancelar */}
                <button
                  onClick={() => { setShowPartePicker(false); setConfirmInstrument(null); }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    borderRadius: '10px',
                    background: 'transparent',
                    border: '1px solid var(--border)',
                    color: 'var(--text-muted)',
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer'
                  }}
                >
                  Cancelar
                </button>
              </div>
            </>
          )}
          
          {/* Modal de Confirmação (fallback quando não encontra partes específicas) */}
          {confirmInstrument && !showPartePicker && (
            <>
              {/* Overlay do modal de confirmação */}
              <div 
                onClick={handleCancelDownload}
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0,0,0,0.5)',
                  zIndex: 2002,
                  animation: 'fadeIn 0.15s ease'
                }}
              />
              <div style={{
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                background: 'var(--bg-card)',
                borderRadius: '16px',
                padding: '24px',
                zIndex: 2003,
                width: '300px',
                maxWidth: '85vw',
                boxShadow: '0 20px 40px rgba(0,0,0,0.3)',
                animation: 'scaleIn 0.25s cubic-bezier(0.16, 1, 0.3, 1)'
              }}>
                <h3 style={{
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '16px',
                  fontWeight: '700',
                  color: 'var(--text-primary)',
                  marginBottom: '8px',
                  textAlign: 'center'
                }}>Confirmar Download</h3>
                <p style={{
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '14px',
                  color: 'var(--text-muted)',
                  marginBottom: '20px',
                  textAlign: 'center'
                }}>
                  Baixar partitura de <strong style={{ color: '#D4AF37' }}>{confirmInstrument}</strong>?
                </p>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button
                    className="modal-btn"
                    onClick={handleCancelDownload}
                    style={{
                      flex: 1,
                      padding: '12px',
                      borderRadius: '10px',
                      background: 'var(--bg-secondary)',
                      border: '1px solid var(--border)',
                      color: 'var(--text-primary)',
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer'
                    }}
                  >
                    Cancelar
                  </button>
                  <button
                    className="modal-btn"
                    onClick={handleConfirmDownload}
                    disabled={downloading}
                    style={{
                      flex: 1,
                      padding: '12px',
                      borderRadius: '10px',
                      background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                      border: 'none',
                      color: '#F4E4BC',
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      opacity: downloading ? 0.6 : 1
                    }}
                  >
                    {downloading ? 'Baixando...' : 'Confirmar'}
                  </button>
                </div>
              </div>
            </>
          )}
          
          {/* Modal Principal */}
          <div style={{
            position: 'fixed',
            ...(isDesktop ? {
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              width: '420px',
              maxWidth: '90vw',
              borderRadius: '20px',
              animation: 'popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1)'
            } : {
              bottom: 0,
              left: 0,
              right: 0,
              borderRadius: '24px 24px 0 0',
              animation: 'slideUpModal 0.35s cubic-bezier(0.16, 1, 0.3, 1)'
            }),
            background: 'var(--bg-card)',
            zIndex: 2001,
            maxHeight: isDesktop ? '85vh' : '90vh',
            overflow: 'hidden',
            boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Handle - apenas mobile */}
            {!isDesktop && (
              <div style={{ 
                width: '40px', 
                height: '4px', 
                background: 'var(--border)', 
                borderRadius: '2px', 
                margin: '12px auto',
                flexShrink: 0
              }} />
            )}
            
            {/* Header com imagem */}
            <div style={{
              background: 'linear-gradient(145deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.05) 100%)',
              padding: isDesktop ? '20px' : '16px 20px',
              position: 'relative',
              overflow: 'hidden',
              flexShrink: 0
            }}>
              {/* Ícone decorativo */}
              <div style={{
                position: 'absolute',
                top: '-20px',
                right: '-20px',
                width: '100px',
                height: '100px',
                background: 'rgba(212, 175, 55, 0.1)',
                borderRadius: '50%'
              }} />
              
              <div style={{ display: 'flex', gap: '14px', alignItems: 'flex-start', position: 'relative', zIndex: 1 }}>
                <div style={{
                  width: '56px',
                  height: '56px',
                  borderRadius: '14px',
                  background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                  border: '1px solid rgba(212, 175, 55, 0.2)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0
                }}>
                  <CategoryIcon categoryId={category?.id} size={26} color="#D4AF37" />
                </div>
                
                <div style={{ flex: 1, minWidth: 0 }}>
                  <h2 style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '17px',
                    fontWeight: '700',
                    color: 'var(--text-primary)',
                    marginBottom: '3px',
                    lineHeight: '1.3'
                  }}>{selectedSheet.title}</h2>
                  <p style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '13px',
                    color: 'var(--text-muted)',
                    marginBottom: '6px'
                  }}>{selectedSheet.composer}</p>
                  <span style={{
                    display: 'inline-block',
                    padding: '3px 8px',
                    background: 'rgba(212, 175, 55, 0.15)',
                    color: '#D4AF37',
                    borderRadius: '6px',
                    fontSize: '10px',
                    fontWeight: '600',
                    fontFamily: 'Outfit, sans-serif'
                  }}>{category?.name}</span>
                </div>
                
                {/* Botão fechar */}
                <button
                  onClick={handleClose}
                  style={{
                    width: '32px',
                    height: '32px',
                    borderRadius: '50%',
                    background: 'var(--bg-secondary)',
                    border: 'none',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    color: 'var(--text-muted)',
                    flexShrink: 0
                  }}
                >
                  <div style={{ width: '16px', height: '16px' }}><Icons.Close /></div>
                </button>
              </div>
            </div>
            
            {/* Conteúdo scrollável */}
            <div style={{ 
              padding: isDesktop ? '16px 20px 20px' : '16px 20px 28px',
              overflowY: 'auto',
              flex: 1
            }}>
              {/* Info compacta */}
              <div style={{
                display: 'flex',
                gap: '8px',
                marginBottom: '16px',
                flexWrap: 'wrap'
              }}>
                <div style={{
                  background: 'var(--bg-secondary)',
                  padding: '8px 12px',
                  borderRadius: '8px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}>
                  <div style={{ width: '12px', height: '12px', color: 'var(--text-muted)' }}><Icons.Download /></div>
                  <span style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif' }}>
                    {selectedSheet.downloads || 0}
                  </span>
                </div>
                <div style={{
                  background: 'var(--bg-secondary)',
                  padding: '8px 12px',
                  borderRadius: '8px'
                }}>
                  <span style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif' }}>
                    {selectedSheet.year}
                  </span>
                </div>
                {selectedSheet.featured && (
                  <div style={{
                    background: 'rgba(212, 175, 55, 0.15)',
                    padding: '8px 12px',
                    borderRadius: '8px'
                  }}>
                    <span style={{ fontSize: '12px', fontWeight: '600', color: '#D4AF37', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '4px' }}>
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="#D4AF37" stroke="none">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                      </svg>
                      Destaque
                    </span>
                  </div>
                )}
              </div>
              
              {/* Opções de Download */}
              <div style={{ marginBottom: '14px' }}>
                <p style={{ 
                  fontSize: '10px', 
                  color: 'var(--text-muted)', 
                  marginBottom: '8px', 
                  fontFamily: 'Outfit, sans-serif',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  fontWeight: '600'
                }}>Baixar Partitura</p>
                
                {/* Botão Download - Meu Instrumento (não aparece para Maestro) */}
                {!isMaestro && (
                  <button
                    className="modal-btn"
                    onClick={() => handleSelectInstrument(userInstrument)}
                    style={{
                      width: '100%',
                      padding: '12px 14px',
                      borderRadius: '10px',
                      background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                      border: 'none',
                      color: '#F4E4BC',
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '13px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      marginBottom: '8px',
                      boxShadow: '0 4px 12px rgba(114, 47, 55, 0.3)'
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <div style={{ width: '16px', height: '16px' }}><Icons.Download /></div>
                      <span>Meu Instrumento</span>
                    </div>
                    <span style={{ 
                      background: 'rgba(244, 228, 188, 0.2)', 
                      padding: '3px 8px', 
                      borderRadius: '5px',
                      fontSize: '10px',
                      fontWeight: '700'
                    }}>{userInstrument}</span>
                  </button>
                )}
                
                {/* Botão Baixar Grade - Só para Maestro */}
                {isMaestro && (
                  <button
                    className="modal-btn"
                    onClick={() => handleSelectInstrument('Grade')}
                    style={{
                      width: '100%',
                      padding: '12px 14px',
                      borderRadius: '10px',
                      background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                      border: 'none',
                      color: '#F4E4BC',
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '13px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between',
                      marginBottom: '8px',
                      boxShadow: '0 4px 12px rgba(114, 47, 55, 0.3)'
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <div style={{ width: '16px', height: '16px' }}><Icons.Download /></div>
                      <span>Baixar Grade</span>
                    </div>
                    <span style={{ 
                      background: 'rgba(244, 228, 188, 0.2)', 
                      padding: '3px 8px', 
                      borderRadius: '5px',
                      fontSize: '10px',
                      fontWeight: '700',
                      display: 'flex',
                      alignItems: 'center'
                    }}>
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#F4E4BC" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                      </svg>
                    </span>
                  </button>
                )}
                
                {/* Botão Outro Instrumento / Escolher Parte - Expandível */}
                <button
                  className="modal-btn"
                  onClick={() => setShowInstrumentPicker(!showInstrumentPicker)}
                  style={{
                    width: '100%',
                    padding: '12px 14px',
                    borderRadius: showInstrumentPicker ? '10px 10px 0 0' : '10px',
                    background: 'var(--bg-secondary)',
                    border: '1px solid var(--border)',
                    borderBottom: showInstrumentPicker ? 'none' : '1px solid var(--border)',
                    color: 'var(--text-primary)',
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '13px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <div style={{ width: '16px', height: '16px' }}><Icons.Music /></div>
                    <span>{isMaestro ? 'Escolher Parte' : 'Outro Instrumento'}</span>
                  </div>
                  <div style={{ 
                    width: '16px', 
                    height: '16px',
                    transition: 'transform 0.2s ease',
                    transform: showInstrumentPicker ? 'rotate(180deg)' : 'rotate(0deg)'
                  }}>
                    <Icons.ChevronDown />
                  </div>
                </button>
                
                {/* Lista de Instrumentos */}
                {showInstrumentPicker && (
                  <div style={{
                    background: 'var(--bg-secondary)',
                    border: '1px solid var(--border)',
                    borderTop: 'none',
                    borderRadius: '0 0 10px 10px',
                    maxHeight: '200px',
                    overflowY: 'auto'
                  }}>
                    {availableInstruments.map((instrument, idx) => (
                      <button
                        key={instrument}
                        className="instrument-item"
                        onClick={() => handleSelectParteEspecifica(instrument)}
                        disabled={downloading}
                        style={{
                          width: '100%',
                          padding: '10px 14px',
                          background: 'transparent',
                          border: 'none',
                          borderBottom: idx < availableInstruments.length - 1 ? '1px solid var(--border)' : 'none',
                          color: (isMaestro ? instrument === 'Grade' : instrument === userInstrument) ? '#D4AF37' : 'var(--text-primary)',
                          fontFamily: 'Outfit, sans-serif',
                          fontSize: '13px',
                          fontWeight: (isMaestro ? instrument === 'Grade' : instrument === userInstrument) ? '600' : '500',
                          cursor: downloading ? 'wait' : 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          textAlign: 'left',
                          opacity: downloading ? 0.6 : 1
                        }}
                      >
                        <span>{instrument}</span>
                        {(isMaestro ? instrument === 'Grade' : instrument === userInstrument) && (
                          <span style={{ 
                            fontSize: '9px', 
                            background: 'rgba(212,175,55,0.2)', 
                            color: '#D4AF37',
                            padding: '2px 6px',
                            borderRadius: '4px',
                            fontWeight: '700',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '2px'
                          }}>
                            {isMaestro ? (
                              <svg width="8" height="8" viewBox="0 0 24 24" fill="#D4AF37" stroke="none">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                              </svg>
                            ) : 'MEU'}
                          </span>
                        )}
                      </button>
                    ))}
                  </div>
                )}
              </div>
              
              {/* Botão Favoritar */}
              <button
                className="modal-btn"
                onClick={() => toggleFavorite(selectedSheet.id)}
                style={{
                  width: '100%',
                  padding: '10px',
                  borderRadius: '10px',
                  background: isFavorite ? 'rgba(232,90,79,0.1)' : 'transparent',
                  border: isFavorite ? '1.5px solid var(--primary)' : '1.5px solid var(--border)',
                  color: isFavorite ? 'var(--primary)' : 'var(--text-muted)',
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '12px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '6px'
                }}
              >
                <div style={{ width: '14px', height: '14px' }}><Icons.Heart filled={isFavorite} /></div>
                {isFavorite ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos'}
              </button>
            </div>
          </div>
        </>
      );
    };

    // Notifications Panel
    const NotificationsPanel = () => {
      const { 
        notifications, showNotifications, setShowNotifications, 
        markNotificationAsRead, markAllNotificationsAsRead,
        setActiveTab, setSelectedCategory, sheets, theme
      } = useApp();
      
      // Detecta se é dispositivo touch
      const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      // Bloqueia scroll do body quando painel está aberto (apenas mobile)
      React.useEffect(() => {
        if (showNotifications && isMobile) {
          document.body.style.overflow = 'hidden';
          document.body.style.position = 'fixed';
          document.body.style.width = '100%';
          document.body.style.top = `-${window.scrollY}px`;
        } else {
          const scrollY = document.body.style.top;
          document.body.style.overflow = '';
          document.body.style.position = '';
          document.body.style.width = '';
          document.body.style.top = '';
          if (scrollY) {
            window.scrollTo(0, parseInt(scrollY || '0') * -1);
          }
        }
        return () => {
          document.body.style.overflow = '';
          document.body.style.position = '';
          document.body.style.width = '';
          document.body.style.top = '';
        };
      }, [showNotifications, isMobile]);
      
      const formatDate = (dateString) => {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Hoje';
        if (diffDays === 1) return 'Ontem';
        if (diffDays < 7) return `${diffDays} dias atrás`;
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
      };
      
      const handleNotificationClick = (notification) => {
        markNotificationAsRead(notification.id);
        
        if (notification.type === 'new_sheet' && notification.sheetId) {
          const sheet = sheets.find(s => s.id === notification.sheetId);
          if (sheet) {
            setSelectedCategory(sheet.category);
            setActiveTab('library');
          }
        }
        
        setShowNotifications(false);
      };
      
      if (!showNotifications) return null;
      
      return (
        <>
          {/* Overlay - só no mobile */}
          {isMobile && (
            <div 
              onClick={() => setShowNotifications(false)}
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                zIndex: 1000,
                animation: 'fadeIn 0.2s ease'
              }}
            />
          )}
          
          {/* Área clicável atrás do painel no desktop */}
          {!isMobile && (
            <div 
              onClick={() => setShowNotifications(false)}
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                zIndex: 1000
              }}
            />
          )}
          
          {/* Panel */}
          <div style={{
            position: 'fixed',
            top: isMobile ? '50%' : '70px',
            left: isMobile ? '50%' : 'auto',
            right: isMobile ? 'auto' : '16px',
            transform: isMobile ? 'translate(-50%, -50%)' : 'none',
            width: isMobile ? 'calc(100% - 40px)' : 'calc(100% - 32px)',
            maxWidth: '360px',
            maxHeight: isMobile ? '80vh' : '70vh',
            background: 'var(--bg-card)',
            borderRadius: '20px',
            boxShadow: '0 8px 32px rgba(0,0,0,0.25)',
            zIndex: 1001,
            overflow: 'hidden',
            animation: isMobile ? 'popIn 0.25s ease' : 'slideUp 0.3s ease',
            border: '1px solid var(--border)'
          }}>
            {/* Header */}
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '16px 20px',
              borderBottom: '1px solid var(--border)'
            }}>
              <h3 style={{ fontFamily: 'Outfit, sans-serif', fontSize: '18px', fontWeight: '700' }}>
                Notificações
              </h3>
              {notifications.some(n => !n.read) && (
                <button
                  onClick={markAllNotificationsAsRead}
                  style={{
                    background: 'none',
                    border: 'none',
                    color: 'var(--primary)',
                    fontSize: '13px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  Marcar todas como lidas
                </button>
              )}
            </div>
            
            {/* Lista de notificações */}
            <div style={{ maxHeight: 'calc(70vh - 60px)', overflowY: 'auto' }}>
              {notifications.length === 0 ? (
                <div style={{ padding: '40px 20px', textAlign: 'center', color: 'var(--text-muted)' }}>
                  <div style={{ width: '48px', height: '48px', margin: '0 auto 12px', opacity: 0.5 }}>
                    <Icons.Bell />
                  </div>
                  <p>Nenhuma notificação</p>
                </div>
              ) : (
                notifications.map(notification => (
                  <div
                    key={notification.id}
                    onClick={() => handleNotificationClick(notification)}
                    style={{
                      display: 'flex',
                      alignItems: 'flex-start',
                      gap: '12px',
                      padding: '14px 20px',
                      cursor: 'pointer',
                      background: notification.read ? 'transparent' : (theme === 'dark' ? 'rgba(212,175,55,0.08)' : 'rgba(212,175,55,0.1)'),
                      borderBottom: '1px solid var(--border)',
                      transition: 'background 0.2s ease'
                    }}
                  >
                    {/* Ícone */}
                    <div style={{
                      width: '40px',
                      height: '40px',
                      borderRadius: '10px',
                      background: 'linear-gradient(135deg, #722F37 0%, #5C1A1B 100%)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      <div style={{ width: '20px', height: '20px', color: '#D4AF37' }}>
                        <Icons.Music />
                      </div>
                    </div>
                    
                    {/* Conteúdo */}
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <p style={{ 
                        fontSize: '14px', 
                        fontWeight: notification.read ? '500' : '600',
                        color: 'var(--text-primary)',
                        marginBottom: '2px'
                      }}>
                        {notification.title}
                      </p>
                      <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '4px' }}>
                        {notification.message}
                      </p>
                      <p style={{ fontSize: '12px', color: 'var(--text-muted)', opacity: 0.7 }}>
                        {formatDate(notification.date)}
                      </p>
                    </div>
                    
                    {/* Indicador de não lida */}
                    {!notification.read && (
                      <div style={{
                        width: '8px',
                        height: '8px',
                        borderRadius: '50%',
                        background: 'var(--primary)',
                        flexShrink: 0,
                        marginTop: '6px'
                      }} />
                    )}
                  </div>
                ))
              )}
            </div>
          </div>
        </>
      );
    };

    // Desktop Header - barra superior da área de conteúdo
    const DesktopHeader = () => {
      const { setShowNotifications, unreadCount, sheets, favorites, toggleFavorite, setActiveTab, setSelectedCategory } = useApp();
      const [searchQuery, setSearchQuery] = React.useState('');
      const [showResults, setShowResults] = React.useState(false);
      
      // Função de distância Levenshtein para busca fuzzy
      const levenshtein = (a, b) => {
        const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
        for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
        for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
        for (let j = 1; j <= b.length; j++) {
          for (let i = 1; i <= a.length; i++) {
            const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
              matrix[j][i - 1] + 1,
              matrix[j - 1][i] + 1,
              matrix[j - 1][i - 1] + indicator
            );
          }
        }
        return matrix[b.length][a.length];
      };
      
      // Busca fuzzy nos sheets
      const searchResults = React.useMemo(() => {
        if (!searchQuery.trim()) return [];
        
        const query = searchQuery.toLowerCase().trim();
        
        return sheets
          .map(sheet => {
            const titleLower = sheet.title.toLowerCase();
            const composerLower = sheet.composer.toLowerCase();
            const category = CATEGORIES.find(c => c.id === sheet.category);
            const categoryLower = category?.name.toLowerCase() || '';
            
            // Pontuação por diferentes critérios
            let score = 0;
            
            // Match exato no início (maior peso)
            if (titleLower.startsWith(query)) score += 100;
            else if (titleLower.includes(query)) score += 50;
            
            if (composerLower.startsWith(query)) score += 80;
            else if (composerLower.includes(query)) score += 40;
            
            if (categoryLower.startsWith(query)) score += 60;
            else if (categoryLower.includes(query)) score += 30;
            
            // Fuzzy match com Levenshtein
            const titleDist = levenshtein(query, titleLower.slice(0, query.length));
            const composerDist = levenshtein(query, composerLower.slice(0, query.length));
            
            if (titleDist <= 2) score += (20 - titleDist * 5);
            if (composerDist <= 2) score += (15 - composerDist * 5);
            
            return { ...sheet, score, category };
          })
          .filter(sheet => sheet.score > 0)
          .sort((a, b) => b.score - a.score)
          .slice(0, 8);
      }, [searchQuery, sheets]);
      
      // Controla exibição dos resultados com delay para animação
      React.useEffect(() => {
        if (searchQuery.trim()) {
          setShowResults(true);
        } else {
          const timeout = setTimeout(() => setShowResults(false), 200);
          return () => clearTimeout(timeout);
        }
      }, [searchQuery]);
      
      // Usa a função global getNextRehearsal
      const rehearsalInfo = getNextRehearsal();
      
      return (
        <header style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '20px',
          marginBottom: '24px',
          paddingBottom: '16px',
          borderBottom: '1px solid var(--border)'
        }}>
          {/* Linha superior: data/ensaio + busca + ícones */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '16px'
          }}>
            {/* Data e próximo ensaio */}
            <div style={{ 
              display: 'flex',
              flexDirection: 'column',
              gap: '4px',
              minWidth: '200px'
            }}>
              <span style={{ 
                fontFamily: 'Outfit, sans-serif',
                fontSize: '13px', 
                color: 'var(--text-muted)',
                whiteSpace: 'nowrap'
              }}>
                {new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}
              </span>
              
              {/* Contador do próximo ensaio */}
              {rehearsalInfo.isNow ? (
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <div style={{
                    width: '10px',
                    height: '10px',
                    borderRadius: '50%',
                    background: '#22C55E',
                    animation: 'pulse 2s ease-in-out infinite'
                  }} />
                  <span style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '13px',
                    fontWeight: '700',
                    color: '#22C55E'
                  }}>
                    Ensaio agora!
                  </span>
                </div>
              ) : (
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <span style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '12px',
                    fontWeight: '700',
                    color: 'var(--text-muted)'
                  }}>
                    Próximo ensaio:
                  </span>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    background: 'rgba(212, 175, 55, 0.15)',
                    padding: '4px 10px',
                    borderRadius: '8px'
                  }}>
                    {rehearsalInfo.days > 0 && (
                      <span style={{
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '14px',
                        fontWeight: '800',
                        color: '#D4AF37'
                      }}>
                        {rehearsalInfo.days}d
                      </span>
                    )}
                    <span style={{
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '14px',
                      fontWeight: '800',
                      color: '#D4AF37'
                    }}>
                      {rehearsalInfo.hours}h{rehearsalInfo.minutes > 0 ? ` ${rehearsalInfo.minutes}m` : ''}
                    </span>
                    <span style={{
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '12px',
                      color: 'var(--text-muted)',
                      fontWeight: '500'
                    }}>
                      ({rehearsalInfo.dayName})
                    </span>
                  </div>
                </div>
              )}
            </div>
            
            {/* Espaçador flexível */}
            <div style={{ flex: 1 }} />
            
            {/* Barra de busca centralizada */}
            <div style={{
              width: '100%',
              maxWidth: '400px',
              position: 'relative'
            }}>
              <div className="search-bar" style={{ padding: '10px 16px' }}>
                <svg className="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
                <input
                  type="text"
                  placeholder="Buscar partituras..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
                {searchQuery && (
                  <button className="clear-btn" onClick={() => setSearchQuery('')}>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                )}
              </div>
            </div>
            
            {/* Espaçador flexível */}
            <div style={{ flex: 1 }} />
            
            {/* Ícones */}
            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
              {/* Seletor de tema inline */}
              <ThemeSelector inline />
              
              {/* Sininho de notificações */}
              <button
                onClick={() => setShowNotifications(true)}
                style={{
                  width: '40px',
                  height: '40px',
                  borderRadius: '12px',
                  background: 'var(--bg-card)',
                  border: '1px solid var(--border)',
                  color: 'var(--text-secondary)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  position: 'relative',
                  transition: 'all 0.2s ease'
                }}
              >
                <div style={{ width: '18px', height: '18px' }}>
                  <Icons.Bell />
                </div>
                {unreadCount > 0 && (
                  <div style={{
                    position: 'absolute',
                    top: '6px',
                    right: '6px',
                    width: '16px',
                    height: '16px',
                    borderRadius: '50%',
                    background: 'var(--primary)',
                    color: '#fff',
                    fontSize: '10px',
                    fontWeight: '700',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    border: '2px solid var(--bg-card)'
                  }}>
                    {unreadCount > 9 ? '9+' : unreadCount}
                  </div>
                )}
              </button>
            </div>
          </div>
          
          {/* Resultados da busca */}
          <div style={{
            overflow: 'hidden',
            transition: 'all 0.3s ease',
            maxHeight: showResults && searchResults.length > 0 ? '400px' : '0',
            opacity: showResults && searchResults.length > 0 ? 1 : 0,
            marginTop: showResults && searchResults.length > 0 ? '0' : '-20px'
          }}>
            <div style={{
              background: 'var(--bg-card)',
              borderRadius: '16px',
              border: '1px solid var(--border)',
              padding: '16px',
              boxShadow: '0 4px 20px rgba(0,0,0,0.1)'
            }}>
              <p style={{
                fontFamily: 'Outfit, sans-serif',
                fontSize: '12px',
                color: 'var(--text-muted)',
                marginBottom: '12px',
                textTransform: 'uppercase',
                letterSpacing: '0.5px'
              }}>
                {searchResults.length} resultado{searchResults.length !== 1 ? 's' : ''} encontrado{searchResults.length !== 1 ? 's' : ''}
              </p>
              
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(2, 1fr)',
                gap: '10px'
              }}>
                {searchResults.map((sheet, index) => (
                  <div
                    key={sheet.id}
                    onClick={() => {
                      setSelectedCategory(sheet.category.id);
                      setActiveTab('library');
                      setSearchQuery('');
                    }}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '12px',
                      padding: '12px',
                      background: 'var(--bg-secondary)',
                      borderRadius: '12px',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease',
                      animation: `fadeSlideIn 0.3s ease ${index * 0.05}s both`
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.transform = 'translateX(4px)'}
                    onMouseLeave={(e) => e.currentTarget.style.transform = 'translateX(0)'}
                  >
                    <div style={{
                      width: '44px',
                      height: '44px',
                      borderRadius: '10px',
                      background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                      border: '1px solid rgba(212, 175, 55, 0.2)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      <CategoryIcon categoryId={sheet.category.id} size={20} color="#D4AF37" />
                    </div>
                    
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <p style={{
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '14px',
                        fontWeight: '600',
                        color: 'var(--text-primary)',
                        whiteSpace: 'nowrap',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis'
                      }}>
                        {sheet.title}
                      </p>
                      <p style={{
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '12px',
                        color: 'var(--text-muted)'
                      }}>
                        {sheet.composer} • {sheet.category.name}
                      </p>
                    </div>
                    
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        toggleFavorite(sheet.id);
                      }}
                      style={{
                        background: favorites.includes(sheet.id) ? 'rgba(232,90,79,0.1)' : 'transparent',
                        border: 'none',
                        borderRadius: '8px',
                        width: '32px',
                        height: '32px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        cursor: 'pointer',
                        color: favorites.includes(sheet.id) ? 'var(--primary)' : 'var(--text-muted)',
                        transition: 'all 0.2s ease'
                      }}
                    >
                      <div style={{ width: '16px', height: '16px' }}>
                        <Icons.Heart filled={favorites.includes(sheet.id)} />
                      </div>
                    </button>
                  </div>
                ))}
              </div>
              
              {searchQuery && searchResults.length === 0 && (
                <div style={{
                  textAlign: 'center',
                  padding: '20px',
                  color: 'var(--text-muted)'
                }}>
                  <p style={{ fontFamily: 'Outfit, sans-serif', fontSize: '14px' }}>
                    Nenhuma partitura encontrada para "{searchQuery}"
                  </p>
                </div>
              )}
            </div>
          </div>
        </header>
      );
    };

    // Desktop Layout Wrapper
    const DesktopLayout = ({ children, activeTab, onTabChange }) => {
      const [isDesktop, setIsDesktop] = React.useState(window.innerWidth >= 1024);
      const { sidebarCollapsed } = useApp();
      
      React.useEffect(() => {
        const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      if (!isDesktop) {
        return children;
      }
      
      return (
        <div className="desktop-layout">
          <DesktopSidebar activeTab={activeTab} onTabChange={onTabChange} />
          <main className="desktop-main" style={{
            marginLeft: sidebarCollapsed ? '72px' : '260px',
            width: sidebarCollapsed ? 'calc(100% - 72px)' : 'calc(100% - 260px)',
            transition: 'all 0.3s ease'
          }}>
            <DesktopHeader />
            {children}
          </main>
        </div>
      );
    };

    // Desktop Sidebar
    const DesktopSidebar = ({ activeTab, onTabChange }) => {
      const { selectedCategory, setSelectedCategory, selectedComposer, setSelectedComposer, sidebarCollapsed, setSidebarCollapsed, sheets } = useApp();
      const [genresExpanded, setGenresExpanded] = React.useState(true);
      const [composersExpanded, setComposersExpanded] = React.useState(true);
      
      // Extrair compositores únicos das partituras (filtrando vazios)
      const composers = React.useMemo(() => {
        const composerSet = new Set(sheets.map(s => s.composer).filter(c => c && c.trim()));
        return Array.from(composerSet).sort();
      }, [sheets]);
      
      const navItems = [
        { id: 'home', icon: Icons.Home, label: 'Início' },
        { id: 'favorites', icon: Icons.Heart, label: 'Favoritos' }
      ];
      
      // Item de perfil separado para ficar no final
      const profileItem = { id: 'profile', icon: Icons.User, label: 'Perfil' };
      
      const sidebarContentRef = React.useRef(null);
      
      // Bloqueia scroll da página quando mouse está na sidebar
      const handleWheel = React.useCallback((e) => {
        const content = sidebarContentRef.current;
        if (!content) return;
        
        const { scrollTop, scrollHeight, clientHeight } = content;
        const hasScroll = scrollHeight > clientHeight;
        const atTop = scrollTop === 0;
        const atBottom = scrollTop + clientHeight >= scrollHeight - 1;
        
        // Se não há scroll ou está nos limites, bloqueia propagação
        if (!hasScroll || (e.deltaY < 0 && atTop) || (e.deltaY > 0 && atBottom)) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, []);
      
      // Adiciona event listener com passive: false para poder usar preventDefault
      React.useEffect(() => {
        const sidebar = document.querySelector('.desktop-sidebar');
        if (sidebar) {
          sidebar.addEventListener('wheel', handleWheel, { passive: false });
          return () => sidebar.removeEventListener('wheel', handleWheel);
        }
      }, [handleWheel]);
      
      return (
        <aside 
          className="desktop-sidebar" 
          style={{
            width: sidebarCollapsed ? '72px' : '260px',
            minWidth: sidebarCollapsed ? '72px' : '260px',
            transition: 'all 0.3s ease'
          }}
        >
          {/* Toggle Button - na borda direita da sidebar */}
          <button
            onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
            style={{
              position: 'absolute',
              top: '24px',
              right: '-14px',
              width: '28px',
              height: '28px',
              borderRadius: '50%',
              background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
              border: '2px solid #D4AF37',
              color: '#F4E4BC',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              transition: 'all 0.2s ease',
              zIndex: 110,
              boxShadow: '0 2px 8px rgba(0,0,0,0.3)'
            }}
            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.1)'}
            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
          >
            <div style={{ width: '14px', height: '14px' }}>
              {sidebarCollapsed ? <Icons.ChevronRight /> : <Icons.ChevronLeft />}
            </div>
          </button>
          
          {/* Conteúdo scrollável da sidebar */}
          <div ref={sidebarContentRef} className="desktop-sidebar-content">
          
          {/* Logo */}
          <div style={{ padding: sidebarCollapsed ? '0 12px' : '0 20px', marginBottom: '32px', marginTop: '8px' }}>
            {sidebarCollapsed ? (
              <div style={{ 
                textAlign: 'center', 
                width: '40px',
                height: '40px',
                margin: '0 auto',
                background: 'rgba(244, 228, 188, 0.15)',
                borderRadius: '50%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                border: '2px solid rgba(244, 228, 188, 0.3)',
                overflow: 'hidden',
                padding: '4px'
              }}>
                <img 
                  src="/assets/images/ui/brasao-256x256.png" 
                  alt="Brasão"
                  style={{
                    width: '100%',
                    height: '100%',
                    objectFit: 'contain'
                  }}
                />
              </div>
            ) : (
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                {/* Logo da filarmônica */}
                <div style={{ 
                  width: '48px',
                  height: '48px',
                  borderRadius: '50%',
                  background: 'rgba(244, 228, 188, 0.15)',
                  border: '2px solid rgba(244, 228, 188, 0.3)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0,
                  overflow: 'hidden',
                  padding: '5px'
                }}>
                  <img 
                    src="/assets/images/ui/brasao-256x256.png" 
                    alt="Brasão"
                    style={{
                      width: '100%',
                      height: '100%',
                      objectFit: 'contain'
                    }}
                  />
                </div>
                <div>
                  <h1 style={{ 
                    fontFamily: 'Outfit, sans-serif', 
                    fontSize: '15px', 
                    fontWeight: '700',
                    color: '#F4E4BC',
                    marginBottom: '1px',
                    lineHeight: '1.2'
                  }}>
                    S.F. 25 de Março
                  </h1>
                  <p style={{ fontFamily: 'Outfit, sans-serif', fontSize: '10px', color: 'rgba(255,255,255,0.5)', marginBottom: '4px' }}>Feira de Santana - BA</p>
                  <p style={{ 
                    fontFamily: 'Outfit, sans-serif', 
                    fontSize: '9px', 
                    fontWeight: '600',
                    color: '#D4AF37',
                    letterSpacing: '1.5px',
                    textTransform: 'uppercase'
                  }}>Acervo Digital</p>
                </div>
              </div>
            )}
          </div>
          
          {/* Navegação Principal */}
          <nav style={{ padding: '0 12px', marginBottom: '20px' }}>
            {!sidebarCollapsed && (
              <p style={{ 
                fontFamily: 'Outfit, sans-serif',
                fontSize: '10px', 
                fontWeight: '600', 
                color: 'rgba(255,255,255,0.4)', 
                textTransform: 'uppercase',
                letterSpacing: '0.5px',
                padding: '0 12px',
                marginBottom: '8px'
              }}>Menu</p>
            )}
            {navItems.map(item => {
              const isActive = activeTab === item.id;
              return (
                <button
                  key={item.id}
                  onClick={() => onTabChange(item.id)}
                  title={sidebarCollapsed ? item.label : ''}
                  style={{
                    width: '100%',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: sidebarCollapsed ? 'center' : 'flex-start',
                    gap: '12px',
                    padding: sidebarCollapsed ? '11px' : '11px 12px',
                    background: isActive ? 'rgba(255,255,255,0.2)' : 'transparent',
                    border: 'none',
                    borderRadius: '10px',
                    color: isActive ? '#fff' : 'rgba(255,255,255,0.7)',
                    cursor: 'pointer',
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '14px',
                    fontWeight: isActive ? '600' : '500',
                    transition: 'all 0.2s ease',
                    marginBottom: '2px'
                  }}
                >
                  <div style={{ width: '18px', height: '18px', flexShrink: 0 }}>
                    <item.icon filled={isActive} />
                  </div>
                  {!sidebarCollapsed && item.label}
                </button>
              );
            })}
          </nav>
          
          {/* Container para Gêneros e Compositores */}
          <div style={{ padding: '0 12px' }}>
            
            {/* Seção Gêneros - Top 4 por popularidade */}
            {!sidebarCollapsed && (
              <div style={{ 
                marginBottom: '12px',
                background: 'rgba(0,0,0,0.2)',
                borderRadius: '12px',
                padding: '12px'
              }}>
                <button
                  onClick={() => { setSelectedCategory(null); setSelectedComposer(null); onTabChange('genres'); }}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    width: '100%',
                    padding: '4px 4px 8px 4px',
                    background: 'transparent',
                    border: 'none',
                    cursor: 'pointer'
                  }}
                >
                  <span style={{ 
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '10px', 
                    fontWeight: '600', 
                    color: 'rgba(244, 228, 188, 0.6)', 
                    textTransform: 'uppercase',
                    letterSpacing: '1.5px',
                    transition: 'color 0.2s'
                  }}
                  onMouseEnter={(e) => e.target.style.color = '#D4AF37'}
                  onMouseLeave={(e) => e.target.style.color = 'rgba(244, 228, 188, 0.6)'}
                  >Gêneros</span>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(244, 228, 188, 0.4)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </button>
                
                {/* Lista de Gêneros - Top 4 */}
                <div>
                  {(() => {
                    // Ordenar categorias por quantidade de partituras
                    const categoriesWithCount = CATEGORIES.map(cat => ({
                      ...cat,
                      count: sheets.filter(s => s.category === cat.id).length
                    })).sort((a, b) => b.count - a.count).slice(0, 4);
                    
                    return categoriesWithCount.map(cat => {
                      const isActive = selectedCategory === cat.id;
                      return (
                        <button
                          key={cat.id}
                          onClick={() => { setSelectedCategory(cat.id); setSelectedComposer(null); onTabChange('library'); }}
                          style={{
                            width: '100%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            padding: '10px 12px',
                            paddingLeft: '14px',
                            background: isActive ? 'rgba(212, 175, 55, 0.15)' : 'transparent',
                            border: 'none',
                            borderRadius: '8px',
                            color: isActive ? '#D4AF37' : 'rgba(244, 228, 188, 0.85)',
                            cursor: 'pointer',
                            fontFamily: 'Outfit, sans-serif',
                            fontSize: '14px',
                            fontWeight: '500',
                            transition: 'all 0.2s ease',
                            marginBottom: '2px',
                            position: 'relative'
                          }}
                          onMouseEnter={(e) => {
                            if (!isActive) {
                              e.currentTarget.style.background = 'rgba(212, 175, 55, 0.1)';
                              e.currentTarget.style.color = '#F4E4BC';
                            }
                            const bar = e.currentTarget.querySelector('.sidebar-bar');
                            if (bar) bar.style.height = isActive ? '24px' : '16px';
                          }}
                          onMouseLeave={(e) => {
                            if (!isActive) {
                              e.currentTarget.style.background = 'transparent';
                              e.currentTarget.style.color = 'rgba(244, 228, 188, 0.85)';
                            }
                            const bar = e.currentTarget.querySelector('.sidebar-bar');
                            if (bar) bar.style.height = isActive ? '24px' : '0px';
                          }}
                        >
                          <div 
                            className="sidebar-bar"
                            style={{
                              position: 'absolute',
                              left: '0',
                              top: '50%',
                              transform: 'translateY(-50%)',
                              width: '3px',
                              height: isActive ? '24px' : '0px',
                              background: '#D4AF37',
                              borderRadius: '2px',
                              transition: 'height 0.2s ease'
                            }}
                          />
                          <span>{cat.name}</span>
                          <span style={{ fontSize: '11px', opacity: 0.5 }}>{cat.count}</span>
                        </button>
                      );
                    });
                  })()}
                  
                  {/* Ver todos */}
                  <button
                    onClick={() => { setSelectedCategory(null); setSelectedComposer(null); onTabChange('genres'); }}
                    style={{
                      width: '100%',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      padding: '10px 12px',
                      background: 'transparent',
                      border: 'none',
                      borderRadius: '8px',
                      color: '#D4AF37',
                      cursor: 'pointer',
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '13px',
                      fontWeight: '500',
                      transition: 'all 0.2s ease',
                      marginTop: '4px'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(212, 175, 55, 0.1)'}
                    onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                  >
                    Ver todos
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <polyline points="9 18 15 12 9 6"/>
                    </svg>
                  </button>
                </div>
              </div>
            )}
            
            {/* Seção Compositores - Top 3 por importância */}
            {!sidebarCollapsed && (
              <div style={{ 
                marginBottom: '12px',
                background: 'rgba(0,0,0,0.2)',
                borderRadius: '12px',
                padding: '12px'
              }}>
                <button
                  onClick={() => { setSelectedCategory(null); setSelectedComposer(null); onTabChange('composers'); }}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    width: '100%',
                    padding: '4px 4px 8px 4px',
                    background: 'transparent',
                    border: 'none',
                    cursor: 'pointer'
                  }}
                >
                  <span style={{ 
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '10px', 
                    fontWeight: '600', 
                    color: 'rgba(244, 228, 188, 0.6)', 
                    textTransform: 'uppercase',
                    letterSpacing: '1.5px',
                    transition: 'color 0.2s'
                  }}
                  onMouseEnter={(e) => e.target.style.color = '#D4AF37'}
                  onMouseLeave={(e) => e.target.style.color = 'rgba(244, 228, 188, 0.6)'}
                  >Compositores</span>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="rgba(244, 228, 188, 0.4)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </button>
                
                {/* Lista de Compositores - Top 3 por importância */}
                <div>
                  {(() => {
                    // Compositores prioritários (ordem de importância)
                    const priorityComposers = ['Estevam Moura', 'Tertuliano Santos', 'Amando Nobre', 'Heráclio Guerreiro'];
                    
                    // Filtrar apenas os que existem no acervo
                    const topComposers = priorityComposers
                      .filter(name => composers.includes(name))
                      .slice(0, 3);
                    
                    // Se não tiver os prioritários, usa os que tem mais partituras
                    let displayComposers = topComposers;
                    if (topComposers.length === 0) {
                      displayComposers = composers
                        .map(comp => ({ name: comp, count: sheets.filter(s => s.composer === comp).length }))
                        .sort((a, b) => b.count - a.count)
                        .slice(0, 3)
                        .map(c => c.name);
                    }
                    
                    return displayComposers.map(compName => (
                      <button
                        key={compName}
                        onClick={() => { setSelectedComposer(compName); setSelectedCategory(null); onTabChange('library'); }}
                        style={{
                          width: '100%',
                          display: 'flex',
                          alignItems: 'center',
                          padding: '10px 12px',
                          paddingLeft: '14px',
                          background: selectedComposer === compName ? 'rgba(212, 175, 55, 0.15)' : 'transparent',
                          border: 'none',
                          borderRadius: '8px',
                          color: selectedComposer === compName ? '#D4AF37' : 'rgba(244, 228, 188, 0.85)',
                          cursor: 'pointer',
                          fontFamily: 'Outfit, sans-serif',
                          fontSize: '13px',
                          fontWeight: '500',
                          transition: 'all 0.2s ease',
                          marginBottom: '2px',
                          textAlign: 'left',
                          position: 'relative'
                        }}
                        onMouseEnter={(e) => {
                          if (selectedComposer !== compName) {
                            e.currentTarget.style.background = 'rgba(212, 175, 55, 0.1)';
                            e.currentTarget.style.color = '#F4E4BC';
                          }
                          const bar = e.currentTarget.querySelector('.sidebar-bar');
                          if (bar) bar.style.height = selectedComposer === compName ? '24px' : '16px';
                        }}
                        onMouseLeave={(e) => {
                          if (selectedComposer !== compName) {
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.style.color = 'rgba(244, 228, 188, 0.85)';
                          }
                          const bar = e.currentTarget.querySelector('.sidebar-bar');
                          if (bar) bar.style.height = selectedComposer === compName ? '24px' : '0px';
                        }}
                      >
                        <div 
                          className="sidebar-bar"
                          style={{
                            position: 'absolute',
                            left: '0',
                            top: '50%',
                            transform: 'translateY(-50%)',
                            width: '3px',
                            height: selectedComposer === compName ? '24px' : '0px',
                            background: '#D4AF37',
                            borderRadius: '2px',
                            transition: 'height 0.2s ease'
                          }}
                        />
                        <span style={{ 
                          overflow: 'hidden', 
                          textOverflow: 'ellipsis', 
                          whiteSpace: 'nowrap'
                        }}>{compName}</span>
                      </button>
                    ));
                  })()}
                  
                  {/* Ver todos */}
                  <button
                    onClick={() => { setSelectedCategory(null); setSelectedComposer(null); onTabChange('composers'); }}
                    style={{
                      width: '100%',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      padding: '10px 12px',
                      background: 'transparent',
                      border: 'none',
                      borderRadius: '8px',
                      color: '#D4AF37',
                      cursor: 'pointer',
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '13px',
                      fontWeight: '500',
                      transition: 'all 0.2s ease',
                      marginTop: '4px'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(212, 175, 55, 0.1)'}
                    onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                  >
                    Ver todos
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <polyline points="9 18 15 12 9 6"/>
                    </svg>
                  </button>
                </div>
              </div>
            )}
          </div>
          </div>
          
          {/* Perfil - Fixo no final da sidebar */}
          <div style={{ 
            padding: '12px',
            borderTop: '1px solid rgba(255,255,255,0.1)',
            marginTop: 'auto'
          }}>
            <button
              onClick={() => onTabChange(profileItem.id)}
              title={sidebarCollapsed ? profileItem.label : ''}
              style={{
                width: '100%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: sidebarCollapsed ? 'center' : 'flex-start',
                gap: '12px',
                padding: sidebarCollapsed ? '11px' : '11px 12px',
                background: activeTab === 'profile' ? 'rgba(255,255,255,0.2)' : 'transparent',
                border: 'none',
                borderRadius: '10px',
                color: activeTab === 'profile' ? '#fff' : 'rgba(255,255,255,0.7)',
                cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif',
                fontSize: '14px',
                fontWeight: activeTab === 'profile' ? '600' : '500',
                transition: 'all 0.2s ease'
              }}
            >
              <div style={{ width: '18px', height: '18px', flexShrink: 0 }}>
                <Icons.User filled={activeTab === 'profile'} />
              </div>
              {!sidebarCollapsed && profileItem.label}
            </button>
          </div>
        </aside>
      );
    };

    // Bottom Nav
    const BottomNav = ({ activeTab, onTabChange }) => {
      const { theme, showNotifications } = useApp();
      const [keyboardOpen, setKeyboardOpen] = React.useState(false);
      
      // Detecta se é dispositivo touch
      const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const isHiding = showNotifications && isMobile;
      
      // Detecta quando o teclado abre/fecha
      React.useEffect(() => {
        if (!isMobile) return;
        
        const initialHeight = window.innerHeight;
        
        const handleResize = () => {
          // Se a altura diminuiu significativamente, o teclado provavelmente abriu
          const heightDiff = initialHeight - window.visualViewport?.height;
          setKeyboardOpen(heightDiff > 150);
        };
        
        // Usar visualViewport se disponível (mais preciso)
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', handleResize);
          return () => window.visualViewport.removeEventListener('resize', handleResize);
        } else {
          window.addEventListener('resize', handleResize);
          return () => window.removeEventListener('resize', handleResize);
        }
      }, [isMobile]);
      
      const tabs = [
        { id: 'home', icon: Icons.Home, label: 'Início' },
        { id: 'library', icon: Icons.Folder, label: 'Acervo' },
        { id: 'search', icon: Icons.Search, label: 'Buscar', isCenter: true },
        { id: 'favorites', icon: Icons.Heart, label: 'Favoritos' },
        { id: 'profile', icon: Icons.User, label: 'Perfil' }
      ];
      
      const isDark = theme === 'dark';
      const shouldHide = isHiding || keyboardOpen;
      
      return (
        <nav className="mobile-only" style={{
          position: 'fixed', 
          bottom: '16px', 
          left: '50%', 
          transform: shouldHide ? 'translateX(-50%) translateY(100px)' : 'translateX(-50%) translateY(0)',
          opacity: shouldHide ? 0 : 1,
          background: isDark 
            ? 'rgba(72, 20, 21, 0.85)'
            : 'rgba(92, 26, 27, 0.88)',
          backdropFilter: 'blur(40px) saturate(180%)',
          WebkitBackdropFilter: 'blur(40px) saturate(180%)',
          display: 'flex', 
          justifyContent: 'space-around',
          alignItems: 'center',
          padding: '12px 8px',
          zIndex: 999,
          width: 'calc(100% - 32px)',
          maxWidth: '420px',
          borderRadius: '28px',
          boxShadow: '0 8px 32px rgba(0,0,0,0.25), inset 0 0.5px 0 rgba(255,255,255,0.1)',
          border: '1px solid rgba(255,255,255,0.08)',
          transition: 'transform 0.3s ease, opacity 0.3s ease',
          pointerEvents: shouldHide ? 'none' : 'auto'
        }}>
          {tabs.map(tab => {
            const isActive = activeTab === tab.id;
            
            if (tab.isCenter) {
              return (
                <button key={tab.id} style={{
                  display: 'flex', 
                  alignItems: 'center', 
                  justifyContent: 'center',
                  background: 'linear-gradient(145deg, #D4AF37 0%, #AA8C2C 100%)',
                  border: 'none',
                  color: '#3D1518',
                  cursor: 'pointer', 
                  width: '62px',
                  height: '62px',
                  borderRadius: '50%',
                  transition: 'all 0.2s ease',
                  boxShadow: '0 4px 20px rgba(212, 175, 55, 0.35)',
                  flexShrink: 0
                }} onClick={() => onTabChange(tab.id)}>
                  <div style={{ width: '28px', height: '28px' }}><tab.icon filled /></div>
                </button>
              );
            }
            
            return (
              <button key={tab.id} style={{
                display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px',
                background: 'none', border: 'none', 
                color: isActive ? '#F4E4BC' : 'rgba(255,255,255,0.7)',
                cursor: 'pointer', padding: '6px 10px', borderRadius: 'var(--radius-sm)', transition: 'all 0.2s ease',
                minWidth: '56px'
              }} onClick={() => onTabChange(tab.id)}>
                <div style={{ width: '22px', height: '22px' }}><tab.icon filled={isActive} /></div>
                <span style={{ fontSize: '11px', fontWeight: '700', fontFamily: 'Outfit, sans-serif', letterSpacing: '0.2px' }}>{tab.label}</span>
              </button>
            );
          })}
        </nav>
      );
    };

    // Modal
    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div style={{
          position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', backdropFilter: 'blur(4px)',
          display: 'flex', alignItems: 'flex-end', zIndex: 2000, animation: 'fadeIn 0.2s ease'
        }} onClick={onClose}>
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg) var(--radius-lg) 0 0',
            width: '100%', maxWidth: '430px', maxHeight: '85vh', overflow: 'auto',
            margin: '0 auto', animation: 'slideUp 0.3s ease'
          }} onClick={e => e.stopPropagation()}>
            <div style={{ width: '36px', height: '4px', background: 'var(--border)', borderRadius: '2px', margin: '10px auto' }} />
            <div style={{ padding: '0 20px 24px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h2 style={{ fontFamily: "Outfit, sans-serif", fontSize: '20px', fontWeight: '700' }}>{title}</h2>
                <IconButton icon={Icons.Close} onClick={onClose} />
              </div>
              {children}
            </div>
          </div>
        </div>
      );
    };

    // Search Bar - Componente reutilizável com design profissional
    const SearchBar = ({ value, onChange, placeholder, onClear }) => (
      <div style={{ padding: '0 20px', marginBottom: '20px' }}>
        <div className="search-bar">
          <svg className="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input 
            type="text" 
            placeholder={placeholder || "Buscar partituras..."} 
            value={value} 
            onChange={(e) => onChange(e.target.value)} 
          />
          {value && (
            <button className="clear-btn" onClick={() => onChange('')}>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          )}
        </div>
      </div>
    );

    // Home Screen
    const HomeScreen = () => {
      const { sheets, setActiveTab, setSelectedCategory, favorites, toggleFavorite, user } = useApp();
      const [atividades, setAtividades] = useState([]);
      const getCategoryCount = (catId) => sheets.filter(s => s.category === catId).length;
      const recentSheets = useMemo(() => [...sheets].sort((a, b) => (b.downloads || 0) - (a.downloads || 0)).slice(0, 6), [sheets]);
      
      // Pega o primeiro nome do usuário
      const firstName = user?.name?.split(' ')[0] || 'Músico';
      
      // Carrega atividades da API
      useEffect(() => {
        const loadAtividades = async () => {
          try {
            const data = await API.getMinhasAtividades();
            setAtividades(data || []);
          } catch (e) {
            console.log('Atividades não disponíveis');
          }
        };
        loadAtividades();
      }, []);
      
      // Formata tempo relativo
      const formatTimeAgo = (dateString) => {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'agora mesmo';
        if (diffMins < 60) return `${diffMins} min atrás`;
        if (diffHours < 24) return `${diffHours}h atrás`;
        if (diffDays === 1) return 'ontem';
        if (diffDays < 7) return `${diffDays} dias atrás`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} semana(s) atrás`;
        return `${Math.floor(diffDays / 30)} mês(es) atrás`;
      };
      
      // Mapeia tipo para cor e texto
      const getAtividadeInfo = (tipo) => {
        const map = {
          'nova_partitura': { action: 'Nova partitura adicionada', color: '#43B97F' },
          'download': { action: 'Partitura baixada', color: '#5B8DEF' },
          'favorito': { action: 'Favorito adicionado', color: '#E54D87' }
        };
        return map[tipo] || { action: tipo, color: '#999' };
      };
      
      return (
        <div style={{ width: '100%', overflow: 'visible' }}>
          <HomeHeader 
            userName={user?.name || 'Visitante'} 
            instrument={user?.instrument || 'Músico'} 
            actions={<HeaderActions />} 
          />
          
          <div style={{ paddingTop: '8px', overflow: 'visible' }}>
            <FeaturedSheets sheets={sheets} favorites={favorites} onToggleFavorite={toggleFavorite} />
          </div>
          
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0 20px', marginBottom: '16px' }}>
            <h2 style={{ fontFamily: "Outfit, sans-serif", fontSize: '18px', fontWeight: '700' }}>Gêneros Musicais</h2>
            <button style={{ background: 'none', border: 'none', color: 'var(--primary)', fontSize: '14px', fontWeight: '500', cursor: 'pointer', fontFamily: 'Outfit, sans-serif' }}
              onClick={() => setActiveTab('library')}>Ver Todos</button>
          </div>
          
          <div style={{ padding: '0 20px', marginBottom: '24px' }}>
            <div className="categories-grid" style={{ 
              display: 'grid', 
              gridTemplateColumns: 'repeat(2, minmax(0, 1fr))', 
              gap: '12px',
              width: '100%'
            }}>
              {CATEGORIES.slice(0, 4).map((cat, i) => (
                <CategoryCard key={cat.id} category={cat} count={getCategoryCount(cat.id)} index={i}
                  onClick={() => { setSelectedCategory(cat.id); setActiveTab('library'); }} />
              ))}
            </div>
          </div>
          
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0 20px', marginBottom: '12px' }}>
            <h2 style={{ fontFamily: "Outfit, sans-serif", fontSize: '18px', fontWeight: '700' }}>Partituras Populares</h2>
            <button style={{ background: 'none', border: 'none', color: 'var(--primary)', fontSize: '14px', fontWeight: '500', cursor: 'pointer', fontFamily: 'Outfit, sans-serif' }}
              onClick={() => setActiveTab('library')}>Ver Todas</button>
          </div>
          
          <div className="sheets-grid" style={{ padding: '0 20px' }}>
            {recentSheets.map(sheet => (
              <FileCard 
                key={sheet.id} 
                sheet={sheet} 
                category={CATEGORIES.find(c => c.id === sheet.category)}
                isFavorite={favorites.includes(sheet.id)}
                onToggleFavorite={() => toggleFavorite(sheet.id)}
              />
            ))}
          </div>
          
          {/* Seção de Estatísticas */}
          <div style={{ padding: '32px 20px' }}>
            <h2 style={{ fontFamily: "Outfit, sans-serif", fontSize: '18px', fontWeight: '700', marginBottom: '16px' }}>
              Estatísticas do Acervo
            </h2>
            <div style={{ 
              display: 'grid', 
              gridTemplateColumns: 'repeat(2, 1fr)', 
              gap: '12px' 
            }}>
              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                padding: '20px',
                textAlign: 'center'
              }}>
                <p style={{ fontSize: '32px', fontWeight: '800', color: 'var(--primary)', fontFamily: 'Outfit, sans-serif' }}>
                  {sheets.length}
                </p>
                <p style={{ fontSize: '13px', color: 'var(--text-muted)', fontFamily: 'Outfit, sans-serif' }}>
                  Partituras
                </p>
              </div>
              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                padding: '20px',
                textAlign: 'center'
              }}>
                <p style={{ fontSize: '32px', fontWeight: '800', color: '#D4AF37', fontFamily: 'Outfit, sans-serif' }}>
                  {favorites.length}
                </p>
                <p style={{ fontSize: '13px', color: 'var(--text-muted)', fontFamily: 'Outfit, sans-serif' }}>
                  Favoritos
                </p>
              </div>
              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                padding: '20px',
                textAlign: 'center'
              }}>
                <p style={{ fontSize: '32px', fontWeight: '800', color: '#43B97F', fontFamily: 'Outfit, sans-serif' }}>
                  {CATEGORIES.length}
                </p>
                <p style={{ fontSize: '13px', color: 'var(--text-muted)', fontFamily: 'Outfit, sans-serif' }}>
                  Gêneros
                </p>
              </div>
              <div style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                padding: '20px',
                textAlign: 'center'
              }}>
                <p style={{ fontSize: '32px', fontWeight: '800', color: '#5B8DEF', fontFamily: 'Outfit, sans-serif' }}>
                  {sheets.reduce((acc, s) => acc + (s.downloads || 0), 0)}
                </p>
                <p style={{ fontSize: '13px', color: 'var(--text-muted)', fontFamily: 'Outfit, sans-serif' }}>
                  Downloads
                </p>
              </div>
            </div>
          </div>
          
          {/* Seção de Atividade Recente */}
          <div style={{ padding: '0 20px 32px' }}>
            <h2 style={{ fontFamily: "Outfit, sans-serif", fontSize: '18px', fontWeight: '700', marginBottom: '16px' }}>
              Atividade Recente
            </h2>
            <div style={{
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '16px',
              overflow: 'hidden'
            }}>
              {atividades.length === 0 ? (
                <div style={{ padding: '24px', textAlign: 'center', color: 'var(--text-muted)', fontSize: '14px' }}>
                  Nenhuma atividade recente
                </div>
              ) : (
                atividades.slice(0, 5).map((atividade, index, arr) => {
                  const info = getAtividadeInfo(atividade.tipo);
                  return (
                    <div key={atividade.id || index} style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '14px',
                      padding: '14px 16px',
                      borderBottom: index < arr.length - 1 ? '1px solid var(--border)' : 'none'
                    }}>
                      <div style={{ 
                        width: '8px', 
                        height: '8px', 
                        borderRadius: '50%', 
                        background: info.color,
                        flexShrink: 0
                      }} />
                      <div style={{ flex: 1 }}>
                        <p style={{ fontSize: '14px', fontFamily: 'Outfit, sans-serif', color: 'var(--text-primary)', marginBottom: '2px' }}>
                          {info.action}
                        </p>
                        <p style={{ fontSize: '12px', fontFamily: 'Outfit, sans-serif', color: 'var(--text-muted)' }}>
                          {atividade.titulo} {atividade.detalhes && `• ${atividade.detalhes}`} • {formatTimeAgo(atividade.criado_em)}
                        </p>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>
          
          {/* Footer informativo */}
          <div style={{ 
            padding: '24px 20px 120px', 
            textAlign: 'center',
            borderTop: '1px solid var(--border)',
            margin: '0 20px'
          }}>
            <p style={{ fontSize: '13px', color: 'var(--text-muted)', fontFamily: 'Outfit, sans-serif', marginBottom: '8px' }}>
              Filarmônica 25 de Março
            </p>
            <p style={{ fontSize: '12px', color: 'var(--text-muted)', fontFamily: 'Outfit, sans-serif', opacity: 0.7 }}>
              Acervo Digital de Partituras • Versão 2.0
            </p>
          </div>
        </div>
      );
    };

    // Library Screen
    const LibraryScreen = () => {
      const { sheets, selectedCategory, setSelectedCategory, selectedComposer, setSelectedComposer, user, addSheet, showToast, favorites, toggleFavorite, setActiveTab } = useApp();
      const [showUploadModal, setShowUploadModal] = useState(false);
      
      const filteredSheets = useMemo(() => {
        let result = sheets;
        if (selectedCategory) {
          result = result.filter(s => s.category === selectedCategory);
        }
        if (selectedComposer) {
          result = result.filter(s => s.composer === selectedComposer);
        }
        return result;
      }, [sheets, selectedCategory, selectedComposer]);
      
      const currentCategory = CATEGORIES.find(c => c.id === selectedCategory);
      const getCategoryCount = (catId) => sheets.filter(s => s.category === catId).length;
      
      const handleBack = () => {
        if (selectedComposer) {
          setSelectedComposer(null);
          setActiveTab('composers'); // Volta para tela de compositores
        } else if (selectedCategory) {
          setSelectedCategory(null);
          setActiveTab('genres'); // Volta para tela de gêneros
        }
      };
      
      const getTitle = () => {
        if (selectedComposer) return selectedComposer;
        if (currentCategory) return currentCategory.name;
        return "Acervo";
      };
      
      const getSubtitle = () => {
        if (selectedComposer || selectedCategory) return `${filteredSheets.length} partituras`;
        return "Todas as categorias";
      };
      
      return (
        <div>
          <Header title={getTitle()} subtitle={getSubtitle()}
            showBack={!!(selectedCategory || selectedComposer)} onBack={handleBack}
            actions={user?.isAdmin && <IconButton icon={Icons.Plus} primary onClick={() => setShowUploadModal(true)} />} />
          {!selectedCategory && !selectedComposer ? (
            <div style={{ padding: '0 20px' }}>
              <div className="categories-grid" style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(2, minmax(0, 1fr))', 
                gap: '12px',
                width: '100%'
              }}>
                {CATEGORIES.map((cat, i) => (
                  <CategoryCard key={cat.id} category={cat} count={getCategoryCount(cat.id)} index={i} onClick={() => setSelectedCategory(cat.id)} />
                ))}
              </div>
            </div>
          ) : filteredSheets.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '60px 40px', color: 'var(--text-muted)' }}>
              <div style={{ width: '64px', height: '64px', margin: '0 auto 16px', opacity: 0.3 }}><Icons.Folder /></div>
              <p>Nenhuma partitura encontrada</p>
            </div>
          ) : (
            <div className="files-grid">
              {filteredSheets.map(sheet => (
                <FileCard 
                  key={sheet.id} 
                  sheet={sheet} 
                  category={currentCategory}
                  isFavorite={favorites.includes(sheet.id)}
                  onToggleFavorite={() => toggleFavorite(sheet.id)}
                />
              ))}
            </div>
          )}
          <UploadModal isOpen={showUploadModal} onClose={() => setShowUploadModal(false)} />
        </div>
      );
    };

    // Search Screen
    const SearchScreen = () => {
      const { sheets, favorites, toggleFavorite, setActiveTab, setSelectedCategory } = useApp();
      const [searchQuery, setSearchQuery] = React.useState('');
      
      // Função de distância Levenshtein para busca fuzzy
      const levenshtein = (a, b) => {
        const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
        for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
        for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
        for (let j = 1; j <= b.length; j++) {
          for (let i = 1; i <= a.length; i++) {
            const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
              matrix[j][i - 1] + 1,
              matrix[j - 1][i] + 1,
              matrix[j - 1][i - 1] + indicator
            );
          }
        }
        return matrix[b.length][a.length];
      };
      
      // Busca fuzzy nos sheets
      const searchResults = React.useMemo(() => {
        if (!searchQuery.trim()) return [];
        
        const query = searchQuery.toLowerCase().trim();
        
        return sheets
          .map(sheet => {
            const titleLower = sheet.title.toLowerCase();
            const composerLower = sheet.composer.toLowerCase();
            const category = CATEGORIES.find(c => c.id === sheet.category);
            const categoryLower = category?.name.toLowerCase() || '';
            
            let score = 0;
            
            if (titleLower.startsWith(query)) score += 100;
            else if (titleLower.includes(query)) score += 50;
            
            if (composerLower.startsWith(query)) score += 80;
            else if (composerLower.includes(query)) score += 40;
            
            if (categoryLower.startsWith(query)) score += 60;
            else if (categoryLower.includes(query)) score += 30;
            
            const titleDist = levenshtein(query, titleLower.slice(0, query.length));
            const composerDist = levenshtein(query, composerLower.slice(0, query.length));
            
            if (titleDist <= 2) score += (20 - titleDist * 5);
            if (composerDist <= 2) score += (15 - composerDist * 5);
            
            return { ...sheet, score, category };
          })
          .filter(sheet => sheet.score > 0)
          .sort((a, b) => b.score - a.score);
      }, [searchQuery, sheets]);
      
      return (
        <div style={{ width: '100%' }}>
          <Header title="Buscar" subtitle="Encontre partituras" />
          
          {/* Barra de busca */}
          <div style={{ padding: '0 20px', marginBottom: '20px' }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              background: 'var(--bg-card)',
              border: '1px solid var(--border)',
              borderRadius: '14px',
              padding: '14px 18px',
              transition: 'all 0.2s ease',
              boxShadow: searchQuery ? '0 4px 12px rgba(0,0,0,0.08)' : 'none'
            }}>
              <div style={{ width: '20px', height: '20px', color: 'var(--text-muted)', flexShrink: 0 }}>
                <Icons.Search />
              </div>
              <input
                type="text"
                placeholder="Título, compositor ou gênero..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                autoFocus
                style={{
                  flex: 1,
                  border: 'none',
                  background: 'transparent',
                  outline: 'none',
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '15px',
                  color: 'var(--text-primary)'
                }}
              />
              {searchQuery && (
                <button
                  onClick={() => setSearchQuery('')}
                  style={{
                    background: 'var(--bg-secondary)',
                    border: 'none',
                    borderRadius: '50%',
                    width: '24px',
                    height: '24px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    color: 'var(--text-muted)',
                    fontSize: '14px',
                    flexShrink: 0
                  }}
                >
                  ✕
                </button>
              )}
            </div>
          </div>
          
          {/* Estado vazio */}
          {searchQuery.trim() === '' && (
            <div style={{ 
              textAlign: 'center', 
              padding: '40px 40px', 
              color: 'var(--text-muted)',
              animation: 'fadeIn 0.3s ease'
            }}>
              <div style={{ 
                width: '80px', 
                height: '80px', 
                margin: '0 auto 20px', 
                opacity: 0.2,
                color: 'var(--primary)'
              }}>
                <Icons.Search />
              </div>
              <p style={{ fontFamily: 'Outfit, sans-serif', fontSize: '15px', marginBottom: '8px' }}>
                Digite para buscar
              </p>
              <p style={{ fontFamily: 'Outfit, sans-serif', fontSize: '13px', opacity: 0.7 }}>
                Busque por título, compositor ou gênero
              </p>
            </div>
          )}
          
          {/* Sem resultados */}
          {searchQuery.trim() !== '' && searchResults.length === 0 && (
            <div style={{ 
              textAlign: 'center', 
              padding: '40px', 
              color: 'var(--text-muted)',
              animation: 'fadeIn 0.3s ease'
            }}>
              <p style={{ fontFamily: 'Outfit, sans-serif', fontSize: '15px' }}>
                Nenhum resultado para "<strong>{searchQuery}</strong>"
              </p>
              <p style={{ fontFamily: 'Outfit, sans-serif', fontSize: '13px', opacity: 0.7, marginTop: '8px' }}>
                Tente outro termo de busca
              </p>
            </div>
          )}
          
          {/* Resultados */}
          {searchResults.length > 0 && (
            <div style={{ animation: 'fadeIn 0.3s ease' }}>
              <p style={{ 
                padding: '0 20px 12px', 
                color: 'var(--text-muted)', 
                fontSize: '13px',
                fontFamily: 'Outfit, sans-serif'
              }}>
                {searchResults.length} resultado{searchResults.length !== 1 ? 's' : ''} encontrado{searchResults.length !== 1 ? 's' : ''}
              </p>
              
              <div style={{ padding: '0 20px' }}>
                {searchResults.map((sheet, index) => (
                  <div
                    key={sheet.id}
                    onClick={() => {
                      setSelectedCategory(sheet.category.id);
                      setActiveTab('library');
                    }}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '14px',
                      padding: '14px',
                      background: 'var(--bg-card)',
                      borderRadius: '14px',
                      marginBottom: '10px',
                      cursor: 'pointer',
                      border: '1px solid var(--border)',
                      transition: 'all 0.2s ease',
                      animation: `fadeSlideIn 0.3s ease ${index * 0.03}s both`
                    }}
                  >
                    <div style={{
                      width: '50px',
                      height: '50px',
                      borderRadius: '12px',
                      background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                      border: '1px solid rgba(212, 175, 55, 0.2)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      <CategoryIcon categoryId={sheet.category.id} size={22} color="#D4AF37" />
                    </div>
                    
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <p style={{
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '15px',
                        fontWeight: '600',
                        color: 'var(--text-primary)',
                        marginBottom: '3px',
                        whiteSpace: 'nowrap',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis'
                      }}>
                        {sheet.title}
                      </p>
                      <p style={{
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '13px',
                        color: 'var(--text-muted)'
                      }}>
                        {sheet.composer} • <span style={{ color: '#D4AF37' }}>{sheet.category.name}</span>
                      </p>
                    </div>
                    
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        toggleFavorite(sheet.id);
                      }}
                      style={{
                        background: favorites.includes(sheet.id) ? 'rgba(232,90,79,0.1)' : 'transparent',
                        border: 'none',
                        borderRadius: '10px',
                        width: '38px',
                        height: '38px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        cursor: 'pointer',
                        color: favorites.includes(sheet.id) ? 'var(--primary)' : 'var(--text-muted)',
                        transition: 'all 0.2s ease',
                        flexShrink: 0
                      }}
                    >
                      <div style={{ width: '18px', height: '18px' }}>
                        <Icons.Heart filled={favorites.includes(sheet.id)} />
                      </div>
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // Profile Screen
    const ProfileScreen = () => {
      const { user, setUser, showToast, theme, setTheme } = useApp();
      const [showLoginModal, setShowLoginModal] = useState(false);
      const [showChangePinModal, setShowChangePinModal] = useState(false);
      const [showAboutModal, setShowAboutModal] = useState(false);
      const [profilePhoto, setProfilePhoto] = useState(() => Storage.get(`profilePhoto_${user?.id}`, null));
      const [isEditingName, setIsEditingName] = useState(false);
      const [editedName, setEditedName] = useState(user?.name || '');
      const fileInputRef = React.useRef(null);
      
      // Componente Modal para Alterar PIN
      const ChangePinModal = ({ onClose }) => {
        const { showToast } = useApp();
        const [isLoading, setIsLoading] = useState(false);
        
        const [currentPin, setCurrentPin] = useState(['', '', '', '']);
        const [newPin, setNewPin] = useState(['', '', '', '']);
        const [confirmPin, setConfirmPin] = useState(['', '', '', '']);
        const [step, setStep] = useState(1); // 1: PIN atual, 2: Novo PIN, 3: Confirmar
        const [error, setError] = useState('');
        const [storedPin, setStoredPin] = useState('');
        
        // Refs estáveis usando useRef
        const currentPinRefs = React.useRef([React.createRef(), React.createRef(), React.createRef(), React.createRef()]).current;
        const newPinRefs = React.useRef([React.createRef(), React.createRef(), React.createRef(), React.createRef()]).current;
        const confirmPinRefs = React.useRef([React.createRef(), React.createRef(), React.createRef(), React.createRef()]).current;
        
        // Carrega PIN atual do storage (ou usa o token salvo)
        React.useEffect(() => {
          const authToken = Storage.get('authToken', '');
          if (authToken) {
            const [, pin] = authToken.split(':');
            setStoredPin(pin || '');
          }
        }, []);
        
        const handlePinInput = (index, value, pinArray, setPinArray, refs, onComplete) => {
          if (value && !/^\d$/.test(value)) return;
          
          const newPinArray = [...pinArray];
          newPinArray[index] = value;
          setPinArray(newPinArray);
          setError('');
          
          // Auto-pula para próximo campo
          if (value && index < 3) {
            setTimeout(() => refs[index + 1].current?.focus(), 10);
          }
          
          // Completa quando digitar o 4º dígito
          if (value && index === 3) {
            setTimeout(() => onComplete(newPinArray.join('')), 100);
          }
        };
        
        const handleKeyDown = (index, e, refs) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            refs[index - 1].current?.focus();
          }
        };
        
        const verifyCurrentPin = (pin) => {
          if (pin === storedPin) {
            setStep(2);
            setTimeout(() => newPinRefs[0].current?.focus(), 100);
          } else {
            setError('PIN atual incorreto');
            setCurrentPin(['', '', '', '']);
            currentPinRefs[0].current?.focus();
          }
        };
        
        const setNewPinValue = (pin) => {
          // Verifica se o novo PIN é igual ao atual
          if (pin === storedPin) {
            setError('O novo PIN não pode ser igual ao atual');
            setNewPin(['', '', '', '']);
            setTimeout(() => newPinRefs[0].current?.focus(), 100);
            return;
          }
          setStep(3);
          setTimeout(() => confirmPinRefs[0].current?.focus(), 100);
        };
        
        const confirmNewPin = async (pin) => {
          if (pin !== newPin.join('')) {
            setError('Os PINs não conferem');
            setConfirmPin(['', '', '', '']);
            confirmPinRefs[0].current?.focus();
            return;
          }
          
          setIsLoading(true);
          setError('');
          
          try {
            const result = await API.changePin(currentPin.join(''), pin);
            
            if (result.success) {
              // Atualiza o token local com o novo PIN
              Storage.set('authToken', result.token);
              showToast('PIN alterado com sucesso!');
              onClose();
            } else {
              setError(result.error || 'Erro ao alterar PIN');
              setConfirmPin(['', '', '', '']);
              confirmPinRefs[0].current?.focus();
            }
          } catch (err) {
            setError('Erro ao conectar com o servidor');
            setConfirmPin(['', '', '', '']);
            confirmPinRefs[0].current?.focus();
          } finally {
            setIsLoading(false);
          }
        };
        
        React.useEffect(() => {
          currentPinRefs[0].current?.focus();
        }, []);
        
        const PinInputGroup = ({ pin, setPin, refs, onComplete, label }) => (
          <div>
            <label style={{
              display: 'block',
              fontFamily: 'Outfit, sans-serif',
              fontSize: '13px',
              fontWeight: '600',
              color: 'var(--text-muted)',
              marginBottom: '12px',
              textAlign: 'center'
            }}>{label}</label>
            <div style={{ display: 'flex', justifyContent: 'center', gap: '10px' }}>
              {pin.map((digit, index) => (
                <input
                  key={index}
                  ref={refs[index]}
                  type="password"
                  inputMode="numeric"
                  maxLength={1}
                  value={digit}
                  onChange={e => handlePinInput(index, e.target.value, pin, setPin, refs, onComplete)}
                  onKeyDown={e => handleKeyDown(index, e, refs)}
                  style={{
                    width: '50px',
                    height: '50px',
                    borderRadius: '12px',
                    background: digit ? 'rgba(212, 175, 55, 0.15)' : 'var(--bg-card)',
                    border: digit ? '2px solid var(--primary)' : '1px solid var(--border)',
                    color: 'var(--text-primary)',
                    fontSize: '20px',
                    fontFamily: 'Outfit, sans-serif',
                    fontWeight: '700',
                    textAlign: 'center',
                    outline: 'none'
                  }}
                />
              ))}
            </div>
          </div>
        );
        
        return (
          <div style={{
            position: 'fixed',
            inset: 0,
            zIndex: 9999,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            background: 'rgba(0,0,0,0.6)',
            padding: '20px'
          }}>
            <div style={{
              background: 'var(--bg-primary)',
              borderRadius: '20px',
              padding: '32px',
              width: '100%',
              maxWidth: '360px',
              boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
            }}>
              {/* Header */}
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                <h3 style={{ fontFamily: 'Outfit, sans-serif', fontSize: '18px', fontWeight: '700' }}>
                  Alterar PIN
                </h3>
                <button onClick={onClose} style={{
                  background: 'none',
                  border: 'none',
                  color: 'var(--text-muted)',
                  cursor: 'pointer',
                  fontSize: '20px'
                }}>✕</button>
              </div>
              
              {/* Steps indicator */}
              <div style={{ display: 'flex', justifyContent: 'center', gap: '8px', marginBottom: '24px' }}>
                {[1, 2, 3].map(s => (
                  <div key={s} style={{
                    width: '8px',
                    height: '8px',
                    borderRadius: '50%',
                    background: step >= s ? 'var(--primary)' : 'var(--border)',
                    transition: 'background 0.3s'
                  }} />
                ))}
              </div>
              
              {/* Step content */}
              {step === 1 && (
                <PinInputGroup 
                  pin={currentPin} 
                  setPin={setCurrentPin} 
                  refs={currentPinRefs}
                  onComplete={verifyCurrentPin}
                  label="Digite seu PIN atual"
                />
              )}
              
              {step === 2 && (
                <PinInputGroup 
                  pin={newPin} 
                  setPin={setNewPin} 
                  refs={newPinRefs}
                  onComplete={setNewPinValue}
                  label="Digite o novo PIN"
                />
              )}
              
              {step === 3 && (
                <PinInputGroup 
                  pin={confirmPin} 
                  setPin={setConfirmPin} 
                  refs={confirmPinRefs}
                  onComplete={confirmNewPin}
                  label="Confirme o novo PIN"
                />
              )}
              
              {/* Error */}
              {error && (
                <div style={{
                  marginTop: '16px',
                  padding: '12px',
                  background: 'rgba(214, 69, 69, 0.1)',
                  borderRadius: '8px',
                  textAlign: 'center'
                }}>
                  <p style={{ fontFamily: 'Outfit, sans-serif', fontSize: '13px', color: '#D64545' }}>{error}</p>
                </div>
              )}
              
              {/* Cancel button */}
              <button
                onClick={onClose}
                style={{
                  width: '100%',
                  marginTop: '24px',
                  padding: '14px',
                  background: 'var(--bg-card)',
                  border: '1px solid var(--border)',
                  borderRadius: '10px',
                  color: 'var(--text-muted)',
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer'
                }}
              >
                Cancelar
              </button>
            </div>
          </div>
        );
      };
      
      // Atualiza foto do perfil quando usuário muda
      React.useEffect(() => {
        if (user?.id) {
          setProfilePhoto(Storage.get(`profilePhoto_${user.id}`, null));
          setEditedName(user.name);
        }
      }, [user?.id]);
      
      // Handler para upload de foto
      const handlePhotoUpload = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        if (file.size > 2 * 1024 * 1024) {
          showToast('Imagem muito grande (máx 2MB)');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const base64 = event.target.result;
          setProfilePhoto(base64);
          Storage.set(`profilePhoto_${user.id}`, base64);
          showToast('Foto atualizada!');
        };
        reader.readAsDataURL(file);
      };
      
      // Salvar nome editado
      const handleSaveName = () => {
        if (editedName.trim() && editedName !== user.name) {
          setUser({ ...user, name: editedName.trim() });
          showToast('Nome atualizado!');
        }
        setIsEditingName(false);
      };
      
      if (!user) {
        return (
          <div>
            <Header title="Perfil" />
            <div style={{ textAlign: 'center', padding: '60px 40px' }}>
              <div style={{
                width: '80px', height: '80px', borderRadius: '50%', background: 'var(--bg-card)',
                border: '1px solid var(--border)', display: 'flex', alignItems: 'center', justifyContent: 'center',
                margin: '0 auto 20px', color: 'var(--text-muted)'
              }}><div style={{ width: '32px', height: '32px' }}><Icons.User /></div></div>
              <h3 style={{ fontFamily: "Outfit, sans-serif", fontSize: '20px', fontWeight: '700', marginBottom: '8px' }}>Bem-vindo!</h3>
              <p style={{ color: 'var(--text-muted)', marginBottom: '24px', fontSize: '14px' }}>Faça login para acessar o acervo</p>
              <button className="btn-hover" style={{
                background: 'var(--primary)', color: '#fff', border: 'none', padding: '14px 32px',
                borderRadius: 'var(--radius-sm)', fontSize: '15px', fontWeight: '600', cursor: 'pointer'
              }} onClick={() => setShowLoginModal(true)}>Entrar</button>
            </div>
            <LoginModal isOpen={showLoginModal} onClose={() => setShowLoginModal(false)} />
          </div>
        );
      }
      
      const SettingItem = ({ icon, label, value, onClick, rightElement, danger }) => (
        <button 
          onClick={onClick}
          style={{
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            gap: '14px',
            padding: '16px',
            background: 'var(--bg-card)',
            border: '1px solid var(--border)',
            borderRadius: '12px',
            cursor: onClick ? 'pointer' : 'default',
            transition: 'all 0.2s ease',
            marginBottom: '8px'
          }}
          onMouseEnter={e => onClick && (e.currentTarget.style.background = 'var(--bg-hover)')}
          onMouseLeave={e => onClick && (e.currentTarget.style.background = 'var(--bg-card)')}
        >
          <div style={{
            width: '40px',
            height: '40px',
            borderRadius: '10px',
            background: danger ? 'rgba(214, 69, 69, 0.1)' : 'rgba(212, 175, 55, 0.1)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            flexShrink: 0
          }}>
            <div style={{ width: '20px', height: '20px', color: danger ? '#D64545' : 'var(--primary)' }}>
              {icon}
            </div>
          </div>
          <div style={{ flex: 1, textAlign: 'left' }}>
            <p style={{ 
              fontFamily: 'Outfit, sans-serif', 
              fontSize: '14px', 
              fontWeight: '500',
              color: danger ? '#D64545' : 'var(--text-primary)',
              marginBottom: value ? '2px' : 0
            }}>{label}</p>
            {value && (
              <p style={{ 
                fontFamily: 'Outfit, sans-serif', 
                fontSize: '12px', 
                color: 'var(--text-muted)'
              }}>{value}</p>
            )}
          </div>
          {rightElement}
          {onClick && !rightElement && (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" strokeWidth="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          )}
        </button>
      );
      
      return (
        <div>
          <Header title="Perfil" subtitle="Configurações da conta" />
          
          {/* Foto e Info Principal */}
          <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
            {/* Foto de Perfil */}
            <div style={{ position: 'relative', marginBottom: '16px' }}>
              <div style={{
                width: '100px', 
                height: '100px', 
                borderRadius: '50%', 
                background: profilePhoto ? `url(${profilePhoto}) center/cover` : 'var(--primary)',
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center',
                fontSize: '36px', 
                fontWeight: '700', 
                color: '#fff', 
                fontFamily: "Outfit, sans-serif",
                border: '3px solid var(--primary)',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
              }}>
                {!profilePhoto && user.name.charAt(0)}
              </div>
              
              {/* Botão de editar foto */}
              <button
                onClick={() => fileInputRef.current?.click()}
                style={{
                  position: 'absolute',
                  bottom: '0',
                  right: '0',
                  width: '32px',
                  height: '32px',
                  borderRadius: '50%',
                  background: 'var(--primary)',
                  border: '2px solid var(--bg-primary)',
                  color: '#fff',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                  <circle cx="12" cy="13" r="4"/>
                </svg>
              </button>
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*"
                onChange={handlePhotoUpload}
                style={{ display: 'none' }}
              />
            </div>
            
            {/* Nome */}
            {isEditingName ? (
              <div style={{ marginBottom: '4px' }}>
                <input
                  type="text"
                  value={editedName}
                  onChange={e => setEditedName(e.target.value)}
                  style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '22px',
                    fontWeight: '700',
                    textAlign: 'center',
                    background: 'var(--bg-card)',
                    border: '1px solid var(--primary)',
                    borderRadius: '8px',
                    padding: '4px 12px',
                    color: 'var(--text-primary)',
                    outline: 'none',
                    width: '200px'
                  }}
                  autoFocus
                  onKeyDown={e => e.key === 'Enter' && handleSaveName()}
                  onBlur={handleSaveName}
                />
              </div>
            ) : (
              <div 
                onClick={() => setIsEditingName(true)}
                style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', marginBottom: '4px' }}
              >
                <h2 style={{ fontFamily: "Outfit, sans-serif", fontSize: '22px', fontWeight: '700' }}>
                  {user.name}
                </h2>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" strokeWidth="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </div>
            )}
            
            <p style={{ color: 'var(--text-muted)', fontSize: '14px', marginBottom: '8px', textAlign: 'center' }}>{user.instrument}</p>
            
            {user.isAdmin && (
              <span style={{
                display: 'inline-block',
                background: 'rgba(212, 175, 55, 0.15)',
                color: '#D4AF37',
                fontSize: '11px',
                fontWeight: '600',
                padding: '4px 12px',
                borderRadius: '20px',
                textTransform: 'uppercase',
                letterSpacing: '0.5px'
              }}>Administrador</span>
            )}
          </div>
          
          {/* Configurações */}
          <div style={{ padding: '0 20px 20px' }}>
            {/* Seção: Conta */}
            <p style={{ 
              fontFamily: 'Outfit, sans-serif',
              fontSize: '12px',
              fontWeight: '600',
              color: 'var(--text-muted)',
              textTransform: 'uppercase',
              letterSpacing: '0.5px',
              marginBottom: '12px',
              paddingLeft: '4px'
            }}>Conta</p>
            
            <SettingItem
              icon={<Icons.User />}
              label="Informações Pessoais"
              value={user.instrument}
              onClick={() => showToast('Em breve!')}
            />
            
            <SettingItem
              icon={<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>}
              label="Alterar PIN"
              onClick={() => setShowChangePinModal(true)}
            />
            
            {/* Seção: Contato */}
            <p style={{ 
              fontFamily: 'Outfit, sans-serif',
              fontSize: '12px',
              fontWeight: '600',
              color: 'var(--text-muted)',
              textTransform: 'uppercase',
              letterSpacing: '0.5px',
              marginBottom: '12px',
              marginTop: '24px',
              paddingLeft: '4px'
            }}>Contato</p>
            
            <SettingItem
              icon={<svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>}
              label="Contato com o desenvolvedor"
              value="WhatsApp"
              onClick={() => window.open('https://wa.me/5575981234176', '_blank')}
            />
            
            {/* Seção: Sobre */}
            <p style={{ 
              fontFamily: 'Outfit, sans-serif',
              fontSize: '12px',
              fontWeight: '600',
              color: 'var(--text-muted)',
              textTransform: 'uppercase',
              letterSpacing: '0.5px',
              marginBottom: '12px',
              marginTop: '24px',
              paddingLeft: '4px'
            }}>Sobre</p>
            
            <SettingItem
              icon={<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>}
              label="Acervo Digital"
              value="Versão 2.0.0 • Dezembro 2025"
              onClick={() => setShowAboutModal(true)}
            />
            
            {/* Sair */}
            <div style={{ marginTop: '32px' }}>
              <SettingItem
                icon={<Icons.Logout />}
                label="Sair da conta"
                onClick={() => { 
                  setUser(null); 
                  showToast('Você saiu da conta'); 
                }}
                danger
              />
            </div>
          </div>
          
          {/* Modal Alterar PIN */}
          {showChangePinModal && (
            <ChangePinModal onClose={() => setShowChangePinModal(false)} />
          )}
          
          {/* Modal Sobre */}
          {showAboutModal && (
            <div style={{
              position: 'fixed',
              inset: 0,
              zIndex: 9999,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              background: 'rgba(0,0,0,0.6)',
              padding: '20px'
            }} onClick={() => setShowAboutModal(false)}>
              <div 
                style={{
                  background: 'var(--bg-primary)',
                  borderRadius: '20px',
                  width: '100%',
                  maxWidth: '420px',
                  maxHeight: '85vh',
                  boxShadow: '0 20px 40px rgba(0,0,0,0.3)',
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}
                onClick={e => e.stopPropagation()}
              >
                {/* Header fixo */}
                <div style={{ padding: '24px 24px 0', textAlign: 'center', flexShrink: 0 }}>
                  {/* Logo */}
                  <div style={{
                    width: '70px',
                    height: '70px',
                    borderRadius: '18px',
                    background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    margin: '0 auto 16px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.2)',
                    overflow: 'hidden',
                    padding: '10px'
                  }}>
                    <img 
                      src="/assets/images/ui/brasao-256x256.png" 
                      alt="Brasão"
                      style={{
                        width: '100%',
                        height: '100%',
                        objectFit: 'contain'
                      }}
                    />
                  </div>
                  
                  <h3 style={{ 
                    fontFamily: 'Outfit, sans-serif', 
                    fontSize: '18px', 
                    fontWeight: '700',
                    marginBottom: '2px'
                  }}>Acervo Digital</h3>
                  <p style={{ 
                    fontFamily: 'Outfit, sans-serif', 
                    fontSize: '13px', 
                    color: 'var(--text-muted)',
                    marginBottom: '16px'
                  }}>Sociedade Filarmônica 25 de Março</p>
                  
                  <div style={{
                    background: 'var(--bg-card)',
                    borderRadius: '12px',
                    padding: '12px 16px',
                    marginBottom: '16px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    textAlign: 'left'
                  }}>
                    <div>
                      <p style={{ fontSize: '10px', color: 'var(--text-muted)', marginBottom: '2px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Versão</p>
                      <p style={{ fontSize: '13px', fontWeight: '600' }}>2.0.0</p>
                    </div>
                    <div>
                      <p style={{ fontSize: '10px', color: 'var(--text-muted)', marginBottom: '2px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Tecnologias</p>
                      <p style={{ fontSize: '13px', fontWeight: '500' }}>React • JS • CSS</p>
                    </div>
                    <div>
                      <p style={{ fontSize: '10px', color: 'var(--text-muted)', marginBottom: '2px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Dev</p>
                      <p style={{ fontSize: '13px', fontWeight: '600', color: 'var(--primary)' }}>Antônio Jr.</p>
                    </div>
                  </div>
                </div>
                
                {/* Changelog scrollável */}
                <div style={{ 
                  flex: 1, 
                  overflowY: 'auto', 
                  padding: '0 24px',
                  WebkitOverflowScrolling: 'touch'
                }}>
                  <p style={{ 
                    fontSize: '11px', 
                    fontWeight: '600',
                    color: 'var(--text-muted)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px',
                    marginBottom: '12px'
                  }}>Histórico de Atualizações</p>
                  
                  {/* v2.0.0 */}
                  <div style={{ marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ 
                        background: 'var(--primary)', 
                        color: '#fff', 
                        fontSize: '11px', 
                        fontWeight: '700',
                        padding: '3px 8px',
                        borderRadius: '6px'
                      }}>2.0.0</span>
                      <span style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Atual</span>
                    </div>
                    <ul style={{ fontSize: '12px', color: 'var(--text-secondary)', paddingLeft: '16px', margin: 0 }}>
                      <li style={{ marginBottom: '4px' }}>Upload de pasta com múltiplas partes</li>
                      <li style={{ marginBottom: '4px' }}>Detecção automática de instrumentos</li>
                      <li style={{ marginBottom: '4px' }}>Gerenciamento de partes no admin</li>
                      <li style={{ marginBottom: '4px' }}>Seletor de partes múltiplas no download</li>
                      <li style={{ marginBottom: '4px' }}>Download direto ao selecionar instrumento</li>
                      <li style={{ marginBottom: '4px' }}>Seção "Em Destaque" só com marcados</li>
                      <li>Correção de bugs e melhorias gerais</li>
                    </ul>
                  </div>
                  
                  {/* v1.5.0 */}
                  <div style={{ marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ 
                        background: 'var(--bg-card)', 
                        color: 'var(--text-primary)', 
                        fontSize: '11px', 
                        fontWeight: '600',
                        padding: '3px 8px',
                        borderRadius: '6px',
                        border: '1px solid var(--border)'
                      }}>1.5.0</span>
                    </div>
                    <ul style={{ fontSize: '12px', color: 'var(--text-secondary)', paddingLeft: '16px', margin: 0 }}>
                      <li style={{ marginBottom: '4px' }}>Modal "Sobre" com changelog</li>
                      <li style={{ marginBottom: '4px' }}>Validação PIN não pode ser igual ao anterior</li>
                      <li>Espaçamento entre cards no mobile</li>
                    </ul>
                  </div>
                  
                  {/* v1.4.0 */}
                  <div style={{ marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ 
                        background: 'var(--bg-card)', 
                        color: 'var(--text-primary)', 
                        fontSize: '11px', 
                        fontWeight: '600',
                        padding: '3px 8px',
                        borderRadius: '6px',
                        border: '1px solid var(--border)'
                      }}>1.4.0</span>
                    </div>
                    <ul style={{ fontSize: '12px', color: 'var(--text-secondary)', paddingLeft: '16px', margin: 0 }}>
                      <li style={{ marginBottom: '4px' }}>Perfil completo: foto, edição de nome</li>
                      <li style={{ marginBottom: '4px' }}>Alteração de PIN em 3 etapas</li>
                      <li style={{ marginBottom: '4px' }}>Contato via WhatsApp</li>
                      <li>Tema mobile: clique direto cicla opções</li>
                    </ul>
                  </div>
                  
                  {/* v1.3.0 */}
                  <div style={{ marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ 
                        background: 'var(--bg-card)', 
                        color: 'var(--text-primary)', 
                        fontSize: '11px', 
                        fontWeight: '600',
                        padding: '3px 8px',
                        borderRadius: '6px',
                        border: '1px solid var(--border)'
                      }}>1.3.0</span>
                    </div>
                    <ul style={{ fontSize: '12px', color: 'var(--text-secondary)', paddingLeft: '16px', margin: 0 }}>
                      <li style={{ marginBottom: '4px' }}>Login com usuário + PIN de 4 dígitos</li>
                      <li style={{ marginBottom: '4px' }}>Auto-login ao completar PIN</li>
                      <li style={{ marginBottom: '4px' }}>Opção "Lembrar meu acesso"</li>
                      <li>Otimização mobile para teclado virtual</li>
                    </ul>
                  </div>
                  
                  {/* v1.2.0 */}
                  <div style={{ marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ 
                        background: 'var(--bg-card)', 
                        color: 'var(--text-primary)', 
                        fontSize: '11px', 
                        fontWeight: '600',
                        padding: '3px 8px',
                        borderRadius: '6px',
                        border: '1px solid var(--border)'
                      }}>1.2.0</span>
                    </div>
                    <ul style={{ fontSize: '12px', color: 'var(--text-secondary)', paddingLeft: '16px', margin: 0 }}>
                      <li style={{ marginBottom: '4px' }}>Tema: Claro, Escuro, Sistema</li>
                      <li style={{ marginBottom: '4px' }}>Contador de próximo ensaio</li>
                      <li>Tela de login com glassmorphism</li>
                    </ul>
                  </div>
                  
                  {/* v1.1.0 */}
                  <div style={{ marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ 
                        background: 'var(--bg-card)', 
                        color: 'var(--text-primary)', 
                        fontSize: '11px', 
                        fontWeight: '600',
                        padding: '3px 8px',
                        borderRadius: '6px',
                        border: '1px solid var(--border)'
                      }}>1.1.0</span>
                    </div>
                    <ul style={{ fontSize: '12px', color: 'var(--text-secondary)', paddingLeft: '16px', margin: 0 }}>
                      <li style={{ marginBottom: '4px' }}>Modal de detalhes da partitura</li>
                      <li style={{ marginBottom: '4px' }}>Seletor de 27 instrumentos</li>
                      <li>Sistema de favoritos persistente</li>
                    </ul>
                  </div>
                  
                  {/* v1.0.0 */}
                  <div style={{ marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ 
                        background: 'var(--bg-card)', 
                        color: 'var(--text-primary)', 
                        fontSize: '11px', 
                        fontWeight: '600',
                        padding: '3px 8px',
                        borderRadius: '6px',
                        border: '1px solid var(--border)'
                      }}>1.0.0</span>
                    </div>
                    <ul style={{ fontSize: '12px', color: 'var(--text-secondary)', paddingLeft: '16px', margin: 0 }}>
                      <li style={{ marginBottom: '4px' }}>Layout desktop com sidebar</li>
                      <li style={{ marginBottom: '4px' }}>Toggle sidebar (260px ↔ 72px)</li>
                      <li style={{ marginBottom: '4px' }}>Filtros por gênero e compositor</li>
                      <li>Grid responsivo de cards</li>
                    </ul>
                  </div>
                  
                  {/* Versões anteriores colapsadas */}
                  <div style={{ 
                    background: 'var(--bg-card)', 
                    borderRadius: '10px', 
                    padding: '12px',
                    marginBottom: '8px'
                  }}>
                    <p style={{ fontSize: '11px', fontWeight: '600', marginBottom: '8px' }}>Versões anteriores</p>
                    <div style={{ fontSize: '11px', color: 'var(--text-muted)', lineHeight: '1.6' }}>
                      <strong>0.9</strong> Notificações • 
                      <strong> 0.8</strong> Header Home • 
                      <strong> 0.7</strong> Cards em destaque • 
                      <strong> 0.6</strong> Favoritos, busca fuzzy • 
                      <strong> 0.5</strong> Tema claro/escuro • 
                      <strong> 0.4</strong> Painel Admin • 
                      <strong> 0.3</strong> Busca • 
                      <strong> 0.2</strong> Acervo • 
                      <strong> 0.1</strong> Versão inicial
                    </div>
                  </div>
                </div>
                
                {/* Footer fixo */}
                <div style={{ padding: '16px 24px 24px', flexShrink: 0 }}>
                  <p style={{ 
                    fontSize: '11px', 
                    color: 'var(--text-muted)',
                    marginBottom: '12px',
                    textAlign: 'center'
                  }}>
                    Feira de Santana - BA • Fundada em 1868
                  </p>
                  
                  <button
                    onClick={() => setShowAboutModal(false)}
                    style={{
                      width: '100%',
                      padding: '12px',
                      background: 'var(--primary)',
                      border: 'none',
                      borderRadius: '10px',
                      color: '#fff',
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '14px',
                      fontWeight: '600',
                      cursor: 'pointer'
                    }}
                  >
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Favorites Screen
    const FavoritesScreen = () => {
      const { sheets, favorites, toggleFavorite } = useApp();
      const favoriteSheets = useMemo(() => sheets.filter(s => favorites.includes(s.id)), [sheets, favorites]);
      
      return (
        <div>
          <Header title="Favoritos" subtitle={`${favoriteSheets.length} partitura${favoriteSheets.length !== 1 ? 's' : ''} salva${favoriteSheets.length !== 1 ? 's' : ''}`} />
          
          {favoriteSheets.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '60px 40px', color: 'var(--text-muted)' }}>
              <div style={{ width: '64px', height: '64px', margin: '0 auto 16px', opacity: 0.3 }}>
                <Icons.Heart />
              </div>
              <h3 style={{ fontFamily: "Outfit, sans-serif", fontSize: '18px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-primary)' }}>
                Nenhum favorito ainda
              </h3>
              <p>Toque no coração nas partituras para salvá-las aqui</p>
            </div>
          ) : (
            <div className="files-grid">
              {favoriteSheets.map(sheet => (
                <FileCard 
                  key={sheet.id} 
                  sheet={sheet} 
                  category={CATEGORIES.find(c => c.id === sheet.category)}
                  isFavorite={true}
                  onToggleFavorite={() => toggleFavorite(sheet.id)}
                />
              ))}
            </div>
          )}
        </div>
      );
    };

    // Tela de Todos os Gêneros
    const GenresScreen = () => {
      const { sheets, setSelectedCategory, setActiveTab } = useApp();
      
      // Calcular contagem de partituras por categoria
      const categoriesWithCount = React.useMemo(() => {
        return CATEGORIES.map(cat => ({
          ...cat,
          count: sheets.filter(s => s.category === cat.id).length
        })).sort((a, b) => b.count - a.count);
      }, [sheets]);
      
      const handleSelectCategory = (categoryId) => {
        setSelectedCategory(categoryId);
        setActiveTab('library');
      };
      
      return (
        <div className="screen-container" style={{ padding: '24px', maxWidth: '1200px', margin: '0 auto' }}>
          {/* Header */}
          <div style={{ marginBottom: '32px' }}>
            <button
              onClick={() => setActiveTab('home')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                background: 'transparent',
                border: 'none',
                color: 'var(--text-muted)',
                cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif',
                fontSize: '14px',
                marginBottom: '16px',
                padding: '0'
              }}
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Voltar
            </button>
            <h1 style={{ 
              fontFamily: 'Outfit, sans-serif', 
              fontSize: '28px', 
              fontWeight: '700', 
              color: 'var(--text-primary)',
              marginBottom: '8px'
            }}>
              Gêneros Musicais
            </h1>
            <p style={{ 
              fontFamily: 'Outfit, sans-serif', 
              fontSize: '15px', 
              color: 'var(--text-muted)' 
            }}>
              Explore o acervo por categoria musical
            </p>
          </div>
          
          {/* Grid de Categorias */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
            gap: '16px'
          }}>
            {categoriesWithCount.map((cat, index) => (
              <button
                key={cat.id}
                onClick={() => handleSelectCategory(cat.id)}
                className="card-hover"
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '16px',
                  padding: '20px',
                  background: 'var(--bg-card)',
                  border: '1px solid var(--border)',
                  borderRadius: 'var(--radius)',
                  cursor: 'pointer',
                  textAlign: 'left',
                  transition: 'all 0.2s ease'
                }}
              >
                <div style={{
                  width: '56px',
                  height: '56px',
                  borderRadius: '12px',
                  background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                  border: '1px solid rgba(212, 175, 55, 0.2)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0
                }}>
                  <CategoryIcon categoryId={cat.id} size={26} color="#D4AF37" />
                </div>
                <div style={{ flex: 1 }}>
                  <h3 style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '16px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                    marginBottom: '4px'
                  }}>{cat.name}</h3>
                  <p style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '13px',
                    color: 'var(--text-muted)'
                  }}>
                    {cat.count} {cat.count === 1 ? 'partitura' : 'partituras'}
                  </p>
                </div>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </button>
            ))}
          </div>
        </div>
      );
    };

    // Tela de Todos os Compositores
    const ComposersScreen = () => {
      const { sheets, setSelectedComposer, setActiveTab } = useApp();
      const [searchQuery, setSearchQuery] = React.useState('');
      
      // Compositores prioritários (ordem de importância para a banda)
      const priorityOrder = ['Estevam Moura', 'Tertuliano Santos', 'Amando Nobre', 'Heráclio Guerreiro'];
      
      // Função para converter nome em slug
      const nameToSlug = (name) => {
        return name.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
          .replace(/[^a-z0-9\s-]/g, '') // Remove caracteres especiais
          .replace(/\s+/g, '-'); // Espaços viram hífens
      };
      
      // Fotos dos compositores (caminhos locais)
      const composerPhotos = {
        'Estevam Moura': '/assets/images/compositores/estevam-moura.jpg',
        'Tertuliano Santos': '/assets/images/compositores/tertuliano-santos.jpg',
        'Amando Nobre': '/assets/images/compositores/amando-nobre.jpg',
        'Heráclio Guerreiro': '/assets/images/compositores/heraclio-guerreiro.jpg'
      };
      
      // Calcular compositores com contagem
      const composersWithCount = React.useMemo(() => {
        const composerMap = {};
        sheets.forEach(s => {
          if (s.composer && s.composer.trim()) {
            if (!composerMap[s.composer]) {
              composerMap[s.composer] = 0;
            }
            composerMap[s.composer]++;
          }
        });
        
        return Object.entries(composerMap)
          .map(([name, count]) => ({ name, count }))
          .sort((a, b) => {
            // Prioriza pela ordem de importância
            const aIndex = priorityOrder.indexOf(a.name);
            const bIndex = priorityOrder.indexOf(b.name);
            
            if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
            if (aIndex !== -1) return -1;
            if (bIndex !== -1) return 1;
            
            // Depois por quantidade de partituras
            return b.count - a.count;
          });
      }, [sheets]);
      
      // Filtrar por busca
      const filteredComposers = React.useMemo(() => {
        if (!searchQuery.trim()) return composersWithCount;
        const query = searchQuery.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        return composersWithCount.filter(c => 
          c.name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').includes(query)
        );
      }, [composersWithCount, searchQuery]);
      
      // Separar destaque dos demais
      const featuredComposers = filteredComposers.filter(c => priorityOrder.includes(c.name));
      const otherComposers = filteredComposers.filter(c => !priorityOrder.includes(c.name));
      
      const handleSelectComposer = (composerName) => {
        setSelectedComposer(composerName);
        setActiveTab('library');
      };
      
      // Componente de Card do Compositor com Glassmorphism
      const ComposerCard = ({ composer, featured = false }) => {
        const hasPhoto = composerPhotos[composer.name];
        const photoUrl = hasPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(composer.name)}&size=400&background=2a2a38&color=D4AF37&bold=true&font-size=0.4`;
        
        return (
          <button
            onClick={() => handleSelectComposer(composer.name)}
            style={{
              position: 'relative',
              width: '100%',
              height: featured ? '280px' : '200px',
              borderRadius: '16px',
              overflow: 'hidden',
              border: 'none',
              cursor: 'pointer',
              background: 'var(--bg-card)',
              transition: 'transform 0.3s ease, box-shadow 0.3s ease'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-4px)';
              e.currentTarget.style.boxShadow = '0 12px 40px rgba(0,0,0,0.3)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.boxShadow = 'none';
            }}
          >
            {/* Imagem de fundo */}
            <div style={{
              position: 'absolute',
              inset: 0,
              backgroundImage: `url(${photoUrl})`,
              backgroundSize: 'cover',
              backgroundPosition: 'center top',
              filter: 'brightness(0.9)'
            }} />
            
            {/* Gradiente escuro na parte inferior */}
            <div style={{
              position: 'absolute',
              inset: 0,
              background: 'linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 40%, transparent 70%)'
            }} />
            
            {/* Badge de destaque */}
            {featured && (
              <div style={{
                position: 'absolute',
                top: '12px',
                right: '12px',
                padding: '4px 10px',
                background: 'rgba(212, 175, 55, 0.9)',
                borderRadius: '20px',
                fontSize: '10px',
                fontWeight: '600',
                color: '#1a1a1a',
                fontFamily: 'Outfit, sans-serif',
                textTransform: 'uppercase',
                letterSpacing: '0.5px'
              }}>
                Destaque
              </div>
            )}
            
            {/* Conteúdo com Glassmorphism */}
            <div style={{
              position: 'absolute',
              bottom: '0',
              left: '0',
              right: '0',
              padding: '16px',
              background: 'rgba(255, 255, 255, 0.1)',
              backdropFilter: 'blur(12px)',
              WebkitBackdropFilter: 'blur(12px)',
              borderTop: '1px solid rgba(255, 255, 255, 0.15)'
            }}>
              <h3 style={{
                fontFamily: 'Outfit, sans-serif',
                fontSize: featured ? '18px' : '15px',
                fontWeight: '600',
                color: '#fff',
                marginBottom: '4px',
                textShadow: '0 2px 4px rgba(0,0,0,0.3)'
              }}>
                {composer.name}
              </h3>
              <p style={{
                fontFamily: 'Outfit, sans-serif',
                fontSize: '12px',
                color: 'rgba(255, 255, 255, 0.8)',
                display: 'flex',
                alignItems: 'center',
                gap: '6px'
              }}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M9 18V5l12-2v13"/>
                  <circle cx="6" cy="18" r="3"/>
                  <circle cx="18" cy="16" r="3"/>
                </svg>
                {composer.count} {composer.count === 1 ? 'partitura' : 'partituras'}
              </p>
            </div>
          </button>
        );
      };
      
      return (
        <div className="screen-container" style={{ padding: '24px', maxWidth: '1400px', margin: '0 auto' }}>
          {/* Header */}
          <div style={{ marginBottom: '32px' }}>
            <button
              onClick={() => setActiveTab('home')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                background: 'transparent',
                border: 'none',
                color: 'var(--text-muted)',
                cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif',
                fontSize: '14px',
                marginBottom: '16px',
                padding: '0'
              }}
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Voltar
            </button>
            <h1 style={{ 
              fontFamily: 'Outfit, sans-serif', 
              fontSize: '28px', 
              fontWeight: '700', 
              color: 'var(--text-primary)',
              marginBottom: '8px'
            }}>
              Compositores
            </h1>
            <p style={{ 
              fontFamily: 'Outfit, sans-serif', 
              fontSize: '15px', 
              color: 'var(--text-muted)' 
            }}>
              Mestres da música que moldaram o repertório da filarmônica
            </p>
          </div>
          
          {/* Busca */}
          <div style={{ marginBottom: '32px', maxWidth: '400px' }}>
            <div className="search-bar">
              <svg className="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input
                type="text"
                placeholder="Buscar compositor..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
              {searchQuery && (
                <button
                  className="clear-btn"
                  onClick={() => setSearchQuery('')}
                >
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              )}
            </div>
          </div>
          
          {filteredComposers.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--text-muted)' }}>
              <p>Nenhum compositor encontrado</p>
            </div>
          ) : (
            <>
              {/* Compositores em Destaque */}
              {featuredComposers.length > 0 && !searchQuery && (
                <div style={{ marginBottom: '40px' }}>
                  <h2 style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '16px',
                    fontWeight: '600',
                    color: '#D4AF37',
                    marginBottom: '16px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/>
                    </svg>
                    Destaques
                  </h2>
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))',
                    gap: '16px'
                  }}>
                    {featuredComposers.map(comp => (
                      <ComposerCard key={comp.name} composer={comp} featured />
                    ))}
                  </div>
                </div>
              )}
              
              {/* Outros Compositores */}
              {otherComposers.length > 0 && (
                <div>
                  {!searchQuery && featuredComposers.length > 0 && (
                    <h2 style={{
                      fontFamily: 'Outfit, sans-serif',
                      fontSize: '16px',
                      fontWeight: '600',
                      color: 'var(--text-secondary)',
                      marginBottom: '16px'
                    }}>
                      Todos os Compositores
                    </h2>
                  )}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, minmax(160px, 1fr))',
                    gap: '12px'
                  }}>
                    {(searchQuery ? filteredComposers : otherComposers).map(comp => (
                      <ComposerCard key={comp.name} composer={comp} />
                    ))}
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      );
    };

    // Login Modal
    // Login Screen - Tela de login com efeito glassmorphism
    const LoginScreen = ({ onClose, required = false }) => {
      const { setUser, showToast, setFavorites } = useApp();
      const [username, setUsername] = useState('');
      const [pin, setPin] = useState(['', '', '', '']);
      const [rememberMe, setRememberMe] = useState(() => Storage.get('rememberMe', false));
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState('');
      const [userFound, setUserFound] = useState(false);
      const [userInfo, setUserInfo] = useState(null); // Dados do usuário da API
      const pinRefs = [React.useRef(null), React.useRef(null), React.useRef(null), React.useRef(null)];
      const cardRef = React.useRef(null);
      const checkUserTimeout = React.useRef(null);
      
      // Scroll suave para o card quando teclado abre (mobile)
      const scrollToCard = React.useCallback(() => {
        if (cardRef.current && window.innerWidth < 768) {
          setTimeout(() => {
            cardRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      }, []);
      
      // Carrega usuário salvo se "Lembrar-me" estava ativo
      React.useEffect(() => {
        if (rememberMe) {
          const savedUsername = Storage.get('savedUsername', '');
          if (savedUsername) {
            setUsername(savedUsername);
            // Verifica se usuário ainda existe na API
            checkUserExists(savedUsername);
          }
        }
      }, []);
      
      // Função para verificar usuário na API
      const checkUserExists = async (usernameToCheck) => {
        if (!usernameToCheck || usernameToCheck.length < 2) {
          setUserFound(false);
          setUserInfo(null);
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE_URL}/api/check-user`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: usernameToCheck })
          });
          const data = await response.json();
          
          if (data.exists) {
            setUserFound(true);
            setUserInfo({ name: data.nome, instrument: data.instrumento });
            setTimeout(() => pinRefs[0].current?.focus(), 100);
          } else {
            setUserFound(false);
            setUserInfo(null);
          }
        } catch (e) {
          console.error('Erro ao verificar usuário:', e);
          setUserFound(false);
          setUserInfo(null);
        }
      };
      
      // Verifica se usuário existe quando digita (com debounce)
      const handleUsernameChange = (value) => {
        const normalized = value.toLowerCase().replace(/\s/g, '');
        setUsername(normalized);
        setError('');
        
        // Limpa timeout anterior
        if (checkUserTimeout.current) {
          clearTimeout(checkUserTimeout.current);
        }
        
        // Reset se vazio
        if (!normalized || normalized.length < 2) {
          setUserFound(false);
          setUserInfo(null);
          return;
        }
        
        // Debounce de 300ms para não fazer muitas requisições
        checkUserTimeout.current = setTimeout(() => {
          checkUserExists(normalized);
        }, 300);
      };
      
      // Handler do PIN - autologin quando completo
      const handlePinChange = async (index, value) => {
        // Só aceita números
        if (value && !/^\d$/.test(value)) return;
        
        const newPin = [...pin];
        newPin[index] = value;
        setPin(newPin);
        setError('');
        
        // Move para próximo campo
        if (value && index < 3) {
          pinRefs[index + 1].current?.focus();
        }
        
        // Verifica se completou o PIN - AUTOLOGIN
        if (value && index === 3) {
          const fullPin = newPin.join('');
          const normalizedUsername = username.toLowerCase().replace(/\s/g, '');
          
          if (!normalizedUsername) {
            setError('Digite seu usuário');
            setPin(['', '', '', '']);
            return;
          }
          
          setIsLoading(true);
          
          try {
            // Tenta login via API
            if (USE_API) {
              const result = await API.login(normalizedUsername, fullPin);
              
              if (result.success && result.user) {
                Storage.set('rememberMe', rememberMe);
                if (rememberMe) {
                  Storage.set('savedUsername', normalizedUsername);
                } else {
                  Storage.remove('savedUsername');
                }
                
                // Usa dados completos do usuário da API
                const userData = { 
                  id: result.user.id,
                  username: result.user.username,
                  name: result.user.nome, 
                  isAdmin: result.user.admin, 
                  instrument: result.user.instrumento_nome || 'Músico',
                  instrumento_id: result.user.instrumento_id,
                  foto_url: result.user.foto_url
                };
                
                setUser(userData);
                Storage.set('user', userData);
                
                // Carrega favoritos do usuário
                try {
                  const favoritosIds = await API.getFavoritosIds();
                  if (favoritosIds && Array.isArray(favoritosIds)) {
                    const favoritosStr = favoritosIds.map(id => String(id));
                    setFavorites(favoritosStr);
                    Storage.set('favorites', favoritosStr);
                  }
                } catch (e) {
                  console.log('Favoritos serão carregados depois');
                }
                
                showToast(`Bem-vindo, ${result.user.nome.split(' ')[0]}!`);
                if (onClose) onClose();
                setIsLoading(false);
                return;
              }
            }
            
            // Se chegou aqui, login falhou
            setError('Usuário ou PIN incorreto');
            setPin(['', '', '', '']);
            pinRefs[0].current?.focus();
            
            if (navigator.vibrate) {
              navigator.vibrate([100, 50, 100]);
            }
          } catch (err) {
            console.error('Erro no login:', err);
            setError('Usuário ou PIN incorreto');
            setPin(['', '', '', '']);
            pinRefs[0].current?.focus();
            
            if (navigator.vibrate) {
              navigator.vibrate([100, 50, 100]);
            }
          }
          
          setIsLoading(false);
        }
      };
      
      // Handler do backspace no PIN
      const handlePinKeyDown = (index, e) => {
        if (e.key === 'Backspace' && !pin[index] && index > 0) {
          pinRefs[index - 1].current?.focus();
        }
      };
      
      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          zIndex: 9999,
          display: 'flex',
          flexDirection: 'column',
          overflowY: 'auto',
          overflowX: 'hidden',
          WebkitOverflowScrolling: 'touch'
        }}>
          {/* Background com imagem e overlay */}
          <div style={{
            position: 'fixed',
            inset: 0,
            background: `
              linear-gradient(135deg, rgba(61, 21, 24, 0.92) 0%, rgba(92, 26, 27, 0.88) 50%, rgba(61, 21, 24, 0.92) 100%),
              url('/assets/images/banda/foto-banda-sao-goncalo.jpg')
            `,
            backgroundSize: 'cover',
            backgroundPosition: 'center',
            filter: 'brightness(0.9)',
            zIndex: -2
          }} />
          
          {/* Padrão decorativo sutil */}
          <div style={{
            position: 'fixed',
            inset: 0,
            opacity: 0.03,
            backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
            pointerEvents: 'none',
            zIndex: -1
          }} />
          
          {/* Container scrollável que centraliza o card */}
          <div style={{
            flex: 1,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            minHeight: 'min-content'
          }}>
            {/* Card com efeito glass */}
            <div 
              ref={cardRef}
              style={{
              position: 'relative',
              width: '100%',
              maxWidth: '400px',
              background: 'rgba(255, 255, 255, 0.08)',
              backdropFilter: 'blur(20px)',
              WebkitBackdropFilter: 'blur(20px)',
              borderRadius: '24px',
              border: '1px solid rgba(255, 255, 255, 0.15)',
              boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 1px 1px rgba(255,255,255,0.1)',
              padding: '40px 32px',
              margin: '20px 0',
              animation: 'scaleInLogin 0.4s cubic-bezier(0.16, 1, 0.3, 1)'
            }}>
            {/* Botão fechar - só se não for obrigatório */}
            {!required && (
              <button
                onClick={onClose}
                style={{
                  position: 'absolute',
                  top: '16px',
                  right: '16px',
                  width: '36px',
                  height: '36px',
                  borderRadius: '50%',
                  background: 'rgba(255,255,255,0.1)',
                  border: '1px solid rgba(255,255,255,0.15)',
                  color: 'rgba(255,255,255,0.7)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '18px',
                  transition: 'all 0.2s ease'
                }}
              >
                ✕
              </button>
            )}
            
            {/* Header */}
            <div style={{ textAlign: 'center', marginBottom: '32px' }}>
              {/* Logo */}
              <div style={{
                width: '80px',
                height: '80px',
                borderRadius: '50%',
                background: 'linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.05) 100%)',
                border: '2px solid rgba(212, 175, 55, 0.4)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                margin: '0 auto 16px',
                boxShadow: '0 8px 32px rgba(212, 175, 55, 0.2)',
                overflow: 'hidden',
                padding: '8px'
              }}>
                <img 
                  src="/assets/images/ui/brasao-256x256.png" 
                  alt="Brasão Filarmônica 25 de Março"
                  style={{
                    width: '100%',
                    height: '100%',
                    objectFit: 'contain'
                  }}
                />
              </div>
              
              <h1 style={{
                fontFamily: 'Outfit, sans-serif',
                fontSize: '24px',
                fontWeight: '700',
                color: '#F4E4BC',
                marginBottom: '4px'
              }}>
                Acervo Digital
              </h1>
              
              <p style={{
                fontFamily: 'Outfit, sans-serif',
                fontSize: '14px',
                color: 'rgba(244, 228, 188, 0.6)'
              }}>
                S.F. 25 de Março • Feira de Santana
              </p>
              
              {/* Status badge */}
              <div style={{
                display: 'inline-flex',
                alignItems: 'center',
                gap: '6px',
                marginTop: '12px',
                padding: '6px 12px',
                background: 'rgba(34, 197, 94, 0.15)',
                borderRadius: '20px',
                border: '1px solid rgba(34, 197, 94, 0.3)'
              }}>
                <div style={{
                  width: '8px',
                  height: '8px',
                  borderRadius: '50%',
                  background: '#22C55E',
                  animation: 'pulse 2s ease-in-out infinite'
                }} />
                <span style={{
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '11px',
                  fontWeight: '600',
                  color: '#22C55E',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>Sistema Online</span>
              </div>
            </div>
            
            {/* Form */}
            <div>
              {/* Usuário */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '13px',
                  fontWeight: '600',
                  color: 'rgba(244, 228, 188, 0.8)',
                  marginBottom: '8px'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                  Usuário
                  {userFound && (
                    <span style={{
                      marginLeft: 'auto',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px',
                      color: '#22C55E',
                      fontSize: '11px'
                    }}>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M20 6L9 17l-5-5"/>
                      </svg>
                      {userInfo?.name}
                    </span>
                  )}
                </label>
                <input
                  type="text"
                  name="username"
                  autoComplete="username"
                  placeholder="seu.usuario"
                  value={username}
                  onChange={e => handleUsernameChange(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '14px 16px',
                    borderRadius: '12px',
                    background: 'rgba(255, 255, 255, 0.06)',
                    border: userFound ? '1px solid rgba(34, 197, 94, 0.4)' : '1px solid rgba(255, 255, 255, 0.12)',
                    color: '#F4E4BC',
                    fontSize: '16px',
                    fontFamily: 'Outfit, sans-serif',
                    outline: 'none',
                    transition: 'all 0.2s ease',
                    boxSizing: 'border-box'
                  }}
                  onFocus={e => {
                    e.target.style.borderColor = 'rgba(212, 175, 55, 0.5)';
                    e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                    scrollToCard();
                  }}
                  onBlur={e => {
                    e.target.style.borderColor = userFound ? 'rgba(34, 197, 94, 0.4)' : 'rgba(255, 255, 255, 0.12)';
                    e.target.style.background = 'rgba(255, 255, 255, 0.06)';
                  }}
                />
              </div>
              
              {/* PIN */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '13px',
                  fontWeight: '600',
                  color: 'rgba(244, 228, 188, 0.8)',
                  marginBottom: '12px'
                }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                  PIN
                </label>
                <div style={{
                  display: 'flex',
                  justifyContent: 'center',
                  gap: '12px'
                }}>
                  {pin.map((digit, index) => (
                    <input
                      key={index}
                      ref={pinRefs[index]}
                      type="password"
                      inputMode="numeric"
                      maxLength={1}
                      value={digit}
                      onChange={e => handlePinChange(index, e.target.value)}
                      onKeyDown={e => handlePinKeyDown(index, e)}
                      disabled={isLoading}
                      style={{
                        width: '56px',
                        minWidth: '56px',
                        maxWidth: '56px',
                        height: '56px',
                        borderRadius: '12px',
                        background: digit ? 'rgba(212, 175, 55, 0.15)' : 'rgba(255, 255, 255, 0.06)',
                        border: digit 
                          ? '2px solid rgba(212, 175, 55, 0.4)' 
                          : '1px solid rgba(255, 255, 255, 0.12)',
                        color: '#F4E4BC',
                        fontSize: '22px',
                        fontFamily: 'Outfit, sans-serif',
                        fontWeight: '700',
                        textAlign: 'center',
                        outline: 'none',
                        transition: 'all 0.2s ease',
                        boxSizing: 'border-box',
                        flexShrink: 0,
                        flexGrow: 0
                      }}
                      onFocus={e => {
                        e.target.style.borderColor = 'rgba(212, 175, 55, 0.5)';
                        e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                        scrollToCard();
                      }}
                      onBlur={e => {
                        if (!digit) {
                          e.target.style.borderColor = 'rgba(255, 255, 255, 0.12)';
                          e.target.style.background = 'rgba(255, 255, 255, 0.06)';
                        }
                      }}
                    />
                  ))}
                </div>
              </div>
              
              {/* Erro */}
              {error && (
                <div style={{
                  background: 'rgba(239, 68, 68, 0.15)',
                  border: '1px solid rgba(239, 68, 68, 0.3)',
                  borderRadius: '10px',
                  padding: '12px 16px',
                  marginBottom: '20px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '10px',
                  animation: 'shake 0.5s ease'
                }}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#EF4444" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                  </svg>
                  <span style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '13px',
                    color: '#EF4444'
                  }}>{error}</span>
                </div>
              )}
              
              {/* Loading */}
              {isLoading && (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '16px',
                  padding: '24px',
                  background: 'rgba(212, 175, 55, 0.08)',
                  borderRadius: '16px',
                  marginBottom: '20px',
                  border: '1px solid rgba(212, 175, 55, 0.2)'
                }}>
                  {/* Mini brasão com animação */}
                  <div style={{
                    width: '56px',
                    height: '56px',
                    borderRadius: '50%',
                    background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
                    padding: '3px',
                    boxShadow: '0 4px 16px rgba(212, 175, 55, 0.3)',
                    animation: 'pulse 1.5s ease-in-out infinite'
                  }}>
                    <div style={{
                      width: '100%',
                      height: '100%',
                      borderRadius: '50%',
                      overflow: 'hidden',
                      background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <img 
                        src="/assets/images/ui/brasao-256x256.png" 
                        alt=""
                        style={{
                          width: '70%',
                          height: '70%',
                          objectFit: 'contain'
                        }}
                      />
                    </div>
                  </div>
                  <span style={{
                    fontFamily: 'Outfit, sans-serif',
                    fontSize: '14px',
                    fontWeight: '600',
                    color: '#D4AF37'
                  }}>Entrando...</span>
                </div>
              )}
              
              {/* Lembrar-me */}
              <label 
                onClick={() => setRememberMe(!rememberMe)}
                style={{
                display: 'flex',
                alignItems: 'center',
                gap: '10px',
                cursor: 'pointer'
              }}>
                <div 
                  style={{
                    width: '20px',
                    height: '20px',
                    borderRadius: '6px',
                    background: rememberMe ? '#D4AF37' : 'rgba(255, 255, 255, 0.06)',
                    border: rememberMe ? 'none' : '1px solid rgba(255, 255, 255, 0.2)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'all 0.2s ease',
                    flexShrink: 0
                  }}
                >
                  {rememberMe && (
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#3D1518" strokeWidth="3">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  )}
                </div>
                <span style={{
                  fontFamily: 'Outfit, sans-serif',
                  fontSize: '13px',
                  color: 'rgba(244, 228, 188, 0.7)'
                }}>
                  Lembrar meu acesso
                </span>
              </label>
            </div>
            
            {/* Footer */}
            <div style={{
              marginTop: '28px',
              paddingTop: '20px',
              borderTop: '1px solid rgba(255, 255, 255, 0.1)',
              display: 'flex',
              justifyContent: 'center',
              alignItems: 'center'
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '6px',
                color: 'rgba(244, 228, 188, 0.4)',
                fontSize: '11px',
                fontFamily: 'Outfit, sans-serif'
              }}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                Conexão Segura
              </div>
            </div>
            
            <p style={{
              textAlign: 'center',
              marginTop: '16px',
              fontSize: '11px',
              fontFamily: 'Outfit, sans-serif',
              color: 'rgba(244, 228, 188, 0.3)'
            }}>
              Sociedade Filarmônica 25 de Março • Fundada em 1868
            </p>
          </div>
          </div>
        </div>
      );
    };
    
    // Mantém LoginModal para compatibilidade
    const LoginModal = ({ isOpen, onClose }) => {
      if (!isOpen) return null;
      return <LoginScreen onClose={onClose} />;
    };

    // Upload Modal
    const UploadModal = ({ isOpen, onClose }) => {
      const { addSheet, selectedCategory, showToast } = useApp();
      const [title, setTitle] = useState('');
      const [composer, setComposer] = useState('');
      const [category, setCategory] = useState(selectedCategory || 'dobrado');
      const [file, setFile] = useState(null);
      
      const handleSubmit = () => {
        if (!title || !composer) { showToast('Preencha os campos obrigatórios', 'error'); return; }
        addSheet({
          id: Date.now().toString(), title, composer, category, year: new Date().getFullYear(),
          downloads: 0, size: file ? `${(file.size / 1024 / 1024).toFixed(1)} MB` : '1.0 MB'
        });
        showToast('Partitura adicionada!'); onClose();
        setTitle(''); setComposer(''); setFile(null);
      };
      
      const inputStyle = {
        width: '100%', padding: '14px 16px', borderRadius: 'var(--radius-sm)', background: 'var(--bg-primary)',
        border: '1px solid var(--border)', color: 'var(--text-primary)', fontSize: '15px', marginBottom: '16px'
      };
      
      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Nova Partitura">
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', marginBottom: '8px', color: 'var(--text-secondary)' }}>Título *</label>
          <input type="text" style={inputStyle} placeholder="Nome da música" value={title} onChange={e => setTitle(e.target.value)} />
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', marginBottom: '8px', color: 'var(--text-secondary)' }}>Compositor *</label>
          <input type="text" style={inputStyle} placeholder="Nome do compositor" value={composer} onChange={e => setComposer(e.target.value)} />
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', marginBottom: '8px', color: 'var(--text-secondary)' }}>Categoria</label>
          <select style={{ ...inputStyle, appearance: 'none', cursor: 'pointer' }} value={category} onChange={e => setCategory(e.target.value)}>
            {CATEGORIES.map(cat => <option key={cat.id} value={cat.id}>{cat.name}</option>)}
          </select>
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', marginBottom: '8px', color: 'var(--text-secondary)' }}>Arquivo PDF</label>
          <div style={{
            border: '2px dashed var(--border)', borderRadius: 'var(--radius-sm)', padding: '24px',
            textAlign: 'center', cursor: 'pointer', marginBottom: '20px'
          }} onClick={() => document.getElementById('fileInput').click()}>
            <div style={{ width: '32px', height: '32px', margin: '0 auto 8px', color: 'var(--text-muted)' }}><Icons.Upload /></div>
            <p style={{ color: 'var(--text-muted)', fontSize: '14px' }}>{file ? file.name : 'Clique para selecionar'}</p>
            <input id="fileInput" type="file" accept=".pdf" style={{ display: 'none' }} onChange={e => setFile(e.target.files[0])} />
          </div>
          <button className="btn-hover" style={{
            width: '100%', padding: '16px', background: 'var(--primary)', color: '#fff', border: 'none',
            borderRadius: 'var(--radius-sm)', fontSize: '15px', fontWeight: '600', cursor: 'pointer'
          }} onClick={handleSubmit}>Adicionar</button>
        </Modal>
      );
    };

    // ============ PAINEL ADMINISTRATIVO ============
    
    // Context para Admin
    const AdminContext = React.createContext();
    const useAdmin = () => React.useContext(AdminContext);
    
    // Dashboard Admin
    const AdminDashboard = () => {
      const { stats, loading, refreshData } = useAdmin();
      const { showToast, themeMode, setThemeMode, theme, user } = useApp();
      const [atividades, setAtividades] = useState([]);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
      
      // Detecta mudança de tamanho
      useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      // Carrega atividades
      useEffect(() => {
        const loadAtividades = async () => {
          try {
            const data = await API.getAtividades();
            setAtividades(data || []);
          } catch (e) {
            console.log('Atividades não disponíveis');
          }
        };
        loadAtividades();
      }, []);
      
      // Formata tempo relativo
      const formatTimeAgo = (dateString) => {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'agora';
        if (diffMins < 60) return `${diffMins}min`;
        if (diffHours < 24) return `${diffHours}h`;
        if (diffDays === 1) return 'ontem';
        if (diffDays < 7) return `${diffDays}d`;
        return `${Math.floor(diffDays / 7)}sem`;
      };
      
      // Mapeia tipo para cor e texto
      const getAtividadeInfo = (tipo) => {
        const map = {
          'nova_partitura': { action: 'Nova partitura', color: '#43B97F', iconType: 'music' },
          'download': { action: 'Download', color: '#5B8DEF', iconType: 'download' },
          'favorito': { action: 'Favorito', color: '#E54D87', iconType: 'star' }
        };
        return map[tipo] || { action: tipo, color: '#999', iconType: 'pin' };
      };
      
      // Ícone de atividade SVG
      const AtividadeIcon = ({ type, color }) => {
        const icons = {
          music: (
            <svg width="12" height="12" viewBox="0 0 24 24" fill={color} stroke="none">
              <path d="M9 18V5l12-2v13M6 15a3 3 0 1 0 0 6 3 3 0 0 0 0-6zm12-2a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
            </svg>
          ),
          download: (
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          ),
          star: (
            <svg width="12" height="12" viewBox="0 0 24 24" fill={color} stroke="none">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
          ),
          pin: (
            <svg width="12" height="12" viewBox="0 0 24 24" fill={color} stroke="none">
              <circle cx="12" cy="12" r="10"/>
            </svg>
          )
        };
        return icons[type] || icons.pin;
      };
      
      // Ícones para StatCard
      const StatIcon = ({ type, color }) => {
        const size = isMobile ? 18 : 22;
        const icons = {
          users: (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          ),
          music: (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 18V5l12-2v13"/>
              <circle cx="6" cy="18" r="3"/>
              <circle cx="18" cy="16" r="3"/>
            </svg>
          ),
          download: (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          ),
          folder: (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </svg>
          )
        };
        return icons[type] || icons.music;
      };
      
      const StatCard = ({ icon, label, value, color }) => (
        <div style={{
          background: 'var(--bg-secondary)',
          borderRadius: 'var(--radius-md)',
          padding: isMobile ? '12px' : '16px',
          textAlign: 'center',
          border: '1px solid var(--border)',
          fontFamily: 'Outfit, sans-serif'
        }}>
          <div style={{ marginBottom: isMobile ? '8px' : '10px', display: 'flex', justifyContent: 'center' }}>
            <div style={{
              width: isMobile ? '36px' : '44px', 
              height: isMobile ? '36px' : '44px', 
              borderRadius: isMobile ? '8px' : '10px',
              background: `${color}15`, display: 'flex',
              alignItems: 'center', justifyContent: 'center'
            }}>
              <StatIcon type={icon} color={color} />
            </div>
          </div>
          <div style={{ fontSize: isMobile ? '22px' : '28px', fontWeight: '700', color: color || 'var(--text-primary)', marginBottom: '2px', fontFamily: 'Outfit, sans-serif' }}>
            {loading ? '...' : value}
          </div>
          <div style={{ fontSize: isMobile ? '11px' : '12px', color: 'var(--text-secondary)', fontFamily: 'Outfit, sans-serif' }}>{label}</div>
        </div>
      );
      
      return (
        <div style={{ padding: isMobile ? '16px' : '32px', maxWidth: '1200px', margin: '0 auto', fontFamily: 'Outfit, sans-serif' }}>
          {/* Header com saudação - igual ao modo músicos */}
          <div style={{ marginBottom: isMobile ? '20px' : '32px' }}>
            <div style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '4px', fontFamily: 'Outfit, sans-serif' }}>
              Olá,
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px', flexWrap: 'wrap' }}>
              <h1 style={{ 
                fontSize: isMobile ? '22px' : '28px', 
                fontWeight: '700', 
                background: 'linear-gradient(135deg, #8B6914 0%, #B8860B 50%, #8B6914 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                backgroundClip: 'text',
                fontFamily: 'Outfit, sans-serif', 
                margin: 0,
                display: 'inline',
                filter: 'drop-shadow(0 1px 1px rgba(0,0,0,0.1))'
              }}>
                {user?.name || 'Administrador'}
              </h1>
              <span style={{
                background: 'linear-gradient(135deg, #D4AF37 0%, #B8860B 100%)',
                color: '#fff',
                padding: '6px 14px',
                borderRadius: '20px',
                fontSize: '12px',
                fontWeight: '600',
                fontFamily: 'Outfit, sans-serif',
                textTransform: 'uppercase'
              }}>
                Admin
              </span>
            </div>
            <p style={{ color: 'var(--text-secondary)', fontFamily: 'Outfit, sans-serif', margin: 0 }}>
              Acervo Digital - Sociedade Filarmônica 25 de Março
            </p>
          </div>
          
          {/* Stats Grid - 2x2 no mobile, 4 colunas no desktop */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(2, 1fr)',
            gap: isMobile ? '12px' : '16px',
            marginBottom: isMobile ? '20px' : '32px'
          }}>
            <StatCard icon="users" label="Músicos Ativos" value={stats.musicos_ativos || 0} color="#D4AF37" />
            <StatCard icon="music" label="Partituras" value={stats.total_partituras || 0} color="#3498db" />
            <StatCard icon="download" label="Downloads" value={stats.total_downloads || 0} color="#27ae60" />
            <StatCard icon="folder" label="Categorias" value={stats.total_categorias || 0} color="#9b59b6" />
          </div>
          
          {/* Ações Rápidas */}
          <div style={{
            background: 'var(--bg-secondary)',
            borderRadius: 'var(--radius-md)',
            padding: '24px',
            marginBottom: '32px',
            border: '1px solid var(--border)'
          }}>
            <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '8px' }}>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#D4AF37" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
              </svg>
              Ações Rápidas
            </h2>
            <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
              <QuickActionButton icon="users" label="Novo Músico" onClick={() => window.adminNav('musicos', 'novo')} />
              <QuickActionButton icon="upload" label="Nova Pasta" onClick={() => window.adminNav('partituras', 'pasta')} />
              <QuickActionButton icon="folder" label="Nova Categoria" onClick={() => window.adminNav('categorias', 'novo')} />
            </div>
          </div>
          
          {/* Top Partituras */}
          {stats.top_partituras && stats.top_partituras.length > 0 && (
            <div style={{
              background: 'var(--bg-secondary)',
              borderRadius: 'var(--radius-md)',
              padding: '24px',
              border: '1px solid var(--border)'
            }}>
              <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '8px' }}>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#D4AF37" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                  <polyline points="17 6 23 6 23 12"/>
                </svg>
                Partituras Mais Baixadas
              </h2>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {stats.top_partituras.map((p, i) => (
                  <div key={p.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '12px 16px',
                    background: 'var(--bg-primary)',
                    borderRadius: 'var(--radius-sm)',
                    border: '1px solid var(--border)'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <span style={{
                        width: '28px', height: '28px', borderRadius: '50%',
                        background: i === 0 ? '#f1c40f' : i === 1 ? '#95a5a6' : i === 2 ? '#cd7f32' : 'var(--bg-secondary)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontWeight: '700', fontSize: '14px', color: i < 3 ? '#fff' : 'var(--text-secondary)',
                        fontFamily: 'Outfit, sans-serif'
                      }}>{i + 1}</span>
                      <div>
                        <div style={{ fontWeight: '500', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif' }}>{p.titulo}</div>
                        <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontFamily: 'Outfit, sans-serif' }}>{p.compositor}</div>
                      </div>
                    </div>
                    <div style={{ fontWeight: '600', color: 'var(--accent)', fontFamily: 'Outfit, sans-serif' }}>{p.downloads} downloads</div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {/* Atividades Recentes */}
          <div style={{
            background: 'var(--bg-secondary)',
            borderRadius: 'var(--radius-md)',
            padding: '24px',
            border: '1px solid var(--border)',
            marginTop: '24px'
          }}>
            <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '8px' }}>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#D4AF37" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              Atividade Recente
            </h2>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              {atividades.length === 0 ? (
                <div style={{ padding: '16px', textAlign: 'center', color: 'var(--text-muted)', fontSize: '14px' }}>
                  Nenhuma atividade registrada
                </div>
              ) : (
                atividades.slice(0, 10).map((a, i) => {
                  const info = getAtividadeInfo(a.tipo);
                  return (
                    <div key={a.id || i} style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '12px',
                      padding: '10px 14px',
                      background: 'var(--bg-primary)',
                      borderRadius: 'var(--radius-sm)',
                      border: '1px solid var(--border)'
                    }}>
                      <div style={{
                        width: '8px', height: '8px', borderRadius: '50%',
                        background: info.color, flexShrink: 0
                      }} />
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ 
                          fontWeight: '500', color: 'var(--text-primary)', 
                          fontSize: '14px', fontFamily: 'Outfit, sans-serif',
                          whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'
                        }}>
                          {info.action}: {a.titulo}
                        </div>
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)', fontFamily: 'Outfit, sans-serif' }}>
                          {a.usuario_nome || 'Sistema'} {a.detalhes && `• ${a.detalhes}`}
                        </div>
                      </div>
                      <div style={{ 
                        fontSize: '12px', color: 'var(--text-muted)', 
                        fontFamily: 'Outfit, sans-serif', flexShrink: 0 
                      }}>
                        {formatTimeAgo(a.criado_em)}
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        </div>
      );
    };
    
    const QuickActionButton = ({ icon, label, onClick }) => {
      const ActionIcon = ({ type }) => {
        const icons = {
          users: (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          ),
          music: (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 18V5l12-2v13"/>
              <circle cx="6" cy="18" r="3"/>
              <circle cx="18" cy="16" r="3"/>
            </svg>
          ),
          folder: (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </svg>
          ),
          upload: (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
          )
        };
        return icons[type] || icons.music;
      };
      
      return (
        <button onClick={onClick} style={{
          display: 'flex', alignItems: 'center', gap: '8px',
          padding: '12px 20px', borderRadius: 'var(--radius-sm)',
          background: 'linear-gradient(135deg, #722F37 0%, #5C1A1B 100%)',
          color: '#F4E4BC', border: '1px solid rgba(212, 175, 55, 0.3)',
          fontSize: '14px', fontWeight: '500', cursor: 'pointer',
          transition: 'all 0.2s',
          fontFamily: 'Outfit, sans-serif',
          boxShadow: '0 2px 6px rgba(0,0,0,0.15)'
        }}>
          <ActionIcon type={icon} />
          <span>{label}</span>
        </button>
      );
    };
    
    // Gerenciamento de Músicos
    const AdminMusicos = () => {
      const { showToast } = useApp();
      const [usuarios, setUsuarios] = useState([]);
      const [instrumentos, setInstrumentos] = useState([]);
      const [loading, setLoading] = useState(true);
      const [search, setSearch] = useState('');
      const [showModal, setShowModal] = useState(false);
      const [editingUser, setEditingUser] = useState(null);
      const [showResetPin, setShowResetPin] = useState(null);
      
      const loadData = async () => {
        setLoading(true);
        try {
          const [users, instr] = await Promise.all([
            API.getUsuarios(),
            API.getInstrumentos()
          ]);
          setUsuarios(users || []);
          setInstrumentos(instr || []);
        } catch (e) {
          showToast('Erro ao carregar dados', 'error');
        }
        setLoading(false);
      };
      
      useEffect(() => { loadData(); }, []);
      
      // Listener para ação de novo
      useEffect(() => {
        const handler = (e) => {
          if (e.detail === 'novo') setShowModal(true);
        };
        window.addEventListener('admin-musicos-action', handler);
        return () => window.removeEventListener('admin-musicos-action', handler);
      }, []);
      
      const filtered = usuarios.filter(u => 
        !u.admin && (
          u.nome?.toLowerCase().includes(search.toLowerCase()) ||
          u.username?.toLowerCase().includes(search.toLowerCase())
        )
      );
      
      const handleSave = async (data) => {
        try {
          if (editingUser) {
            await API.updateUsuario(editingUser.id, data);
            showToast('Músico atualizado!');
          } else {
            await API.createUsuario(data);
            showToast('Músico cadastrado!');
          }
          setShowModal(false);
          setEditingUser(null);
          loadData();
        } catch (e) {
          showToast(e.message, 'error');
        }
      };
      
      const handleResetPin = async (userId, newPin) => {
        try {
          await API.updateUsuario(userId, { pin: newPin });
          showToast('PIN resetado!');
          setShowResetPin(null);
        } catch (e) {
          showToast(e.message, 'error');
        }
      };
      
      const handleToggleAtivo = async (user) => {
        try {
          await API.updateUsuario(user.id, { ativo: !user.ativo });
          showToast(user.ativo ? 'Músico desativado' : 'Músico reativado');
          loadData();
        } catch (e) {
          showToast(e.message, 'error');
        }
      };
      
      return (
        <div style={{ padding: '32px', maxWidth: '1000px', margin: '0 auto', fontFamily: 'Outfit, sans-serif' }}>
          {/* Header */}
          <div style={{ marginBottom: '32px', textAlign: 'center' }}>
            <h1 style={{ fontSize: '26px', fontWeight: '700', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', marginBottom: '8px' }}>
              <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              Músicos
            </h1>
            <p style={{ color: 'var(--text-muted)', fontSize: '14px' }}>
              Gerencie os membros da filarmônica
            </p>
          </div>
          
          {/* Botão Novo Músico - Destacado */}
          <div style={{ marginBottom: '24px', display: 'flex', justifyContent: 'center' }}>
            <button onClick={() => { setEditingUser(null); setShowModal(true); }} style={{
              display: 'flex', alignItems: 'center', gap: '10px',
              padding: '14px 28px', borderRadius: '12px',
              background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
              color: '#1a1a1a', border: 'none',
              fontSize: '15px', fontWeight: '600', cursor: 'pointer',
              fontFamily: 'Outfit, sans-serif',
              boxShadow: '0 4px 16px rgba(212, 175, 55, 0.3)',
              transition: 'all 0.2s'
            }}
            onMouseEnter={e => e.target.style.transform = 'translateY(-2px)'}
            onMouseLeave={e => e.target.style.transform = 'translateY(0)'}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Novo Músico
            </button>
          </div>
          
          {/* Search - Estilo profissional */}
          <div style={{ marginBottom: '24px' }}>
            <div className="search-bar" style={{ maxWidth: '100%' }}>
              <svg className="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input
                type="text"
                placeholder="Buscar músico pelo nome ou instrumento..."
                value={search}
                onChange={e => setSearch(e.target.value)}
              />
              {search && (
                <button className="clear-btn" onClick={() => setSearch('')}>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              )}
            </div>
          </div>
          
          {/* Stats */}
          <div style={{ marginBottom: '20px', color: 'var(--text-secondary)', fontSize: '14px', display: 'flex', gap: '16px', alignItems: 'center' }}>
            <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
              <span style={{ width: '8px', height: '8px', borderRadius: '50%', background: '#22c55e' }}></span>
              {filtered.filter(u => u.ativo).length} ativos
            </span>
            <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
              <span style={{ width: '8px', height: '8px', borderRadius: '50%', background: '#ef4444' }}></span>
              {filtered.filter(u => !u.ativo).length} inativos
            </span>
          </div>
          
          {/* Lista */}
          {loading ? (
            <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
              Carregando...
            </div>
          ) : (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              {filtered.map(user => (
                <div key={user.id} style={{
                  display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                  padding: '16px 20px', background: 'var(--bg-secondary)',
                  borderRadius: 'var(--radius-md)', border: '1px solid var(--border)',
                  opacity: user.ativo ? 1 : 0.6
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    {/* Avatar com círculo dourado */}
                    <div style={{
                      width: '52px', height: '52px', borderRadius: '50%',
                      background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
                      padding: '3px',
                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                      boxShadow: '0 2px 8px rgba(212, 175, 55, 0.3)'
                    }}>
                      <div style={{
                        width: '100%', height: '100%', borderRadius: '50%',
                        background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: '20px', color: '#F4E4BC', fontWeight: '600',
                        fontFamily: 'Outfit, sans-serif'
                      }}>
                        {user.nome?.charAt(0)?.toUpperCase() || '?'}
                      </div>
                    </div>
                    <div>
                      <div style={{ fontWeight: '600', color: 'var(--text-primary)', marginBottom: '2px' }}>
                        {user.nome}
                        {!user.ativo && <span style={{ marginLeft: '8px', fontSize: '12px', color: '#e74c3c' }}>(inativo)</span>}
                      </div>
                      <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                        @{user.username} • {user.instrumento_nome || 'Sem instrumento'}
                      </div>
                      {user.ultimo_acesso && (
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '2px' }}>
                          Último acesso: {new Date(user.ultimo_acesso).toLocaleDateString('pt-BR')}
                        </div>
                      )}
                    </div>
                  </div>
                  <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <button onClick={() => { setEditingUser(user); setShowModal(true); }} title="Editar" style={{
                      width: '40px', height: '40px', borderRadius: 'var(--radius-sm)',
                      background: 'var(--bg-primary)', border: '1px solid var(--border)',
                      color: 'var(--text-secondary)', cursor: 'pointer',
                      display: 'flex', alignItems: 'center', justifyContent: 'center'
                    }}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                      </svg>
                    </button>
                    <button onClick={() => setShowResetPin(user)} title="Redefinir PIN" style={{
                      width: '40px', height: '40px', borderRadius: 'var(--radius-sm)',
                      background: 'var(--bg-primary)', border: '1px solid var(--border)',
                      color: 'var(--text-secondary)', cursor: 'pointer',
                      display: 'flex', alignItems: 'center', justifyContent: 'center'
                    }}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                      </svg>
                    </button>
                    <button onClick={() => handleToggleAtivo(user)} title={user.ativo ? 'Desativar' : 'Ativar'} style={{
                      width: '40px', height: '40px', borderRadius: 'var(--radius-sm)',
                      background: user.ativo ? 'rgba(231, 76, 60, 0.1)' : 'rgba(39, 174, 96, 0.1)',
                      border: '1px solid ' + (user.ativo ? 'rgba(231, 76, 60, 0.3)' : 'rgba(39, 174, 96, 0.3)'),
                      color: user.ativo ? '#e74c3c' : '#27ae60', cursor: 'pointer',
                      display: 'flex', alignItems: 'center', justifyContent: 'center'
                    }}>
                      {user.ativo ? (
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <circle cx="12" cy="12" r="10"/>
                          <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                        </svg>
                      ) : (
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                      )}
                    </button>
                  </div>
                </div>
              ))}
              {filtered.length === 0 && (
                <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                  Nenhum músico encontrado
                </div>
              )}
            </div>
          )}
          
          {/* Modal de Criar/Editar */}
          {showModal && (
            <UsuarioFormModal
              usuario={editingUser}
              instrumentos={instrumentos}
              onSave={handleSave}
              onClose={() => { setShowModal(false); setEditingUser(null); }}
            />
          )}
          
          {/* Modal de Reset PIN */}
          {showResetPin && (
            <ResetPinModal
              usuario={showResetPin}
              onReset={handleResetPin}
              onClose={() => setShowResetPin(null)}
            />
          )}
        </div>
      );
    };
    
    // Modal de Formulário de Usuário - Redesenhado
    const UsuarioFormModal = ({ usuario, instrumentos, onSave, onClose }) => {
      const [nome, setNome] = useState(usuario?.nome || '');
      const [username, setUsername] = useState(usuario?.username || '');
      const [pin, setPin] = useState('');
      const [instrumentoId, setInstrumentoId] = useState(usuario?.instrumento_id || '');
      const [isAdmin, setIsAdmin] = useState(usuario?.admin || false);
      const [saving, setSaving] = useState(false);
      const [showInstrumentoDropdown, setShowInstrumentoDropdown] = useState(false);
      const [instrumentoSearch, setInstrumentoSearch] = useState('');
      
      // Auto-gerar username e PIN quando nome mudar (apenas para novo usuário)
      React.useEffect(() => {
        if (!usuario && nome.trim().length > 2) {
          // Gerar username
          const normalized = nome.trim().toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9\s]/g, '')
            .replace(/\s+/g, '');
          setUsername(normalized);
          
          // Gerar PIN de 4 dígitos aleatório se ainda não tiver
          if (!pin) {
            const randomPin = Math.floor(1000 + Math.random() * 9000).toString();
            setPin(randomPin);
          }
        }
      }, [nome, usuario]);
      
      const handleSubmit = async () => {
        if (!nome.trim()) return;
        if (!usuario && (!username.trim() || !pin || pin.length !== 4)) return;
        
        setSaving(true);
        const data = {
          nome: nome.trim(),
          instrumento_id: instrumentoId || null,
          admin: isAdmin
        };
        if (!usuario) {
          data.username = username.trim().toLowerCase();
          data.pin = pin;
        }
        await onSave(data);
        setSaving(false);
      };
      
      const gerarUsername = () => {
        const normalized = nome.trim().toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9\s]/g, '')
          .replace(/\s+/g, '');
        setUsername(normalized);
      };
      
      const gerarPin = () => {
        const randomPin = Math.floor(1000 + Math.random() * 9000).toString();
        setPin(randomPin);
      };
      
      const selectedInstrumento = instrumentos.find(i => i.id == instrumentoId);
      const filteredInstrumentos = instrumentoSearch 
        ? instrumentos.filter(i => i.nome.toLowerCase().includes(instrumentoSearch.toLowerCase()))
        : instrumentos;
      
      return (
        <div style={{
          position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.6)',
          display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000,
          backdropFilter: 'blur(4px)'
        }} onClick={onClose}>
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: '16px',
            padding: '32px', width: '100%', maxWidth: '480px', maxHeight: '90vh', overflow: 'auto',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            animation: 'scaleInLogin 0.25s ease-out'
          }} onClick={e => e.stopPropagation()}>
            
            {/* Header */}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '28px' }}>
              <h2 style={{ fontSize: '22px', fontWeight: '600', color: 'var(--text-primary)', margin: 0 }}>
                {usuario ? 'Editar Músico' : 'Novo Músico'}
              </h2>
              <button onClick={onClose} style={{
                width: '32px', height: '32px', borderRadius: '8px',
                background: 'var(--bg-primary)', border: '1px solid var(--border)',
                color: 'var(--text-muted)', cursor: 'pointer',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                transition: 'all 0.15s'
              }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            
            {/* Nome Completo */}
            <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
              Nome Completo <span style={{ color: '#e74c3c' }}>*</span>
            </label>
            <input
              type="text"
              placeholder="Ex: João da Silva Santos"
              value={nome}
              onChange={e => setNome(e.target.value)}
              style={{
                width: '100%', padding: '14px 16px', borderRadius: '10px',
                border: '1.5px solid var(--border)', background: 'var(--bg-primary)',
                color: 'var(--text-primary)', fontSize: '15px', marginBottom: '20px',
                transition: 'border-color 0.2s, box-shadow 0.2s'
              }}
            />
            
            {!usuario && (
              <>
                {/* Username e PIN lado a lado */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                  {/* Username */}
                  <div>
                    <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                      Login <span style={{ color: '#e74c3c' }}>*</span>
                    </label>
                    <div style={{ position: 'relative' }}>
                      <input
                        type="text"
                        placeholder="joaosilva"
                        value={username}
                        onChange={e => setUsername(e.target.value.toLowerCase().replace(/[^a-z0-9]/g, ''))}
                        style={{
                          width: '100%', padding: '14px 16px', paddingRight: '50px', borderRadius: '10px',
                          border: '1.5px solid var(--border)', background: 'var(--bg-primary)',
                          color: 'var(--text-primary)', fontSize: '15px',
                          transition: 'border-color 0.2s'
                        }}
                      />
                      <button onClick={gerarUsername} title="Gerar automaticamente" style={{
                        position: 'absolute', right: '6px', top: '50%', transform: 'translateY(-50%)',
                        padding: '6px 10px', borderRadius: '6px',
                        background: 'var(--bg-secondary)', border: '1px solid var(--border)',
                        color: 'var(--text-muted)', cursor: 'pointer', fontSize: '11px',
                        transition: 'all 0.15s'
                      }}>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  {/* PIN */}
                  <div>
                    <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                      PIN <span style={{ color: '#e74c3c' }}>*</span>
                    </label>
                    <div style={{ position: 'relative' }}>
                      <input
                        type="text"
                        placeholder="1234"
                        maxLength={4}
                        value={pin}
                        onChange={e => setPin(e.target.value.replace(/\D/g, ''))}
                        style={{
                          width: '100%', padding: '14px 16px', paddingRight: '50px', borderRadius: '10px',
                          border: '1.5px solid var(--border)', background: 'var(--bg-primary)',
                          color: 'var(--text-primary)', fontSize: '15px', letterSpacing: '4px',
                          transition: 'border-color 0.2s'
                        }}
                      />
                      <button onClick={gerarPin} title="Gerar novo PIN" style={{
                        position: 'absolute', right: '6px', top: '50%', transform: 'translateY(-50%)',
                        padding: '6px 10px', borderRadius: '6px',
                        background: 'var(--bg-secondary)', border: '1px solid var(--border)',
                        color: 'var(--text-muted)', cursor: 'pointer', fontSize: '11px',
                        transition: 'all 0.15s'
                      }}>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
                
                <p style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '-12px', marginBottom: '20px' }}>
                  Campos gerados automaticamente. Clique nos ícones para regenerar.
                </p>
              </>
            )}
            
            {/* Instrumento - Dropdown customizado */}
            <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
              Instrumento
            </label>
            <div style={{ position: 'relative', marginBottom: '20px' }}>
              <button
                type="button"
                onClick={() => setShowInstrumentoDropdown(!showInstrumentoDropdown)}
                style={{
                  width: '100%', padding: '14px 16px', borderRadius: '10px',
                  border: '1.5px solid var(--border)', background: 'var(--bg-primary)',
                  color: selectedInstrumento ? 'var(--text-primary)' : 'var(--text-muted)',
                  fontSize: '15px', textAlign: 'left', cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                  transition: 'border-color 0.2s'
                }}
              >
                <span>{selectedInstrumento ? selectedInstrumento.nome : 'Selecione o instrumento'}</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{
                  transform: showInstrumentoDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                  transition: 'transform 0.2s'
                }}>
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </button>
              
              {showInstrumentoDropdown && (
                <div style={{
                  position: 'absolute', top: 'calc(100% + 4px)', left: 0, right: 0,
                  background: 'var(--bg-secondary)', border: '1.5px solid var(--border)',
                  borderRadius: '10px', boxShadow: '0 8px 24px rgba(0,0,0,0.15)',
                  zIndex: 10, maxHeight: '240px', overflow: 'hidden'
                }}>
                  {/* Busca */}
                  <div style={{ padding: '10px', borderBottom: '1px solid var(--border)' }}>
                    <input
                      type="text"
                      placeholder="Buscar instrumento..."
                      value={instrumentoSearch}
                      onChange={e => setInstrumentoSearch(e.target.value)}
                      autoFocus
                      style={{
                        width: '100%', padding: '10px 12px', borderRadius: '8px',
                        border: '1px solid var(--border)', background: 'var(--bg-primary)',
                        color: 'var(--text-primary)', fontSize: '14px'
                      }}
                    />
                  </div>
                  
                  {/* Lista */}
                  <div style={{ maxHeight: '180px', overflowY: 'auto' }}>
                    <button
                      onClick={() => { setInstrumentoId(''); setShowInstrumentoDropdown(false); setInstrumentoSearch(''); }}
                      style={{
                        width: '100%', padding: '12px 16px', border: 'none',
                        background: !instrumentoId ? 'var(--bg-primary)' : 'transparent',
                        color: 'var(--text-muted)', fontSize: '14px', textAlign: 'left',
                        cursor: 'pointer', transition: 'background 0.15s'
                      }}
                    >
                      Nenhum instrumento
                    </button>
                    {filteredInstrumentos.map(inst => (
                      <button
                        key={inst.id}
                        onClick={() => { setInstrumentoId(inst.id); setShowInstrumentoDropdown(false); setInstrumentoSearch(''); }}
                        style={{
                          width: '100%', padding: '12px 16px', border: 'none',
                          background: instrumentoId == inst.id ? 'rgba(212, 175, 55, 0.15)' : 'transparent',
                          color: instrumentoId == inst.id ? '#D4AF37' : 'var(--text-primary)',
                          fontSize: '14px', textAlign: 'left', cursor: 'pointer',
                          transition: 'background 0.15s', fontWeight: instrumentoId == inst.id ? '500' : '400'
                        }}
                        onMouseEnter={e => { if (instrumentoId != inst.id) e.target.style.background = 'var(--bg-primary)'; }}
                        onMouseLeave={e => { if (instrumentoId != inst.id) e.target.style.background = 'transparent'; }}
                      >
                        {inst.nome}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            {/* Checkbox Administrador - Estilizado */}
            <label style={{
              display: 'flex', alignItems: 'center', gap: '14px', cursor: 'pointer',
              padding: '16px', background: isAdmin ? 'rgba(212, 175, 55, 0.1)' : 'var(--bg-primary)',
              borderRadius: '12px', marginBottom: '28px',
              border: isAdmin ? '1.5px solid rgba(212, 175, 55, 0.3)' : '1.5px solid var(--border)',
              transition: 'all 0.2s'
            }}>
              {/* Toggle Switch */}
              <div style={{
                width: '44px', height: '24px', borderRadius: '12px',
                background: isAdmin ? '#D4AF37' : 'var(--border)',
                position: 'relative', transition: 'background 0.2s',
                flexShrink: 0
              }}>
                <div style={{
                  position: 'absolute', top: '2px',
                  left: isAdmin ? '22px' : '2px',
                  width: '20px', height: '20px', borderRadius: '10px',
                  background: '#fff', boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                  transition: 'left 0.2s ease'
                }} />
              </div>
              <input 
                type="checkbox" 
                checked={isAdmin} 
                onChange={e => setIsAdmin(e.target.checked)} 
                style={{ display: 'none' }}
              />
              <div>
                <span style={{ color: 'var(--text-primary)', fontWeight: '500', fontSize: '14px' }}>
                  Este músico é administrador
                </span>
                <p style={{ fontSize: '12px', color: 'var(--text-muted)', margin: '4px 0 0 0' }}>
                  Terá acesso ao painel de gerenciamento
                </p>
              </div>
            </label>
            
            {/* Botões */}
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onClose} style={{
                flex: 1, padding: '14px', borderRadius: '10px',
                background: 'var(--bg-primary)', border: '1.5px solid var(--border)',
                color: 'var(--text-primary)', fontSize: '14px', fontWeight: '500', cursor: 'pointer',
                transition: 'all 0.15s'
              }}>
                Cancelar
              </button>
              <button onClick={handleSubmit} disabled={saving} style={{
                flex: 1, padding: '14px', borderRadius: '10px',
                background: '#D4AF37', border: 'none',
                color: '#1a1a1a', fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                opacity: saving ? 0.7 : 1, transition: 'all 0.15s'
              }}>
                {saving ? 'Salvando...' : (usuario ? 'Salvar Alterações' : 'Cadastrar Músico')}
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    // Modal de Reset PIN
    const ResetPinModal = ({ usuario, onReset, onClose }) => {
      const [newPin, setNewPin] = useState('1234');
      
      return (
        <div style={{
          position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)',
          display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)',
            padding: '28px', width: '100%', maxWidth: '360px'
          }} onClick={e => e.stopPropagation()}>
            <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-primary)' }}>
              Resetar PIN
            </h2>
            <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '20px' }}>
              Resetar PIN de <strong>{usuario.nome}</strong>
            </p>
            
            <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', marginBottom: '6px', color: 'var(--text-secondary)' }}>
              Novo PIN (4 dígitos)
            </label>
            <input
              type="text" maxLength={4}
              style={{
                width: '100%', padding: '12px 14px', borderRadius: 'var(--radius-sm)',
                border: '1px solid var(--border)', background: 'var(--bg-primary)',
                color: 'var(--text-primary)', fontSize: '18px', textAlign: 'center',
                letterSpacing: '8px', marginBottom: '20px'
              }}
              value={newPin} onChange={e => setNewPin(e.target.value.replace(/\D/g, ''))}
            />
            
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onClose} style={{
                flex: 1, padding: '12px', borderRadius: 'var(--radius-sm)',
                background: 'var(--bg-primary)', border: '1px solid var(--border)',
                color: 'var(--text-primary)', fontSize: '14px', cursor: 'pointer'
              }}>
                Cancelar
              </button>
              <button onClick={() => onReset(usuario.id, newPin)} disabled={newPin.length !== 4} style={{
                flex: 1, padding: '12px', borderRadius: 'var(--radius-sm)',
                background: 'var(--accent)', border: 'none',
                color: '#fff', fontSize: '14px', fontWeight: '500', cursor: 'pointer',
                opacity: newPin.length !== 4 ? 0.5 : 1
              }}>
                Resetar
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    // Dropdown customizado de categorias
    const CategoryDropdown = ({ value, onChange, categorias, placeholder = "Todas categorias" }) => {
      const [isOpen, setIsOpen] = useState(false);
      const dropdownRef = React.useRef(null);
      
      const selectedCategoria = categorias.find(c => c.id === value);
      
      // Fechar ao clicar fora
      React.useEffect(() => {
        const handleClickOutside = (e) => {
          if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
            setIsOpen(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);
      
      return (
        <div ref={dropdownRef} style={{ position: 'relative' }}>
          <button
            type="button"
            onClick={() => setIsOpen(!isOpen)}
            style={{
              width: '100%',
              padding: '12px 16px',
              borderRadius: '12px',
              border: '1.5px solid var(--border)',
              background: 'var(--bg-card)',
              color: selectedCategoria ? 'var(--text-primary)' : 'var(--text-muted)',
              fontSize: '14px',
              fontFamily: 'Outfit, sans-serif',
              textAlign: 'left',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              gap: '12px',
              transition: 'all 0.2s',
              boxShadow: isOpen ? '0 0 0 3px rgba(212, 175, 55, 0.15)' : '0 1px 3px rgba(0,0,0,0.05)'
            }}
          >
            <span style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
              {selectedCategoria && (
                <span style={{
                  width: '24px', height: '24px', borderRadius: '6px',
                  background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                  border: '1px solid rgba(212, 175, 55, 0.2)'
                }}>
                  <CategoryIcon categoryId={selectedCategoria.id} size={14} color="#D4AF37" />
                </span>
              )}
              {selectedCategoria ? selectedCategoria.nome : placeholder}
            </span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{
              transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)',
              transition: 'transform 0.2s',
              flexShrink: 0
            }}>
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </button>
          
          {isOpen && (
            <div style={{
              position: 'absolute',
              top: 'calc(100% + 4px)',
              left: 0,
              right: 0,
              background: 'var(--bg-secondary)',
              border: '1.5px solid var(--border)',
              borderRadius: '12px',
              boxShadow: '0 8px 24px rgba(0,0,0,0.15)',
              zIndex: 100,
              maxHeight: '280px',
              overflowY: 'auto'
            }}>
              {/* Opção "Todas" */}
              <button
                onClick={() => { onChange(''); setIsOpen(false); }}
                style={{
                  width: '100%',
                  padding: '12px 16px',
                  border: 'none',
                  background: !value ? 'rgba(212, 175, 55, 0.1)' : 'transparent',
                  color: !value ? '#D4AF37' : 'var(--text-primary)',
                  fontSize: '14px',
                  fontFamily: 'Outfit, sans-serif',
                  textAlign: 'left',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '10px',
                  transition: 'background 0.15s'
                }}
                onMouseEnter={e => { if (value) e.target.style.background = 'var(--bg-primary)'; }}
                onMouseLeave={e => { if (value) e.target.style.background = 'transparent'; }}
              >
                <span style={{
                  width: '24px', height: '24px', borderRadius: '6px',
                  background: 'var(--bg-primary)',
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                  border: '1px solid var(--border)'
                }}>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                  </svg>
                </span>
                {placeholder}
              </button>
              
              {/* Lista de categorias */}
              {categorias.map(cat => (
                <button
                  key={cat.id}
                  onClick={() => { onChange(cat.id); setIsOpen(false); }}
                  style={{
                    width: '100%',
                    padding: '12px 16px',
                    border: 'none',
                    background: value === cat.id ? 'rgba(212, 175, 55, 0.1)' : 'transparent',
                    color: value === cat.id ? '#D4AF37' : 'var(--text-primary)',
                    fontSize: '14px',
                    fontFamily: 'Outfit, sans-serif',
                    textAlign: 'left',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    transition: 'background 0.15s'
                  }}
                  onMouseEnter={e => { if (value !== cat.id) e.target.style.background = 'var(--bg-primary)'; }}
                  onMouseLeave={e => { if (value !== cat.id) e.target.style.background = 'transparent'; }}
                >
                  <span style={{
                    width: '24px', height: '24px', borderRadius: '6px',
                    background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    border: '1px solid rgba(212, 175, 55, 0.2)'
                  }}>
                    <CategoryIcon categoryId={cat.id} size={14} color="#D4AF37" />
                  </span>
                  {cat.nome}
                </button>
              ))}
            </div>
          )}
        </div>
      );
    };
    
    // Gerenciamento de Partituras
    const AdminPartituras = () => {
      const { showToast } = useApp();
      const [partituras, setPartituras] = useState([]);
      const [categorias, setCategorias] = useState([]);
      const [loading, setLoading] = useState(true);
      const [search, setSearch] = useState('');
      const [filterCategoria, setFilterCategoria] = useState('');
      const [showModal, setShowModal] = useState(false);
      const [editingPartitura, setEditingPartitura] = useState(null);
      const [showUploadPasta, setShowUploadPasta] = useState(false);
      const [showPartesModal, setShowPartesModal] = useState(false);
      const [selectedPartituraPartes, setSelectedPartituraPartes] = useState(null);
      
      // Função de distância Levenshtein para busca fuzzy
      const levenshtein = (a, b) => {
        if (!a || !b) return 999;
        const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
        for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
        for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
        for (let j = 1; j <= b.length; j++) {
          for (let i = 1; i <= a.length; i++) {
            const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
              matrix[j][i - 1] + 1,
              matrix[j - 1][i] + 1,
              matrix[j - 1][i - 1] + indicator
            );
          }
        }
        return matrix[b.length][a.length];
      };
      
      // Normaliza texto removendo acentos
      const normalizeText = (text) => {
        if (!text) return '';
        return text.toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .trim();
      };
      
      const loadData = async () => {
        setLoading(true);
        try {
          const [parts, cats] = await Promise.all([
            API.getPartituras(),
            API.getCategorias()
          ]);
          setPartituras(parts || []);
          setCategorias(cats || []);
        } catch (e) {
          showToast('Erro ao carregar dados', 'error');
        }
        setLoading(false);
      };
      
      useEffect(() => { loadData(); }, []);
      
      useEffect(() => {
        const handler = (e) => {
          if (e.detail === 'novo') setShowModal(true);
          if (e.detail === 'pasta') setShowUploadPasta(true);
        };
        window.addEventListener('admin-partituras-action', handler);
        return () => window.removeEventListener('admin-partituras-action', handler);
      }, []);
      
      // Busca fuzzy com scoring
      const filtered = React.useMemo(() => {
        const query = normalizeText(search);
        
        if (!query) {
          // Sem busca, só filtra por categoria
          return partituras
            .filter(p => !filterCategoria || p.categoria_id === filterCategoria)
            .sort((a, b) => a.titulo?.localeCompare(b.titulo, 'pt-BR'));
        }
        
        // Com busca, aplica fuzzy matching
        return partituras
          .map(p => {
            const tituloNorm = normalizeText(p.titulo);
            const compositorNorm = normalizeText(p.compositor);
            
            let score = 0;
            
            // Match exato (maior pontuação)
            if (tituloNorm.startsWith(query)) score += 100;
            else if (tituloNorm.includes(query)) score += 50;
            
            if (compositorNorm.startsWith(query)) score += 80;
            else if (compositorNorm.includes(query)) score += 40;
            
            // Match por palavras individuais
            const queryWords = query.split(/\s+/);
            const tituloWords = tituloNorm.split(/\s+/);
            const compositorWords = compositorNorm.split(/\s+/);
            
            queryWords.forEach(qWord => {
              if (qWord.length < 2) return;
              
              // Verifica cada palavra do título
              tituloWords.forEach(tWord => {
                if (tWord.startsWith(qWord)) score += 30;
                else if (tWord.includes(qWord)) score += 15;
                else {
                  const dist = levenshtein(qWord, tWord.slice(0, qWord.length + 2));
                  if (dist <= 2) score += (20 - dist * 8);
                }
              });
              
              // Verifica cada palavra do compositor
              compositorWords.forEach(cWord => {
                if (cWord.startsWith(qWord)) score += 25;
                else if (cWord.includes(qWord)) score += 12;
                else {
                  const dist = levenshtein(qWord, cWord.slice(0, qWord.length + 2));
                  if (dist <= 2) score += (15 - dist * 6);
                }
              });
            });
            
            // Levenshtein no início do título (para erros de digitação)
            const titleDist = levenshtein(query, tituloNorm.slice(0, query.length + 2));
            if (titleDist <= 2) score += (25 - titleDist * 10);
            
            return { ...p, score };
          })
          .filter(p => {
            const matchCategoria = !filterCategoria || p.categoria_id === filterCategoria;
            return p.score > 0 && matchCategoria;
          })
          .sort((a, b) => b.score - a.score);
      }, [partituras, search, filterCategoria]);
      
      // Agrupar por letra inicial
      const groupedByLetter = filtered.reduce((acc, p) => {
        const letter = p.titulo?.charAt(0)?.toUpperCase() || '#';
        if (!acc[letter]) acc[letter] = [];
        acc[letter].push(p);
        return acc;
      }, {});
      
      const sortedLetters = Object.keys(groupedByLetter).sort((a, b) => a.localeCompare(b, 'pt-BR'));
      
      const handleDelete = async (id) => {
        if (!confirm('Remover esta partitura?')) return;
        try {
          await API.deletePartitura(id);
          showToast('Partitura removida!');
          loadData();
        } catch (e) {
          showToast(e.message, 'error');
        }
      };
      
      const toggleDestaque = async (partitura) => {
        const novoDestaque = partitura.destaque === 1 ? 0 : 1;
        
        // 1. Atualiza UI imediatamente (otimista)
        setPartituras(prev => prev.map(p => 
          p.id === partitura.id ? { ...p, destaque: novoDestaque } : p
        ));
        
        try {
          // 2. Envia para API em background
          await API.updatePartitura(partitura.id, { ...partitura, destaque: novoDestaque });
          showToast(novoDestaque ? 'Adicionado aos destaques!' : 'Removido dos destaques');
        } catch (e) {
          // 3. Se falhar, reverte para estado anterior
          setPartituras(prev => prev.map(p => 
            p.id === partitura.id ? { ...p, destaque: partitura.destaque } : p
          ));
          showToast(e.message, 'error');
        }
      };
      
      const getCategoriaInfo = (id) => categorias.find(c => c.id === id) || {};
      
      return (
        <div style={{ padding: '32px', maxWidth: '1000px', margin: '0 auto', fontFamily: 'Outfit, sans-serif' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', flexWrap: 'wrap', gap: '12px' }}>
            <h1 style={{ fontSize: '24px', fontWeight: '700', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '10px' }}>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
              </svg>
              Partituras
            </h1>
            <div style={{ display: 'flex', gap: '10px' }}>
              <button onClick={() => setShowUploadPasta(true)} style={{
                display: 'flex', alignItems: 'center', gap: '8px',
                padding: '10px 20px', borderRadius: 'var(--radius-sm)',
                background: 'linear-gradient(135deg, #D4AF37 0%, #B8860B 100%)', color: '#fff', border: 'none',
                fontSize: '14px', fontWeight: '500', cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif'
              }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Upload de Pasta
              </button>
              <button onClick={() => { setEditingPartitura(null); setShowModal(true); }} style={{
                display: 'flex', alignItems: 'center', gap: '8px',
                padding: '10px 20px', borderRadius: 'var(--radius-sm)',
                background: 'linear-gradient(135deg, #2C3E50 0%, #1a252f 100%)',
                color: '#fff', border: '2px solid #34495e',
                fontSize: '14px', fontWeight: '500', cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif',
                boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
              }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Nova Partitura
              </button>
            </div>
          </div>
          
          {/* Filtros - Redesenhados */}
          <div style={{ display: 'flex', gap: '12px', marginBottom: '20px', flexWrap: 'wrap' }}>
            {/* Barra de busca */}
            <div style={{ flex: 1, minWidth: '250px' }}>
              <div className="search-bar">
                <svg className="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
                <input
                  type="text" 
                  placeholder="Buscar por título ou compositor..."
                  value={search} 
                  onChange={e => setSearch(e.target.value)}
                />
                {search && (
                  <button className="clear-btn" onClick={() => setSearch('')}>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                )}
              </div>
            </div>
            
            {/* Dropdown de categoria customizado */}
            <div style={{ position: 'relative', minWidth: '200px' }}>
              <CategoryDropdown 
                value={filterCategoria}
                onChange={setFilterCategoria}
                categorias={categorias}
              />
            </div>
          </div>
          
          <div style={{ marginBottom: '20px', color: 'var(--text-secondary)', fontSize: '14px', fontFamily: 'Outfit, sans-serif' }}>
            {filtered.length} partitura(s) {search && `para "${search}"`}
          </div>
          
          {/* Lista agrupada por letra */}
          {loading ? (
            <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)', fontFamily: 'Outfit, sans-serif' }}>
              Carregando...
            </div>
          ) : filtered.length === 0 ? (
            <div style={{ 
              textAlign: 'center', padding: '60px 20px', color: 'var(--text-secondary)', fontFamily: 'Outfit, sans-serif',
              animation: 'fadeIn 0.3s ease'
            }}>
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ opacity: 0.5, marginBottom: '16px' }}>
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <p style={{ margin: 0 }}>Nenhuma partitura encontrada</p>
            </div>
          ) : (
            <div key={`${search}-${filterCategoria}`} style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              {sortedLetters.map((letter, letterIndex) => (
                <div key={letter} style={{
                  animation: 'fadeSlideIn 0.3s ease forwards',
                  animationDelay: `${letterIndex * 0.05}s`,
                  opacity: 0
                }}>
                  {/* Header da letra */}
                  <div style={{ 
                    display: 'flex', alignItems: 'center', gap: '12px', 
                    marginBottom: '12px', paddingBottom: '8px',
                    borderBottom: '2px solid var(--border)'
                  }}>
                    <div style={{
                      width: '36px', height: '36px', borderRadius: '8px',
                      background: 'linear-gradient(135deg, #D4AF37 0%, #B8860B 100%)',
                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                      fontSize: '18px', fontWeight: '700', color: '#fff',
                      fontFamily: 'Outfit, sans-serif',
                      boxShadow: '0 2px 6px rgba(212, 175, 55, 0.3)'
                    }}>
                      {letter}
                    </div>
                    <span style={{ fontSize: '13px', color: 'var(--text-muted)', fontFamily: 'Outfit, sans-serif' }}>
                      {groupedByLetter[letter].length} {groupedByLetter[letter].length === 1 ? 'partitura' : 'partituras'}
                    </span>
                  </div>
                  
                  {/* Lista de partituras desta letra */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {groupedByLetter[letter].map((p, itemIndex) => {
                      const cat = getCategoriaInfo(p.categoria_id);
                      return (
                        <div key={p.id} style={{
                          display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                          padding: '14px 16px', background: 'var(--bg-secondary)',
                          borderRadius: 'var(--radius-md)', border: '1px solid var(--border)',
                          transition: 'all 0.2s ease',
                          animation: 'slideUp 0.35s ease forwards',
                          animationDelay: `${(letterIndex * 0.05) + (itemIndex * 0.03)}s`,
                          opacity: 0
                        }}
                        onMouseEnter={e => {
                          e.currentTarget.style.transform = 'translateX(4px)';
                          e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                          e.currentTarget.style.borderColor = 'var(--accent)';
                        }}
                        onMouseLeave={e => {
                          e.currentTarget.style.transform = 'translateX(0)';
                          e.currentTarget.style.boxShadow = 'none';
                          e.currentTarget.style.borderColor = 'var(--border)';
                        }}
                        >
                          <div style={{ display: 'flex', alignItems: 'center', gap: '14px' }}>
                            <div style={{
                              width: '44px', height: '44px', borderRadius: 'var(--radius-sm)',
                              background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)', display: 'flex',
                              alignItems: 'center', justifyContent: 'center',
                              transition: 'transform 0.2s',
                              border: '1px solid rgba(212, 175, 55, 0.2)'
                            }}>
                              <CategoryIcon categoryId={cat.id || p.categoria_id} size={22} color="#D4AF37" />
                            </div>
                            <div>
                              <div style={{ fontWeight: '600', color: 'var(--text-primary)', marginBottom: '2px', display: 'flex', alignItems: 'center', gap: '8px', fontSize: '15px' }}>
                                {p.titulo}
                                {p.destaque === 1 && (
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="#D4AF37" stroke="#D4AF37" strokeWidth="1">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                  </svg>
                                )}
                              </div>
                              <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                                {p.compositor} • {cat.nome || p.categoria_id} {p.ano && `• ${p.ano}`}
                              </div>
                              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '2px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                  <polyline points="7 10 12 15 17 10"/>
                                  <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                {p.downloads || 0} downloads
                              </div>
                            </div>
                          </div>
                          <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                            {/* Botão Destaque */}
                            <button onClick={() => toggleDestaque(p)} title={p.destaque === 1 ? 'Remover destaque' : 'Destacar'} style={{
                              width: '40px', height: '40px', borderRadius: 'var(--radius-sm)',
                              background: p.destaque === 1 ? 'linear-gradient(135deg, #D4AF37 0%, #B8860B 100%)' : 'var(--bg-primary)',
                              border: p.destaque === 1 ? 'none' : '1px solid var(--border)',
                              color: p.destaque === 1 ? '#fff' : 'var(--text-muted)',
                              cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>
                              <svg width="18" height="18" viewBox="0 0 24 24" fill={p.destaque === 1 ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                              </svg>
                            </button>
                            {/* Botão Partes */}
                            <button onClick={() => { setSelectedPartituraPartes(p); setShowPartesModal(true); }} style={{
                              display: 'flex', alignItems: 'center', gap: '6px',
                              padding: '10px 16px', borderRadius: 'var(--radius-sm)',
                              background: 'linear-gradient(135deg, #D4AF37 0%, #B8860B 100%)',
                              color: '#fff', border: 'none', fontSize: '13px', fontWeight: '500',
                              cursor: 'pointer', fontFamily: 'Outfit, sans-serif'
                            }}>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                              </svg>
                              Partes
                            </button>
                            {/* Botão Editar */}
                            <button onClick={() => { setEditingPartitura(p); setShowModal(true); }} title="Editar" style={{
                              width: '40px', height: '40px', borderRadius: 'var(--radius-sm)',
                              background: 'var(--bg-primary)', border: '1px solid var(--border)',
                              color: 'var(--text-secondary)', cursor: 'pointer',
                              display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                              </svg>
                            </button>
                            {/* Botão Excluir */}
                            <button onClick={() => handleDelete(p.id)} title="Excluir" style={{
                              width: '40px', height: '40px', borderRadius: 'var(--radius-sm)',
                              background: 'rgba(231, 76, 60, 0.1)', border: '1px solid rgba(231, 76, 60, 0.3)',
                              color: '#e74c3c', cursor: 'pointer',
                              display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
          
          {/* Modal de Partitura Individual */}
          {showModal && (
            <PartituraFormModal
              partitura={editingPartitura}
              categorias={categorias}
              onSave={() => { setShowModal(false); setEditingPartitura(null); loadData(); }}
              onClose={() => { setShowModal(false); setEditingPartitura(null); }}
            />
          )}
          
          {/* Modal de Upload de Pasta */}
          {showUploadPasta && (
            <UploadPastaModal
              categorias={categorias}
              onSave={() => { setShowUploadPasta(false); loadData(); }}
              onClose={() => setShowUploadPasta(false)}
            />
          )}
          
          {/* Modal de Gerenciar Partes */}
          {showPartesModal && selectedPartituraPartes && (
            <GerenciarPartesModal
              partitura={selectedPartituraPartes}
              onSave={() => { setShowPartesModal(false); setSelectedPartituraPartes(null); loadData(); }}
              onClose={() => { setShowPartesModal(false); setSelectedPartituraPartes(null); }}
            />
          )}
        </div>
      );
    };
    
    // Modal de Formulário de Partitura
    const PartituraFormModal = ({ partitura, categorias, onSave, onClose }) => {
      const { showToast } = useApp();
      const [titulo, setTitulo] = useState(partitura?.titulo || '');
      const [compositor, setCompositor] = useState(partitura?.compositor || '');
      const [arranjador, setArranjador] = useState(partitura?.arranjador || '');
      const [categoria, setCategoria] = useState(partitura?.categoria_id || categorias[0]?.id || '');
      const [ano, setAno] = useState(partitura?.ano || '');
      const [descricao, setDescricao] = useState(partitura?.descricao || '');
      const [destaque, setDestaque] = useState(partitura?.destaque === 1);
      const [arquivo, setArquivo] = useState(null);
      const [saving, setSaving] = useState(false);
      const [showCatDropdown, setShowCatDropdown] = useState(false);
      
      const handleSubmit = async () => {
        if (!titulo.trim() || !compositor.trim() || !categoria) {
          showToast('Preencha os campos obrigatórios', 'error');
          return;
        }
        if (!partitura && !arquivo) {
          showToast('Selecione o arquivo PDF', 'error');
          return;
        }
        
        setSaving(true);
        try {
          if (partitura) {
            // Atualizar
            await API.updatePartitura(partitura.id, {
              titulo, compositor, arranjador, categoria, ano: ano || null, descricao, destaque
            });
            showToast('Partitura atualizada!');
          } else {
            // Criar
            const formData = new FormData();
            formData.append('titulo', titulo);
            formData.append('compositor', compositor);
            formData.append('arranjador', arranjador);
            formData.append('categoria', categoria);
            formData.append('ano', ano);
            formData.append('descricao', descricao);
            formData.append('destaque', destaque ? '1' : '0');
            formData.append('arquivo', arquivo);
            
            await API.createPartitura(formData);
            showToast('Partitura adicionada!');
          }
          onSave();
        } catch (e) {
          showToast(e.message, 'error');
        }
        setSaving(false);
      };
      
      const selectedCategoria = categorias.find(c => c.id === categoria);
      
      const inputStyle = {
        width: '100%', padding: '14px 16px', borderRadius: '10px',
        border: '1.5px solid var(--border)', background: 'var(--bg-primary)',
        color: 'var(--text-primary)', fontSize: '14px', marginBottom: '16px',
        transition: 'border-color 0.2s'
      };
      
      return (
        <div style={{
          position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.6)',
          display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000,
          backdropFilter: 'blur(4px)'
        }} onClick={onClose}>
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: '16px',
            padding: '32px', width: '100%', maxWidth: '540px', maxHeight: '90vh', overflow: 'auto',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            animation: 'scaleInLogin 0.25s ease-out'
          }} onClick={e => e.stopPropagation()}>
            
            {/* Header */}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '28px' }}>
              <h2 style={{ fontSize: '22px', fontWeight: '600', color: 'var(--text-primary)', margin: 0 }}>
                {partitura ? 'Editar Partitura' : 'Nova Partitura'}
              </h2>
              <button onClick={onClose} style={{
                width: '32px', height: '32px', borderRadius: '8px',
                background: 'var(--bg-primary)', border: '1px solid var(--border)',
                color: 'var(--text-muted)', cursor: 'pointer',
                display: 'flex', alignItems: 'center', justifyContent: 'center'
              }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
              <div style={{ gridColumn: 'span 2' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                  Título <span style={{ color: '#e74c3c' }}>*</span>
                </label>
                <input type="text" style={inputStyle} placeholder="Nome da música" value={titulo} onChange={e => setTitulo(e.target.value)} />
              </div>
              
              <div>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                  Compositor <span style={{ color: '#e74c3c' }}>*</span>
                </label>
                <input type="text" style={inputStyle} placeholder="Nome do compositor" value={compositor} onChange={e => setCompositor(e.target.value)} />
              </div>
              
              <div>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                  Arranjador
                </label>
                <input type="text" style={inputStyle} placeholder="Nome do arranjador" value={arranjador} onChange={e => setArranjador(e.target.value)} />
              </div>
              
              {/* Categoria - Dropdown customizado */}
              <div style={{ position: 'relative' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                  Categoria <span style={{ color: '#e74c3c' }}>*</span>
                </label>
                <button
                  type="button"
                  onClick={() => setShowCatDropdown(!showCatDropdown)}
                  style={{
                    width: '100%', padding: '14px 16px', borderRadius: '10px',
                    border: '1.5px solid var(--border)', background: 'var(--bg-primary)',
                    color: selectedCategoria ? 'var(--text-primary)' : 'var(--text-muted)',
                    fontSize: '14px', textAlign: 'left', cursor: 'pointer',
                    display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                    marginBottom: '16px'
                  }}
                >
                  <span style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    {selectedCategoria && (
                      <span style={{
                        width: '24px', height: '24px', borderRadius: '6px',
                        background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        border: '1px solid rgba(212, 175, 55, 0.2)'
                      }}>
                        <CategoryIcon categoryId={selectedCategoria.id} size={14} color="#D4AF37" />
                      </span>
                    )}
                    {selectedCategoria ? selectedCategoria.nome : 'Selecione'}
                  </span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{
                    transform: showCatDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                    transition: 'transform 0.2s'
                  }}>
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </button>
                
                {showCatDropdown && (
                  <div style={{
                    position: 'absolute', top: '100%', left: 0, right: 0,
                    background: 'var(--bg-secondary)', border: '1.5px solid var(--border)',
                    borderRadius: '10px', boxShadow: '0 8px 24px rgba(0,0,0,0.15)',
                    zIndex: 10, maxHeight: '200px', overflowY: 'auto'
                  }}>
                    {categorias.map(cat => (
                      <button
                        key={cat.id}
                        onClick={() => { setCategoria(cat.id); setShowCatDropdown(false); }}
                        style={{
                          width: '100%', padding: '12px 16px', border: 'none',
                          background: categoria === cat.id ? 'rgba(212, 175, 55, 0.1)' : 'transparent',
                          color: categoria === cat.id ? '#D4AF37' : 'var(--text-primary)',
                          fontSize: '14px', textAlign: 'left', cursor: 'pointer',
                          display: 'flex', alignItems: 'center', gap: '10px',
                          transition: 'background 0.15s'
                        }}
                        onMouseEnter={e => { if (categoria !== cat.id) e.target.style.background = 'var(--bg-primary)'; }}
                        onMouseLeave={e => { if (categoria !== cat.id) e.target.style.background = 'transparent'; }}
                      >
                        <span style={{
                          width: '24px', height: '24px', borderRadius: '6px',
                          background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                          border: '1px solid rgba(212, 175, 55, 0.2)'
                        }}>
                          <CategoryIcon categoryId={cat.id} size={14} color="#D4AF37" />
                        </span>
                        {cat.nome}
                      </button>
                    ))}
                  </div>
                )}
              </div>
              
              <div>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                  Ano
                </label>
                <input type="number" style={inputStyle} placeholder="1950" value={ano} onChange={e => setAno(e.target.value)} />
              </div>
              
              <div style={{ gridColumn: 'span 2' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                  Descrição
                </label>
                <textarea style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} placeholder="Informações adicionais..." value={descricao} onChange={e => setDescricao(e.target.value)} />
              </div>
            </div>
            
            {!partitura && (
              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                  Arquivo PDF <span style={{ color: '#e74c3c' }}>*</span>
                </label>
                <input
                  type="file" accept=".pdf"
                  onChange={e => setArquivo(e.target.files[0])}
                  style={{ fontSize: '14px', color: 'var(--text-primary)' }}
                />
                {arquivo && (
                  <div style={{ marginTop: '8px', fontSize: '13px', color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', gap: '6px' }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    {arquivo.name} ({(arquivo.size / 1024 / 1024).toFixed(2)} MB)
                  </div>
                )}
              </div>
            )}
            
            {/* Toggle Destaque - Estilizado */}
            <label style={{
              display: 'flex', alignItems: 'center', gap: '14px', cursor: 'pointer',
              padding: '16px', background: destaque ? 'rgba(212, 175, 55, 0.1)' : 'var(--bg-primary)',
              borderRadius: '12px', marginBottom: '28px',
              border: destaque ? '1.5px solid rgba(212, 175, 55, 0.3)' : '1.5px solid var(--border)',
              transition: 'all 0.2s'
            }}>
              {/* Toggle Switch */}
              <div style={{
                width: '44px', height: '24px', borderRadius: '12px',
                background: destaque ? '#D4AF37' : 'var(--border)',
                position: 'relative', transition: 'background 0.2s',
                flexShrink: 0
              }}>
                <div style={{
                  position: 'absolute', top: '2px',
                  left: destaque ? '22px' : '2px',
                  width: '20px', height: '20px', borderRadius: '10px',
                  background: '#fff', boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                  transition: 'left 0.2s ease'
                }} />
              </div>
              <input 
                type="checkbox" 
                checked={destaque} 
                onChange={e => setDestaque(e.target.checked)} 
                style={{ display: 'none' }}
              />
              <div>
                <span style={{ color: 'var(--text-primary)', fontWeight: '500', fontSize: '14px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill={destaque ? '#D4AF37' : 'none'} stroke={destaque ? '#D4AF37' : 'currentColor'} strokeWidth="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                  </svg>
                  Marcar como destaque
                </span>
                <p style={{ fontSize: '12px', color: 'var(--text-muted)', margin: '4px 0 0 0' }}>
                  Aparecerá em destaque na página inicial
                </p>
              </div>
            </label>
            
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onClose} style={{
                flex: 1, padding: '14px', borderRadius: '10px',
                background: 'var(--bg-primary)', border: '1.5px solid var(--border)',
                color: 'var(--text-primary)', fontSize: '14px', fontWeight: '500', cursor: 'pointer',
                transition: 'all 0.15s'
              }}>
                Cancelar
              </button>
              <button onClick={handleSubmit} disabled={saving} style={{
                flex: 1, padding: '14px', borderRadius: '10px',
                background: '#D4AF37', border: 'none',
                color: '#1a1a1a', fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                opacity: saving ? 0.7 : 1,
                transition: 'all 0.15s'
              }}>
                {saving ? 'Salvando...' : (partitura ? 'Salvar Alterações' : 'Adicionar Partitura')}
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    // Modal de Upload de Pasta
    const UploadPastaModal = ({ categorias, onSave, onClose }) => {
      const { showToast } = useApp();
      const [files, setFiles] = useState([]);
      const [folderName, setFolderName] = useState('');
      const [parsedData, setParsedData] = useState(null);
      const [uploading, setUploading] = useState(false);
      const [uploadProgress, setUploadProgress] = useState(0);
      const [showCatDropdown, setShowCatDropdown] = useState(false);
      
      // Campos editáveis
      const [titulo, setTitulo] = useState('');
      const [categoria, setCategoria] = useState('');
      const [compositor, setCompositor] = useState('');
      const [arranjador, setArranjador] = useState('');
      const [ano, setAno] = useState('');
      
      // Lista de instrumentos conhecidos para detecção
      // Inclui variações comuns de nomenclatura
      const instrumentosConhecidos = [
        // Grade/Score
        'Grade', 'Score', 'Conductor', 'Full Score',
        
        // Flautas
        'Flautim', 'Flauta', 'Piccolo', 'Flute',
        
        // Clarinetes (português e variações)
        'Requinta', 'Requinta Eb', 'Eb Clarinet',
        'Clarinete Bb', 'Clarinete Bb 1', 'Clarinete Bb 2', 'Clarinete Bb 3',
        'Clarinete', 'Clarinete 1', 'Clarinete 2', 'Clarinete 3',
        'Clarineta Bb', 'Clarineta Bb 1', 'Clarineta Bb 2', 'Clarineta Bb 3',
        'Clarineta', 'Clarineta 1', 'Clarineta 2', 'Clarineta 3',
        'Clarinet', 'Clarinet 1', 'Clarinet 2', 'Clarinet 3',
        'Bb Clarinet', 'Bb Clarinet 1', 'Bb Clarinet 2', 'Bb Clarinet 3',
        
        // Saxofones (português, abreviado e inglês)
        'Sax. Soprano', 'Sax Soprano', 'Saxofone Soprano', 'Soprano Sax', 'Soprano Saxophone',
        'Sax. Alto', 'Sax. Alto 1', 'Sax. Alto 2', 'Sax Alto', 'Sax Alto 1', 'Sax Alto 2',
        'Saxofone Alto', 'Alto Sax', 'Alto Sax 1', 'Alto Sax 2', 'Alto Saxophone',
        'Sax. Tenor', 'Sax. Tenor 1', 'Sax. Tenor 2', 'Sax Tenor', 'Sax Tenor 1', 'Sax Tenor 2',
        'Saxofone Tenor', 'Tenor Sax', 'Tenor Sax 1', 'Tenor Sax 2', 'Tenor Saxophone',
        'Sax. Barítono', 'Sax Barítono', 'Saxofone Barítono', 'Baritone Sax', 'Bari Sax',
        
        // Trompetes
        'Trompete Bb', 'Trompete Bb 1', 'Trompete Bb 2', 'Trompete Bb 3',
        'Trompete', 'Trompete 1', 'Trompete 2', 'Trompete 3',
        'Trumpet', 'Trumpet 1', 'Trumpet 2', 'Trumpet 3',
        'Bb Trumpet', 'Bb Trumpet 1', 'Bb Trumpet 2', 'Bb Trumpet 3',
        
        // Trompas
        'Trompa F', 'Trompa F 1', 'Trompa F 2',
        'Trompa Eb', 'Trompa Eb 1', 'Trompa Eb 2',
        'Trompa', 'Trompa 1', 'Trompa 2',
        'Horn', 'Horn 1', 'Horn 2', 'French Horn', 'F Horn', 'Eb Horn',
        
        // Barítonos/Eufônio
        'Barítono Bb', 'Barítono Bb 1', 'Barítono Bb 2',
        'Barítono', 'Barítono 1', 'Barítono 2',
        'Baritone', 'Baritone 1', 'Baritone 2',
        'Euphonium', 'Euphonium 1', 'Euphonium 2',
        
        // Trombones
        'Trombone', 'Trombone 1', 'Trombone 2', 'Trombone 3',
        
        // Bombardinos
        'Bombardino', 'Bombardino Bb', 'Bombardino C', 'Bombardino Eb',
        
        // Tubas/Baixos
        'Baixo Eb', 'Baixo Bb', 'Baixo', 
        'Tuba', 'Tuba Eb', 'Tuba Bb',
        'Bass', 'Eb Bass', 'Bb Bass',
        
        // Percussão
        'Caixa', 'Caixa-clara', 'Caixa Clara', 'Snare', 'Snare Drum',
        'Caixa-Ferro-Tamborim', 'Caixa e Tamborim', 'Tamborim',
        'Bombo', 'Bumbo', 'Bass Drum',
        'Pratos', 'Prato', 'Cymbals', 'Cymbal',
        'Percussão', 'Percussion', 'Drums',
        'Bateria', 'Drum Set'
      ];
      
      // Detecta categoria pelo nome
      const detectarCategoria = (nome) => {
        const nomeNorm = nome.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        
        // Mapeamento de termos para categorias
        const mapeamento = {
          'dobrado': 'dobrado',
          'marcha funebre': 'marcha-funebre',
          'marcha fúnebre': 'marcha-funebre',
          'marcha': 'marcha',
          'valsa': 'valsa',
          'fantasia': 'fantasia',
          'polaca': 'polaca',
          'bolero': 'bolero',
          'hino religioso': 'hino-religioso',
          'hino': 'hino',
          'preludio': 'preludio',
          'prelúdio': 'preludio',
          'arranjo': 'arranjo'
        };
        
        // Verifica do mais específico para o mais genérico
        const termos = Object.keys(mapeamento).sort((a, b) => b.length - a.length);
        
        for (const termo of termos) {
          if (nomeNorm.includes(termo)) {
            return mapeamento[termo];
          }
        }
        
        return categorias[0]?.id || 'dobrado';
      };
      
      // Função para normalizar texto (remove acentos, padroniza)
      const normalizarTexto = (texto) => {
        return texto
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '') // Remove acentos
          .replace(/[_\-\.]/g, ' ')         // Substitui separadores por espaço
          .replace(/\s+/g, ' ')             // Múltiplos espaços vira um só
          .trim();
      };
      
      // Mapeamento completo: nome normalizado → nome correto/padrão
      const nomesPadrao = {
        // Grade
        'grade': 'Grade',
        'score': 'Grade',
        'conductor': 'Grade',
        'full score': 'Grade',
        
        // Flautas
        'flautim': 'Flautim',
        'piccolo': 'Flautim',
        'flauta': 'Flauta',
        'flute': 'Flauta',
        
        // Requinta
        'requinta': 'Requinta',
        'requinta eb': 'Requinta',
        'eb clarinet': 'Requinta',
        
        // Clarinetes
        'clarinete bb': 'Clarinete Bb',
        'clarinete bb 1': 'Clarinete Bb 1',
        'clarinete bb 2': 'Clarinete Bb 2',
        'clarinete bb 3': 'Clarinete Bb 3',
        'clarinete': 'Clarinete Bb',
        'clarinete 1': 'Clarinete Bb 1',
        'clarinete 2': 'Clarinete Bb 2',
        'clarinete 3': 'Clarinete Bb 3',
        'clarineta bb': 'Clarinete Bb',
        'clarineta bb 1': 'Clarinete Bb 1',
        'clarineta bb 2': 'Clarinete Bb 2',
        'clarineta bb 3': 'Clarinete Bb 3',
        'clarineta': 'Clarinete Bb',
        'clarineta 1': 'Clarinete Bb 1',
        'clarineta 2': 'Clarinete Bb 2',
        'clarineta 3': 'Clarinete Bb 3',
        'clarinet': 'Clarinete Bb',
        'clarinet 1': 'Clarinete Bb 1',
        'clarinet 2': 'Clarinete Bb 2',
        'clarinet 3': 'Clarinete Bb 3',
        'bb clarinet': 'Clarinete Bb',
        'bb clarinet 1': 'Clarinete Bb 1',
        'bb clarinet 2': 'Clarinete Bb 2',
        'bb clarinet 3': 'Clarinete Bb 3',
        
        // Saxofones
        'sax soprano': 'Sax. Soprano',
        'sax. soprano': 'Sax. Soprano',
        'saxofone soprano': 'Sax. Soprano',
        'soprano sax': 'Sax. Soprano',
        'soprano saxophone': 'Sax. Soprano',
        
        'sax alto': 'Sax. Alto',
        'sax. alto': 'Sax. Alto',
        'sax alto 1': 'Sax. Alto 1',
        'sax. alto 1': 'Sax. Alto 1',
        'sax alto 2': 'Sax. Alto 2',
        'sax. alto 2': 'Sax. Alto 2',
        'saxofone alto': 'Sax. Alto',
        'alto sax': 'Sax. Alto',
        'alto sax 1': 'Sax. Alto 1',
        'alto sax 2': 'Sax. Alto 2',
        'alto saxophone': 'Sax. Alto',
        
        'sax tenor': 'Sax. Tenor',
        'sax. tenor': 'Sax. Tenor',
        'sax tenor 1': 'Sax. Tenor 1',
        'sax. tenor 1': 'Sax. Tenor 1',
        'sax tenor 2': 'Sax. Tenor 2',
        'sax. tenor 2': 'Sax. Tenor 2',
        'saxofone tenor': 'Sax. Tenor',
        'tenor sax': 'Sax. Tenor',
        'tenor sax 1': 'Sax. Tenor 1',
        'tenor sax 2': 'Sax. Tenor 2',
        'tenor saxophone': 'Sax. Tenor',
        
        'sax baritono': 'Sax. Barítono',
        'sax. baritono': 'Sax. Barítono',
        'saxofone baritono': 'Sax. Barítono',
        'baritone sax': 'Sax. Barítono',
        'baritono sax': 'Sax. Barítono',
        'bari sax': 'Sax. Barítono',
        'baritone saxophone': 'Sax. Barítono',
        
        // Trompetes
        'trompete bb': 'Trompete Bb',
        'trompete bb 1': 'Trompete Bb 1',
        'trompete bb 2': 'Trompete Bb 2',
        'trompete bb 3': 'Trompete Bb 3',
        'trompete': 'Trompete Bb',
        'trompete 1': 'Trompete Bb 1',
        'trompete 2': 'Trompete Bb 2',
        'trompete 3': 'Trompete Bb 3',
        'trumpet': 'Trompete Bb',
        'trumpet 1': 'Trompete Bb 1',
        'trumpet 2': 'Trompete Bb 2',
        'trumpet 3': 'Trompete Bb 3',
        'bb trumpet': 'Trompete Bb',
        'bb trumpet 1': 'Trompete Bb 1',
        'bb trumpet 2': 'Trompete Bb 2',
        'bb trumpet 3': 'Trompete Bb 3',
        'trumpet in bb': 'Trompete Bb',
        'trumpet in bb 1': 'Trompete Bb 1',
        'trumpet in bb 2': 'Trompete Bb 2',
        'trumpet in bb 3': 'Trompete Bb 3',
        
        // Trompas
        'trompa f': 'Trompa F',
        'trompa f 1': 'Trompa F 1',
        'trompa f 2': 'Trompa F 2',
        'trompa eb': 'Trompa Eb',
        'trompa eb 1': 'Trompa Eb 1',
        'trompa eb 2': 'Trompa Eb 2',
        'trompa': 'Trompa F',
        'trompa 1': 'Trompa F 1',
        'trompa 2': 'Trompa F 2',
        'horn': 'Trompa F',
        'horn 1': 'Trompa F 1',
        'horn 2': 'Trompa F 2',
        'french horn': 'Trompa F',
        'f horn': 'Trompa F',
        'eb horn': 'Trompa Eb',
        'horn in f': 'Trompa F',
        'horn in f 1': 'Trompa F 1',
        'horn in f 2': 'Trompa F 2',
        'horn in eb': 'Trompa Eb',
        'horn in eb 1': 'Trompa Eb 1',
        'horn in eb 2': 'Trompa Eb 2',
        
        // Barítonos
        'baritono bb': 'Barítono Bb',
        'baritono bb 1': 'Barítono Bb 1',
        'baritono bb 2': 'Barítono Bb 2',
        'baritono': 'Barítono Bb',
        'baritono 1': 'Barítono Bb 1',
        'baritono 2': 'Barítono Bb 2',
        'baritone': 'Barítono Bb',
        'baritone 1': 'Barítono Bb 1',
        'baritone 2': 'Barítono Bb 2',
        'baritone tc': 'Barítono Bb',
        'baritone bc': 'Barítono Bb',
        
        // Trombones
        'trombone': 'Trombone',
        'trombone 1': 'Trombone 1',
        'trombone 2': 'Trombone 2',
        'trombone 3': 'Trombone 3',
        
        // Bombardinos
        'bombardino': 'Bombardino',
        'bombardino bb': 'Bombardino',
        'bombardino c': 'Bombardino',
        'bombardino eb': 'Bombardino',
        'euphonium': 'Bombardino',
        'euphonium 1': 'Bombardino',
        'euphonium 2': 'Bombardino',
        
        // Tubas/Baixos
        'baixo eb': 'Baixo Eb',
        'baixo bb': 'Baixo Bb',
        'baixo': 'Baixo Eb',
        'tuba': 'Baixo Eb',
        'tuba eb': 'Baixo Eb',
        'tuba bb': 'Baixo Bb',
        'bass': 'Baixo Eb',
        'eb bass': 'Baixo Eb',
        'bb bass': 'Baixo Bb',
        
        // Percussão
        'caixa': 'Caixa',
        'caixa clara': 'Caixa',
        'caixa-clara': 'Caixa',
        'snare': 'Caixa',
        'snare drum': 'Caixa',
        'caixa ferro tamborim': 'Caixa',
        'caixa-ferro-tamborim': 'Caixa',
        'caixa e tamborim': 'Caixa',
        'tamborim': 'Caixa',
        
        'bombo': 'Bombo',
        'bumbo': 'Bombo',
        'bass drum': 'Bombo',
        
        'pratos': 'Pratos',
        'prato': 'Pratos',
        'cymbals': 'Pratos',
        'cymbal': 'Pratos',
        
        'percussao': 'Percussão',
        'percussion': 'Percussão',
        'drums': 'Percussão',
        'bateria': 'Percussão',
        'drum set': 'Percussão'
      };
      
      // Extrai instrumento do nome do arquivo e retorna nome padronizado
      const extrairInstrumento = (nomeArquivo) => {
        // Remove extensão
        let nome = nomeArquivo.replace(/\.pdf$/i, '');
        
        // Remove numeração inicial (01, 02, etc.)
        nome = nome.replace(/^\d+[\s\-_\.]*/, '');
        
        // Remove prefixo de título se existir (ex: "Seleção Natalina (1) - ")
        nome = nome.replace(/^.+\s*-\s*/, '');
        
        // Extrai número final (1, 2, 3) se existir
        const matchNumero = nome.match(/\s+(\d+)$/);
        const numeroFinal = matchNumero ? matchNumero[1] : null;
        
        // Remove o número para buscar o instrumento base
        const nomeBase = nome.replace(/\s+\d+$/, '').trim();
        
        // Normaliza o nome do arquivo
        const nomeNormalizado = normalizarTexto(nomeBase);
        
        // Função para adicionar número ao resultado
        const adicionarNumero = (instrumento) => {
          if (numeroFinal) {
            // Verifica se o instrumento já termina com número
            if (/\d$/.test(instrumento)) {
              return instrumento;
            }
            return `${instrumento} ${numeroFinal}`;
          }
          return instrumento;
        };
        
        // Busca direta no mapeamento
        if (nomesPadrao[nomeNormalizado]) {
          return { instrumento: adicionarNumero(nomesPadrao[nomeNormalizado]), reconhecido: true };
        }
        
        // Busca parcial - tenta encontrar a maior correspondência
        const chaves = Object.keys(nomesPadrao).sort((a, b) => b.length - a.length);
        
        for (const chave of chaves) {
          if (nomeNormalizado.includes(chave) || nomeNormalizado.endsWith(chave)) {
            return { instrumento: adicionarNumero(nomesPadrao[chave]), reconhecido: true };
          }
        }
        
        // Se não encontrou, retorna o nome original como não reconhecido
        return { instrumento: nome.trim(), reconhecido: false };
      };
      
      // Parseia o nome da pasta para extrair título, categoria, compositor
      const parsearNomePasta = (nome) => {
        // Divide por hífen
        const partes = nome.split(/\s*-\s*/);
        
        // Resultado
        let titulo = '';
        let categoriaDetectada = '';
        let compositor = '';
        let arranjador = '';
        let temArranjador = false;
        
        // Título é sempre a primeira parte
        if (partes.length > 0) {
          titulo = partes[0].trim();
        }
        
        // Lista de categorias conhecidas para detectar (gêneros tradicionais de filarmônica)
        const categoriasConhecidas = ['dobrado', 'marcha', 'valsa', 'fantasia', 'polaca', 'bolero', 'hino', 'marcha funebre', 'marcha funébre', 'preludio', 'prelúdio'];
        
        // Analisa as partes restantes pelo conteúdo
        for (let i = 1; i < partes.length; i++) {
          const parte = partes[i].trim();
          const parteLower = parte.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
          
          // Verifica se é arranjador (contém "Arr.", "Arr:", "Arranjo")
          if (/^arr[\.\:\s]/i.test(parte) || /arranjo/i.test(parte)) {
            // Remove prefixo "Arr.", "Arr:", "Arranjo:" etc
            arranjador = parte.replace(/^(arr[\.\:\s]*|arranjo[\.\:\s]*)/i, '').trim();
            temArranjador = true;
          }
          // Verifica se é uma categoria conhecida
          else if (categoriasConhecidas.some(cat => parteLower === cat || parteLower.includes(cat))) {
            categoriaDetectada = parte;
          }
          // Se não é categoria nem arranjador, é compositor
          else if (!compositor) {
            compositor = parte;
          }
        }
        
        // Se tem arranjador e não detectou categoria tradicional, é um Arranjo
        if (temArranjador && !categoriaDetectada) {
          categoriaDetectada = 'Arranjo';
        }
        
        return {
          titulo,
          categoriaDetectada,
          compositor,
          arranjador
        };
      };
      
      // Processa os arquivos quando selecionados
      const handleFolderSelect = (e) => {
        const fileList = Array.from(e.target.files);
        if (fileList.length === 0) return;
        
        // Filtra apenas PDFs
        const pdfFiles = fileList.filter(f => f.name.toLowerCase().endsWith('.pdf'));
        
        if (pdfFiles.length === 0) {
          showToast('Nenhum arquivo PDF encontrado na pasta', 'error');
          return;
        }
        
        setFiles(pdfFiles);
        
        // Extrai nome da pasta do path do primeiro arquivo
        const firstPath = pdfFiles[0].webkitRelativePath || pdfFiles[0].name;
        const pathParts = firstPath.split('/');
        const pastaName = pathParts.length > 1 ? pathParts[0] : 'Pasta sem nome';
        setFolderName(pastaName);
        
        // Parseia nome da pasta
        const { titulo: tit, categoriaDetectada, compositor: comp, arranjador: arr } = parsearNomePasta(pastaName);
        setTitulo(tit);
        setCompositor(comp);
        setArranjador(arr || '');
        
        // Detecta categoria - se já veio "Arranjo" do parser, usa direto
        let catId;
        if (categoriaDetectada && categoriaDetectada.toLowerCase() === 'arranjo') {
          catId = 'arranjo';
        } else {
          catId = detectarCategoria(categoriaDetectada || pastaName);
        }
        setCategoria(catId);
        
        // Processa cada arquivo para detectar instrumentos
        const arquivosProcessados = pdfFiles.map(file => {
          const nomeArquivo = file.name;
          const { instrumento, reconhecido } = extrairInstrumento(nomeArquivo);
          return {
            file,
            nomeOriginal: nomeArquivo,
            instrumento,
            reconhecido
          };
        });
        
        // Ordena: reconhecidos primeiro, depois por nome do instrumento
        arquivosProcessados.sort((a, b) => {
          if (a.reconhecido !== b.reconhecido) return b.reconhecido - a.reconhecido;
          return a.instrumento.localeCompare(b.instrumento);
        });
        
        setParsedData(arquivosProcessados);
      };
      
      // Faz upload de todos os arquivos
      const handleUpload = async () => {
        if (!titulo.trim()) {
          showToast('Informe o título da partitura', 'error');
          return;
        }
        if (!categoria) {
          showToast('Selecione uma categoria', 'error');
          return;
        }
        if (!parsedData || parsedData.length === 0) {
          showToast('Selecione uma pasta com arquivos', 'error');
          return;
        }
        
        setUploading(true);
        setUploadProgress(0);
        
        try {
          // Prepara FormData com todos os arquivos
          const formData = new FormData();
          formData.append('titulo', titulo);
          formData.append('compositor', compositor);
          formData.append('arranjador', arranjador);
          formData.append('categoria', categoria);
          formData.append('ano', ano);
          
          // Adiciona cada arquivo com seu instrumento detectado
          parsedData.forEach((item, index) => {
            formData.append(`arquivo_${index}`, item.file);
            formData.append(`instrumento_${index}`, item.instrumento);
          });
          formData.append('total_arquivos', parsedData.length.toString());
          
          // Faz upload
          const response = await fetch(`${API_BASE_URL}/api/partituras/upload-pasta`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${Storage.get('authToken')}`
            },
            body: formData
          });
          
          const responseText = await response.text();
          let result;
          
          try {
            result = JSON.parse(responseText);
          } catch (e) {
            console.error('Resposta não é JSON:', responseText);
            throw new Error('Erro no servidor. Tente novamente.');
          }
          
          if (!response.ok) {
            throw new Error(result.error || 'Erro no upload');
          }
          
          showToast(`Partitura criada com ${result.partes_criadas} partes!`);
          onSave();
        } catch (e) {
          showToast(e.message, 'error');
        }
        
        setUploading(false);
      };
      
      const inputStyle = {
        width: '100%', padding: '10px 12px', borderRadius: 'var(--radius-sm)',
        border: '1px solid var(--border)', background: 'var(--bg-primary)',
        color: 'var(--text-primary)', fontSize: '14px', fontFamily: 'Outfit, sans-serif'
      };
      
      const reconhecidos = parsedData?.filter(p => p.reconhecido).length || 0;
      const naoReconhecidos = parsedData?.filter(p => !p.reconhecido).length || 0;
      
      return (
        <div style={{
          position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)',
          display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000,
          padding: '20px'
        }} onClick={onClose}>
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)',
            padding: '28px', width: '100%', maxWidth: '700px', maxHeight: '90vh',
            overflow: 'auto', fontFamily: 'Outfit, sans-serif'
          }} onClick={e => e.stopPropagation()}>
            <h2 style={{ fontSize: '20px', fontWeight: '700', marginBottom: '8px', color: 'var(--text-primary)', display: 'flex', alignItems: 'center', gap: '10px' }}>
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Upload de Pasta
            </h2>
            <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '24px' }}>
              Selecione uma pasta contendo os PDFs das partes da partitura
            </p>
            
            {/* Seletor de pasta */}
            <div style={{
              border: '2px dashed var(--border)',
              borderRadius: 'var(--radius-md)',
              padding: '30px',
              textAlign: 'center',
              marginBottom: '20px',
              background: 'var(--bg-primary)',
              cursor: 'pointer',
              transition: 'all 0.2s'
            }}>
              <input
                type="file"
                webkitdirectory=""
                directory=""
                multiple
                onChange={handleFolderSelect}
                style={{ display: 'none' }}
                id="folder-input"
              />
              <label htmlFor="folder-input" style={{ cursor: 'pointer', display: 'block' }}>
                <div style={{ fontSize: '48px', marginBottom: '12px' }}>📂</div>
                <div style={{ fontSize: '16px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '8px' }}>
                  {folderName || 'Clique para selecionar uma pasta'}
                </div>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                  {files.length > 0 ? `${files.length} arquivo(s) PDF encontrado(s)` : 'Padrão: "Título - Categoria - Compositor"'}
                </div>
              </label>
            </div>
            
            {/* Preview dos dados detectados */}
            {parsedData && parsedData.length > 0 && (
              <>
                {/* Campos editáveis */}
                <div style={{
                  background: 'var(--bg-primary)',
                  borderRadius: 'var(--radius-md)',
                  padding: '20px',
                  marginBottom: '20px',
                  border: '1px solid var(--border)'
                }}>
                  <h3 style={{ fontSize: '14px', fontWeight: '600', marginBottom: '16px', color: 'var(--text-primary)', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Dados da Partitura (edite se necessário)
                  </h3>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                    <div>
                      <label style={{ display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px', color: 'var(--text-secondary)' }}>
                        Título *
                      </label>
                      <input type="text" style={inputStyle} value={titulo} onChange={e => setTitulo(e.target.value)} />
                    </div>
                    
                    <div style={{ position: 'relative' }}>
                      <label style={{ display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px', color: 'var(--text-secondary)' }}>
                        Categoria *
                      </label>
                      {(() => {
                        const selectedCat = categorias.find(c => c.id === categoria);
                        return (
                          <>
                            <button
                              type="button"
                              onClick={() => setShowCatDropdown(!showCatDropdown)}
                              style={{
                                ...inputStyle, cursor: 'pointer',
                                display: 'flex', alignItems: 'center', justifyContent: 'space-between'
                              }}
                            >
                              <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                {selectedCat && (
                                  <span style={{
                                    width: '20px', height: '20px', borderRadius: '4px',
                                    background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    border: '1px solid rgba(212, 175, 55, 0.2)'
                                  }}>
                                    <CategoryIcon categoryId={selectedCat.id} size={12} color="#D4AF37" />
                                  </span>
                                )}
                                {selectedCat ? selectedCat.nome : 'Selecione...'}
                              </span>
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{
                                transform: showCatDropdown ? 'rotate(180deg)' : 'rotate(0deg)',
                                transition: 'transform 0.2s'
                              }}>
                                <polyline points="6 9 12 15 18 9"/>
                              </svg>
                            </button>
                            
                            {showCatDropdown && (
                              <div style={{
                                position: 'absolute', top: '100%', left: 0, right: 0,
                                background: 'var(--bg-secondary)', border: '1.5px solid var(--border)',
                                borderRadius: '8px', boxShadow: '0 8px 24px rgba(0,0,0,0.15)',
                                zIndex: 20, maxHeight: '200px', overflowY: 'auto'
                              }}>
                                <button
                                  onClick={() => { setCategoria(''); setShowCatDropdown(false); }}
                                  style={{
                                    width: '100%', padding: '10px 12px', border: 'none',
                                    background: !categoria ? 'rgba(212, 175, 55, 0.1)' : 'transparent',
                                    color: !categoria ? '#D4AF37' : 'var(--text-muted)',
                                    fontSize: '13px', textAlign: 'left', cursor: 'pointer'
                                  }}
                                >
                                  Selecione...
                                </button>
                                {categorias.map(cat => (
                                  <button
                                    key={cat.id}
                                    onClick={() => { setCategoria(cat.id); setShowCatDropdown(false); }}
                                    style={{
                                      width: '100%', padding: '10px 12px', border: 'none',
                                      background: categoria === cat.id ? 'rgba(212, 175, 55, 0.1)' : 'transparent',
                                      color: categoria === cat.id ? '#D4AF37' : 'var(--text-primary)',
                                      fontSize: '13px', textAlign: 'left', cursor: 'pointer',
                                      display: 'flex', alignItems: 'center', gap: '8px',
                                      transition: 'background 0.15s'
                                    }}
                                    onMouseEnter={e => { if (categoria !== cat.id) e.target.style.background = 'var(--bg-primary)'; }}
                                    onMouseLeave={e => { if (categoria !== cat.id) e.target.style.background = 'transparent'; }}
                                  >
                                    <span style={{
                                      width: '20px', height: '20px', borderRadius: '4px',
                                      background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                                      border: '1px solid rgba(212, 175, 55, 0.2)'
                                    }}>
                                      <CategoryIcon categoryId={cat.id} size={12} color="#D4AF37" />
                                    </span>
                                    {cat.nome}
                                  </button>
                                ))}
                              </div>
                            )}
                          </>
                        );
                      })()}
                    </div>
                    
                    <div>
                      <label style={{ display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px', color: 'var(--text-secondary)' }}>
                        Compositor
                      </label>
                      <input type="text" style={inputStyle} value={compositor} onChange={e => setCompositor(e.target.value)} />
                    </div>
                    
                    <div>
                      <label style={{ display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px', color: 'var(--text-secondary)' }}>
                        Arranjador
                      </label>
                      <input type="text" style={inputStyle} value={arranjador} onChange={e => setArranjador(e.target.value)} />
                    </div>
                    
                    <div>
                      <label style={{ display: 'block', fontSize: '12px', fontWeight: '500', marginBottom: '4px', color: 'var(--text-secondary)' }}>
                        Ano
                      </label>
                      <input type="number" style={inputStyle} placeholder="Ex: 1950" value={ano} onChange={e => setAno(e.target.value)} />
                    </div>
                  </div>
                </div>
                
                {/* Lista de arquivos detectados */}
                <div style={{
                  background: 'var(--bg-primary)',
                  borderRadius: 'var(--radius-md)',
                  padding: '20px',
                  marginBottom: '20px',
                  border: '1px solid var(--border)'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M9 18V5l12-2v13"/>
                        <circle cx="6" cy="18" r="3"/>
                        <circle cx="18" cy="16" r="3"/>
                      </svg>
                      Partes Detectadas
                    </h3>
                    <div style={{ display: 'flex', gap: '12px', fontSize: '12px' }}>
                      <span style={{ color: '#27ae60', display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        {reconhecidos} reconhecido(s)
                      </span>
                      {naoReconhecidos > 0 && (
                        <span style={{ color: '#e67e22', display: 'flex', alignItems: 'center', gap: '4px' }}>
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                          </svg>
                          {naoReconhecidos} não reconhecido(s)
                        </span>
                      )}
                    </div>
                  </div>
                  
                  <div style={{ maxHeight: '250px', overflowY: 'auto' }}>
                    {parsedData.map((item, idx) => (
                      <div key={idx} style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        padding: '10px 12px',
                        background: 'var(--bg-secondary)',
                        borderRadius: 'var(--radius-sm)',
                        marginBottom: '6px',
                        border: item.reconhecido ? '1px solid var(--border)' : '1px solid #e67e22'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', flex: 1, minWidth: 0 }}>
                          <span style={{ color: item.reconhecido ? '#27ae60' : '#e67e22', display: 'flex', alignItems: 'center' }}>
                            {item.reconhecido ? (
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                                <polyline points="20 6 9 17 4 12"/>
                              </svg>
                            ) : (
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                              </svg>
                            )}
                          </span>
                          <div style={{ flex: 1, minWidth: 0 }}>
                            <div style={{ 
                              fontSize: '13px', 
                              color: 'var(--text-secondary)',
                              whiteSpace: 'nowrap',
                              overflow: 'hidden',
                              textOverflow: 'ellipsis'
                            }}>
                              {item.nomeOriginal}
                            </div>
                          </div>
                        </div>
                        <div style={{
                          background: item.reconhecido ? 'rgba(39, 174, 96, 0.1)' : 'rgba(230, 126, 34, 0.1)',
                          color: item.reconhecido ? '#27ae60' : '#e67e22',
                          padding: '4px 10px',
                          borderRadius: '12px',
                          fontSize: '12px',
                          fontWeight: '600',
                          whiteSpace: 'nowrap'
                        }}>
                          → {item.instrumento}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}
            
            {/* Botões */}
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onClose} style={{
                flex: 1, padding: '14px', borderRadius: 'var(--radius-sm)',
                background: 'var(--bg-primary)', border: '1px solid var(--border)',
                color: 'var(--text-primary)', fontSize: '14px', cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif'
              }}>
                Cancelar
              </button>
              <button 
                onClick={handleUpload} 
                disabled={uploading || !parsedData || parsedData.length === 0}
                style={{
                  flex: 1, padding: '14px', borderRadius: 'var(--radius-sm)',
                  background: 'linear-gradient(135deg, #D4AF37 0%, #B8860B 100%)',
                  border: 'none',
                  color: '#fff', fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                  fontFamily: 'Outfit, sans-serif',
                  opacity: (uploading || !parsedData || parsedData.length === 0) ? 0.6 : 1
                }}
              >
                {uploading ? 'Enviando...' : `📤 Fazer Upload (${parsedData?.length || 0} arquivos)`}
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    // Modal de Gerenciar Partes de uma Partitura
    const GerenciarPartesModal = ({ partitura, onSave, onClose }) => {
      const { showToast } = useApp();
      const [partes, setPartes] = useState([]);
      const [loading, setLoading] = useState(true);
      const [uploading, setUploading] = useState(false);
      const [showAddParte, setShowAddParte] = useState(false);
      const [novoInstrumento, setNovoInstrumento] = useState('');
      const [novoArquivo, setNovoArquivo] = useState(null);
      
      const loadPartes = async () => {
        setLoading(true);
        try {
          const response = await fetch(`${API_BASE_URL}/api/partituras/${partitura.id}/partes`);
          if (response.ok) {
            const data = await response.json();
            setPartes(data || []);
          }
        } catch (e) {
          showToast('Erro ao carregar partes', 'error');
        }
        setLoading(false);
      };
      
      useEffect(() => { loadPartes(); }, [partitura.id]);
      
      // Substituir uma parte
      const handleSubstituir = async (parte) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          setUploading(true);
          try {
            const formData = new FormData();
            formData.append('arquivo', file);
            
            const response = await fetch(`${API_BASE_URL}/api/partes/${parte.id}/substituir`, {
              method: 'PUT',
              headers: { 'Authorization': `Bearer ${Storage.get('authToken')}` },
              body: formData
            });
            
            if (response.ok) {
              showToast(`Parte "${parte.instrumento}" substituída!`);
              loadPartes();
            } else {
              const error = await response.json();
              showToast(error.error || 'Erro ao substituir', 'error');
            }
          } catch (e) {
            showToast('Erro ao substituir arquivo', 'error');
          }
          setUploading(false);
        };
        input.click();
      };
      
      // Remover uma parte
      const handleRemover = async (parte) => {
        if (!confirm(`Remover a parte "${parte.instrumento}"?`)) return;
        
        try {
          const response = await fetch(`${API_BASE_URL}/api/partes/${parte.id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${Storage.get('authToken')}` }
          });
          
          if (response.ok) {
            showToast(`Parte "${parte.instrumento}" removida!`);
            loadPartes();
          } else {
            const error = await response.json();
            showToast(error.error || 'Erro ao remover', 'error');
          }
        } catch (e) {
          showToast('Erro ao remover parte', 'error');
        }
      };
      
      // Adicionar nova parte
      const handleAdicionarParte = async () => {
        if (!novoInstrumento.trim() || !novoArquivo) {
          showToast('Selecione instrumento e arquivo', 'error');
          return;
        }
        
        setUploading(true);
        try {
          const formData = new FormData();
          formData.append('instrumento', novoInstrumento);
          formData.append('arquivo', novoArquivo);
          
          const response = await fetch(`${API_BASE_URL}/api/partituras/${partitura.id}/partes`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${Storage.get('authToken')}` },
            body: formData
          });
          
          if (response.ok) {
            showToast(`Parte "${novoInstrumento}" adicionada!`);
            setShowAddParte(false);
            setNovoInstrumento('');
            setNovoArquivo(null);
            loadPartes();
          } else {
            const error = await response.json();
            showToast(error.error || 'Erro ao adicionar', 'error');
          }
        } catch (e) {
          showToast('Erro ao adicionar parte', 'error');
        }
        setUploading(false);
      };
      
      const instrumentosDisponiveis = [
        'Grade', 'Flautim', 'Flauta', 'Requinta', 'Requinta Eb',
        'Clarinete Bb', 'Clarinete Bb 1', 'Clarinete Bb 2', 'Clarinete Bb 3',
        'Sax. Soprano', 'Sax. Alto', 'Sax. Alto 1', 'Sax. Alto 2',
        'Sax. Tenor', 'Sax. Tenor 1', 'Sax. Tenor 2', 'Sax. Barítono',
        'Trompete Bb', 'Trompete Bb 1', 'Trompete Bb 2', 'Trompete Bb 3',
        'Trompa F', 'Trompa Eb', 'Trompa Eb 1', 'Trompa Eb 2',
        'Barítono Bb', 'Barítono Bb 1', 'Barítono Bb 2',
        'Trombone', 'Trombone 1', 'Trombone 2', 'Trombone 3',
        'Bombardino', 'Bombardino Bb', 'Bombardino C',
        'Baixo Eb', 'Baixo Bb',
        'Caixa', 'Caixa-clara', 'Bombo', 'Pratos'
      ];
      
      return (
        <div style={{
          position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)',
          display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000,
          padding: '20px'
        }} onClick={onClose}>
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)',
            padding: '28px', width: '100%', maxWidth: '700px', maxHeight: '90vh',
            overflow: 'auto', fontFamily: 'Outfit, sans-serif'
          }} onClick={e => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '20px' }}>
              <div>
                <h2 style={{ fontSize: '20px', fontWeight: '700', color: 'var(--text-primary)', marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                  </svg>
                  Partes: {partitura.titulo}
                </h2>
                <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                  {partitura.compositor} • {partes.length} parte(s)
                </p>
              </div>
              <button onClick={() => setShowAddParte(!showAddParte)} style={{
                padding: '8px 16px', borderRadius: 'var(--radius-sm)',
                background: 'var(--accent)', border: 'none',
                color: '#fff', fontSize: '13px', cursor: 'pointer', fontWeight: '500'
              }}>
                + Adicionar Parte
              </button>
            </div>
            
            {/* Formulário de adicionar parte */}
            {showAddParte && (
              <div style={{
                background: 'var(--bg-primary)', borderRadius: 'var(--radius-md)',
                padding: '16px', marginBottom: '20px', border: '1px solid var(--border)'
              }}>
                <h4 style={{ fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: 'var(--text-primary)' }}>
                  Adicionar Nova Parte
                </h4>
                <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                  <select
                    value={novoInstrumento}
                    onChange={e => setNovoInstrumento(e.target.value)}
                    style={{
                      flex: 1, minWidth: '200px', padding: '10px 12px', borderRadius: 'var(--radius-sm)',
                      border: '1px solid var(--border)', background: 'var(--bg-secondary)',
                      color: 'var(--text-primary)', fontSize: '14px'
                    }}
                  >
                    <option value="">Selecione o instrumento</option>
                    {instrumentosDisponiveis.map(i => (
                      <option key={i} value={i}>{i}</option>
                    ))}
                  </select>
                  <input
                    type="file"
                    accept=".pdf"
                    onChange={e => setNovoArquivo(e.target.files[0])}
                    style={{ flex: 1 }}
                  />
                  <button onClick={handleAdicionarParte} disabled={uploading} style={{
                    padding: '10px 20px', borderRadius: 'var(--radius-sm)',
                    background: 'var(--accent)', border: 'none',
                    color: '#fff', fontSize: '14px', cursor: 'pointer',
                    opacity: uploading ? 0.6 : 1
                  }}>
                    {uploading ? 'Enviando...' : 'Adicionar'}
                  </button>
                </div>
              </div>
            )}
            
            {/* Lista de partes */}
            {loading ? (
              <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                Carregando...
              </div>
            ) : partes.length === 0 ? (
              <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)' }}>
                Nenhuma parte cadastrada. Esta partitura tem apenas um arquivo único.
              </div>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {partes.map((parte, idx) => (
                  <div key={parte.id} style={{
                    display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                    padding: '12px 16px', background: 'var(--bg-primary)',
                    borderRadius: 'var(--radius-sm)', border: '1px solid var(--border)'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <span style={{
                        width: '28px', height: '28px', borderRadius: '50%',
                        background: 'var(--accent)', color: '#fff',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: '12px', fontWeight: '700'
                      }}>
                        {idx + 1}
                      </span>
                      <div>
                        <div style={{ fontWeight: '500', color: 'var(--text-primary)' }}>{parte.instrumento}</div>
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                          {parte.arquivo_nome?.substring(0, 30)}...
                        </div>
                      </div>
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <button onClick={() => handleSubstituir(parte)} disabled={uploading} style={{
                        padding: '6px 12px', borderRadius: 'var(--radius-sm)',
                        background: 'var(--bg-secondary)', border: '1px solid var(--border)',
                        color: 'var(--text-primary)', fontSize: '12px', cursor: 'pointer',
                        display: 'flex', alignItems: 'center', gap: '4px'
                      }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <polyline points="23 4 23 10 17 10"/>
                          <polyline points="1 20 1 14 7 14"/>
                          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                        Substituir
                      </button>
                      <button onClick={() => handleRemover(parte)} title="Remover" style={{
                        width: '32px', height: '32px', borderRadius: 'var(--radius-sm)',
                        background: 'rgba(231, 76, 60, 0.1)', border: '1px solid rgba(231, 76, 60, 0.3)',
                        color: '#e74c3c', cursor: 'pointer',
                        display: 'flex', alignItems: 'center', justifyContent: 'center'
                      }}>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            {/* Botão Fechar */}
            <div style={{ marginTop: '20px', textAlign: 'right' }}>
              <button onClick={onClose} style={{
                padding: '12px 24px', borderRadius: 'var(--radius-sm)',
                background: 'var(--bg-primary)', border: '1px solid var(--border)',
                color: 'var(--text-primary)', fontSize: '14px', cursor: 'pointer'
              }}>
                Fechar
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    // Gerenciamento de Categorias
    const AdminCategorias = () => {
      const { showToast, sheets } = useApp();
      const [categorias, setCategorias] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showModal, setShowModal] = useState(false);
      const [editingCategoria, setEditingCategoria] = useState(null);
      const [expandedCategory, setExpandedCategory] = useState(null);
      
      const loadData = async () => {
        setLoading(true);
        try {
          const cats = await API.getCategorias();
          setCategorias(cats || []);
        } catch (e) {
          showToast('Erro ao carregar dados', 'error');
        }
        setLoading(false);
      };
      
      useEffect(() => { loadData(); }, []);
      
      useEffect(() => {
        const handler = (e) => {
          if (e.detail === 'novo') setShowModal(true);
        };
        window.addEventListener('admin-categorias-action', handler);
        return () => window.removeEventListener('admin-categorias-action', handler);
      }, []);
      
      const handleSave = async (data, isNew) => {
        try {
          if (isNew) {
            await API.createCategoria(data);
            showToast('Categoria criada!');
          } else {
            await API.updateCategoria(editingCategoria.id, data);
            showToast('Categoria atualizada!');
          }
          setShowModal(false);
          setEditingCategoria(null);
          loadData();
        } catch (e) {
          showToast(e.message, 'error');
        }
      };
      
      const handleDelete = async (id) => {
        const cat = categorias.find(c => c.id === id);
        if (cat.total_partituras > 0) {
          showToast(`Não é possível remover: ${cat.total_partituras} partitura(s) vinculada(s)`, 'error');
          return;
        }
        if (!confirm('Remover esta categoria?')) return;
        try {
          await API.deleteCategoria(id);
          showToast('Categoria removida!');
          loadData();
        } catch (e) {
          showToast(e.message, 'error');
        }
      };
      
      const handleMove = async (index, direction) => {
        const newCategorias = [...categorias];
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= newCategorias.length) return;
        
        [newCategorias[index], newCategorias[targetIndex]] = [newCategorias[targetIndex], newCategorias[index]];
        
        const ordens = newCategorias.map((c, i) => ({ id: c.id, ordem: i + 1 }));
        
        try {
          await API.reorderCategorias(ordens);
          setCategorias(newCategorias);
        } catch (e) {
          showToast(e.message, 'error');
        }
      };
      
      // Obter partituras de uma categoria
      const getPartiturасByCategory = (catId) => {
        return sheets.filter(s => s.category === catId);
      };
      
      return (
        <div style={{ padding: '32px', maxWidth: '900px', margin: '0 auto', fontFamily: 'Outfit, sans-serif' }}>
          {/* Header */}
          <div style={{ marginBottom: '32px', textAlign: 'center' }}>
            <h1 style={{ fontSize: '26px', fontWeight: '700', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', marginBottom: '8px' }}>
              <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
              </svg>
              Categorias
            </h1>
            <p style={{ color: 'var(--text-muted)', fontSize: '14px' }}>
              Organize os gêneros musicais do acervo
            </p>
          </div>
          
          {/* Botão Nova Categoria - Destacado */}
          <div style={{ marginBottom: '24px', display: 'flex', justifyContent: 'center' }}>
            <button onClick={() => { setEditingCategoria(null); setShowModal(true); }} style={{
              display: 'flex', alignItems: 'center', gap: '10px',
              padding: '14px 28px', borderRadius: '12px',
              background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
              color: '#1a1a1a', border: 'none',
              fontSize: '15px', fontWeight: '600', cursor: 'pointer',
              fontFamily: 'Outfit, sans-serif',
              boxShadow: '0 4px 16px rgba(212, 175, 55, 0.3)',
              transition: 'all 0.2s'
            }}
            onMouseEnter={e => e.target.style.transform = 'translateY(-2px)'}
            onMouseLeave={e => e.target.style.transform = 'translateY(0)'}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Nova Categoria
            </button>
          </div>
          
          <div style={{ marginBottom: '20px', color: 'var(--text-secondary)', fontSize: '14px', fontFamily: 'Outfit, sans-serif', textAlign: 'center' }}>
            <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="18 15 12 9 6 15"/>
              </svg>
              Use as setas para reordenar • Clique para ver partituras
            </span>
          </div>
          
          {loading ? (
            <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-secondary)', fontFamily: 'Outfit, sans-serif' }}>
              Carregando...
            </div>
          ) : (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              {categorias.map((cat, index) => {
                const partituras = getPartiturасByCategory(cat.id);
                const isExpanded = expandedCategory === cat.id;
                
                return (
                  <div key={cat.id} style={{
                    background: 'var(--bg-secondary)',
                    borderRadius: '12px', border: '1px solid var(--border)',
                    overflow: 'hidden'
                  }}>
                    <div style={{
                      display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                      padding: '16px 20px'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                          <button onClick={() => handleMove(index, -1)} disabled={index === 0} style={{
                            padding: '4px 8px', border: 'none', background: 'transparent',
                            cursor: index === 0 ? 'default' : 'pointer', opacity: index === 0 ? 0.3 : 1,
                            color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', justifyContent: 'center'
                          }}>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <polyline points="18 15 12 9 6 15"/>
                            </svg>
                          </button>
                          <button onClick={() => handleMove(index, 1)} disabled={index === categorias.length - 1} style={{
                            padding: '4px 8px', border: 'none', background: 'transparent',
                            cursor: index === categorias.length - 1 ? 'default' : 'pointer', opacity: index === categorias.length - 1 ? 0.3 : 1,
                            color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', justifyContent: 'center'
                          }}>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <polyline points="6 9 12 15 18 9"/>
                            </svg>
                          </button>
                        </div>
                        <div style={{
                          width: '48px', height: '48px', borderRadius: '10px',
                          background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)', display: 'flex',
                          alignItems: 'center', justifyContent: 'center',
                          border: '1px solid rgba(212, 175, 55, 0.2)'
                        }}>
                          <CategoryIcon categoryId={cat.id} size={24} color="#D4AF37" />
                        </div>
                        <div>
                          <div style={{ fontWeight: '600', color: 'var(--text-primary)', fontSize: '15px' }}>{cat.nome}</div>
                          <button 
                            onClick={() => setExpandedCategory(isExpanded ? null : cat.id)}
                            style={{
                              fontSize: '13px', color: partituras.length > 0 ? '#D4AF37' : 'var(--text-muted)',
                              background: 'transparent', border: 'none', padding: 0,
                              cursor: partituras.length > 0 ? 'pointer' : 'default',
                              display: 'flex', alignItems: 'center', gap: '4px'
                            }}
                          >
                            {partituras.length} partitura(s)
                            {partituras.length > 0 && (
                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{
                                transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)',
                                transition: 'transform 0.2s'
                              }}>
                                <polyline points="6 9 12 15 18 9"/>
                              </svg>
                            )}
                          </button>
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                        <button onClick={() => { setEditingCategoria(cat); setShowModal(true); }} title="Editar" style={{
                          width: '40px', height: '40px', borderRadius: '10px',
                          background: 'var(--bg-primary)', border: '1px solid var(--border)',
                          color: 'var(--text-secondary)', cursor: 'pointer',
                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                          transition: 'all 0.15s'
                        }}>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                          </svg>
                        </button>
                        <button onClick={() => handleDelete(cat.id)} disabled={cat.total_partituras > 0} title={cat.total_partituras > 0 ? 'Remova as partituras primeiro' : 'Excluir'} style={{
                          width: '40px', height: '40px', borderRadius: '10px',
                          background: cat.total_partituras > 0 ? 'var(--bg-primary)' : 'rgba(231, 76, 60, 0.1)',
                          border: '1px solid ' + (cat.total_partituras > 0 ? 'var(--border)' : 'rgba(231, 76, 60, 0.3)'),
                          color: cat.total_partituras > 0 ? 'var(--text-muted)' : '#e74c3c',
                          cursor: cat.total_partituras > 0 ? 'not-allowed' : 'pointer',
                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                          transition: 'all 0.15s'
                        }}>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                    
                    {/* Lista de partituras expandida */}
                    {isExpanded && partituras.length > 0 && (
                      <div style={{
                        borderTop: '1px solid var(--border)',
                        background: 'var(--bg-primary)',
                        padding: '12px 20px',
                        maxHeight: '200px',
                        overflowY: 'auto'
                      }}>
                        {partituras.map((p, i) => (
                          <div key={p.id} style={{
                            display: 'flex', alignItems: 'center', gap: '10px',
                            padding: '8px 0',
                            borderBottom: i < partituras.length - 1 ? '1px solid var(--border)' : 'none'
                          }}>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" strokeWidth="2">
                              <path d="M9 18V5l12-2v13"/>
                              <circle cx="6" cy="18" r="3"/>
                              <circle cx="18" cy="16" r="3"/>
                            </svg>
                            <span style={{ fontSize: '13px', color: 'var(--text-primary)' }}>{p.title}</span>
                            {p.composer && (
                              <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>— {p.composer}</span>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
          
          {showModal && (
            <CategoriaFormModal
              categoria={editingCategoria}
              onSave={handleSave}
              onClose={() => { setShowModal(false); setEditingCategoria(null); }}
            />
          )}
        </div>
      );
    };
    
    // Modal de Formulário de Categoria
    const CategoriaFormModal = ({ categoria, onSave, onClose }) => {
      const [id, setId] = useState(categoria?.id || '');
      const [nome, setNome] = useState(categoria?.nome || '');
      const [icone, setIcone] = useState(categoria?.icone || categoria?.id || 'default');
      const [descricao, setDescricao] = useState(categoria?.descricao || '');
      const [saving, setSaving] = useState(false);
      
      // Ícones disponíveis para categorias
      const iconesDisponiveis = [
        { id: 'dobrado', nome: 'Trompete (Dobrado)' },
        { id: 'marcha', nome: 'Tambor (Marcha)' },
        { id: 'marcha-funebre', nome: 'Vela (Fúnebre)' },
        { id: 'valsa', nome: 'Clave (Valsa)' },
        { id: 'fantasia', nome: 'Estrela (Fantasia)' },
        { id: 'polaca', nome: 'Coroa (Polaca)' },
        { id: 'bolero', nome: 'Rosa (Bolero)' },
        { id: 'hino', nome: 'Bandeira (Hino)' },
        { id: 'hino-religioso', nome: 'Cruz (Religioso)' },
        { id: 'arranjo', nome: 'Partitura (Arranjo)' },
        { id: 'preludio', nome: 'Clave Sol (Prelúdio)' },
        { id: 'default', nome: 'Nota Musical' },
        { id: 'coral', nome: 'Coral' },
        { id: 'sinfonia', nome: 'Orquestra' },
        { id: 'popular', nome: 'Microfone' },
        { id: 'sacra', nome: 'Igreja' }
      ];
      
      // Componente para renderizar ícone no seletor
      const IconePreview = ({ iconId, size = 20 }) => {
        const icons = {
          'dobrado': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M3 12h3l2-2h4"/>
              <path d="M12 10v4"/>
              <circle cx="12" cy="12" r="6"/>
              <path d="M18 12h3"/>
              <path d="M6 9v6"/>
            </svg>
          ),
          'marcha': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <ellipse cx="12" cy="9" rx="7" ry="3"/>
              <path d="M5 9v7c0 1.7 3.1 3 7 3s7-1.3 7-3V9"/>
              <path d="M5 13c0 1.7 3.1 3 7 3s7-1.3 7-3"/>
              <path d="M3 4l4 5M21 4l-4 5"/>
            </svg>
          ),
          'marcha-funebre': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M12 2c0 2-2 4-2 6s2 3 2 3 2-1 2-3-2-4-2-6z"/>
              <rect x="10" y="11" width="4" height="10" rx="1"/>
              <path d="M8 21h8"/>
            </svg>
          ),
          'valsa': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M12 3c2.5 0 4 1.5 4 3.5 0 3-4 4-4 8"/>
              <circle cx="12" cy="17" r="3"/>
              <path d="M12 14v-3"/>
              <path d="M9 17c0 1.7 1.3 3 3 3"/>
            </svg>
          ),
          'fantasia': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/>
            </svg>
          ),
          'polaca': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M3 18l2-10 4 4 3-6 3 6 4-4 2 10H3z"/>
              <circle cx="5" cy="6" r="1.5"/>
              <circle cx="12" cy="4" r="1.5"/>
              <circle cx="19" cy="6" r="1.5"/>
              <path d="M3 18h18v2H3z"/>
            </svg>
          ),
          'bolero': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="10" r="4"/>
              <path d="M12 6c-2-2-4-1-4 1s2 3 4 3 4-1 4-3-2-3-4-1"/>
              <path d="M12 14v7"/>
              <path d="M9 18c-1.5 0-2.5.5-2.5 1.5"/>
              <path d="M15 18c1.5 0 2.5.5 2.5 1.5"/>
            </svg>
          ),
          'hino': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M4 4v17"/>
              <path d="M4 4h12c2 0 3 1 3 2s-1 2-3 2H8c-2 0-3 1-3 2s1 2 3 2h11"/>
              <circle cx="4" cy="4" r="1.5" fill="currentColor"/>
            </svg>
          ),
          'hino-religioso': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M12 3v18"/>
              <path d="M7 8h10"/>
              <circle cx="12" cy="8" r="5"/>
            </svg>
          ),
          'arranjo': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <path d="M7 8h10M7 12h10M7 16h6"/>
              <circle cx="17" cy="16" r="2" fill="currentColor"/>
            </svg>
          ),
          'preludio': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 18c0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3"/>
              <path d="M12 15V6c0-2 2-3 3-3"/>
              <path d="M12 10c2-1 3-3 3-5"/>
            </svg>
          ),
          'coral': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="8" cy="6" r="2"/>
              <circle cx="16" cy="6" r="2"/>
              <circle cx="12" cy="5" r="2"/>
              <path d="M8 8v4M16 8v4M12 7v5"/>
              <rect x="4" y="12" width="16" height="8" rx="2"/>
            </svg>
          ),
          'sinfonia': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 18V5l12-2v13"/>
              <circle cx="6" cy="18" r="3"/>
              <circle cx="18" cy="16" r="3"/>
            </svg>
          ),
          'popular': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <path d="M12 19v3"/>
              <path d="M8 22h8"/>
            </svg>
          ),
          'sacra': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M18 2H6a2 2 0 0 0-2 2v16l8-4 8 4V4a2 2 0 0 0-2-2z"/>
              <path d="M12 6v6M9 9h6"/>
            </svg>
          ),
          'default': (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="8" cy="18" r="3"/>
              <circle cx="18" cy="16" r="3"/>
              <path d="M18 13V5l-10 2v11"/>
            </svg>
          )
        };
        return icons[iconId] || icons['default'];
      };
      
      const handleSubmit = async () => {
        if (!nome.trim()) return;
        if (!categoria && !id.trim()) return;
        
        setSaving(true);
        // Salva com icone em vez de emoji/cor
        await onSave({ id, nome, icone, descricao, emoji: '', cor: '#D4AF37' }, !categoria);
        setSaving(false);
      };
      
      const gerarId = () => {
        const normalized = nome.trim().toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9\s]/g, '')
          .replace(/\s+/g, '-');
        setId(normalized);
      };
      
      // Gerar ID automaticamente quando nome mudar (apenas para nova categoria)
      useEffect(() => {
        if (!categoria && nome && !id) {
          gerarId();
        }
      }, [nome]);
      
      const inputStyle = {
        width: '100%', padding: '12px 14px', borderRadius: 'var(--radius-sm)',
        border: '1px solid var(--border)', background: 'var(--bg-primary)',
        color: 'var(--text-primary)', fontSize: '14px', marginBottom: '16px'
      };
      
      return (
        <div style={{
          position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)',
          display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000,
          backdropFilter: 'blur(4px)'
        }} onClick={onClose}>
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: '16px',
            padding: '32px', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflowY: 'auto',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
            animation: 'scaleInLogin 0.25s ease-out'
          }} onClick={e => e.stopPropagation()}>
            
            {/* Header */}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '28px' }}>
              <h2 style={{ fontSize: '22px', fontWeight: '600', color: 'var(--text-primary)', margin: 0 }}>
                {categoria ? 'Editar Categoria' : 'Nova Categoria'}
              </h2>
              <button onClick={onClose} style={{
                width: '32px', height: '32px', borderRadius: '8px',
                background: 'var(--bg-primary)', border: '1px solid var(--border)',
                color: 'var(--text-muted)', cursor: 'pointer',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                transition: 'all 0.15s'
              }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            
            <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
              Nome <span style={{ color: '#e74c3c' }}>*</span>
            </label>
            <input
              type="text"
              placeholder="Ex: Música Sacra"
              value={nome}
              onChange={e => setNome(e.target.value)}
              style={{
                width: '100%', padding: '14px 16px', borderRadius: '10px',
                border: '1.5px solid var(--border)', background: 'var(--bg-primary)',
                color: 'var(--text-primary)', fontSize: '15px', marginBottom: '20px',
                transition: 'border-color 0.2s, box-shadow 0.2s'
              }}
            />
            
            <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '10px', color: 'var(--text-secondary)' }}>
              Ícone
            </label>
            <div style={{ 
              display: 'grid', 
              gridTemplateColumns: 'repeat(4, 1fr)', 
              gap: '10px', 
              marginBottom: '20px',
              maxHeight: '200px',
              overflowY: 'auto',
              padding: '4px',
              background: 'var(--bg-primary)',
              borderRadius: '12px',
              border: '1px solid var(--border)'
            }}>
              {iconesDisponiveis.map(ic => (
                <button 
                  key={ic.id} 
                  onClick={() => setIcone(ic.id)} 
                  title={ic.nome}
                  style={{
                    width: '100%',
                    aspectRatio: '1',
                    borderRadius: '10px',
                    background: icone === ic.id 
                      ? 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)' 
                      : 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                    border: icone === ic.id 
                      ? '2px solid #D4AF37' 
                      : '1px solid rgba(212, 175, 55, 0.2)',
                    color: icone === ic.id ? '#1a1a1a' : '#D4AF37',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'all 0.2s',
                    boxShadow: icone === ic.id ? '0 4px 12px rgba(212, 175, 55, 0.3)' : 'none'
                  }}
                >
                  <IconePreview iconId={ic.id} size={24} />
                </button>
              ))}
            </div>
            
            <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-secondary)' }}>
              Descrição (opcional)
            </label>
            <input
              type="text"
              placeholder="Breve descrição da categoria"
              value={descricao}
              onChange={e => setDescricao(e.target.value)}
              style={{
                width: '100%', padding: '14px 16px', borderRadius: '10px',
                border: '1.5px solid var(--border)', background: 'var(--bg-primary)',
                color: 'var(--text-primary)', fontSize: '15px', marginBottom: '20px',
                transition: 'border-color 0.2s'
              }}
            />
            
            {/* Preview */}
            <div style={{ 
              marginBottom: '28px', padding: '16px', 
              background: 'var(--bg-primary)', borderRadius: '12px',
              border: '1px solid var(--border)'
            }}>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                Preview
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '14px' }}>
                <div style={{
                  width: '52px', height: '52px', borderRadius: '12px',
                  background: 'linear-gradient(145deg, #3a3a4a 0%, #2a2a38 100%)',
                  border: '1px solid rgba(212, 175, 55, 0.2)',
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                  color: '#D4AF37'
                }}>
                  <IconePreview iconId={icone} size={26} />
                </div>
                <div>
                  <div style={{ fontWeight: '600', color: 'var(--text-primary)', fontSize: '16px' }}>
                    {nome || 'Nome da Categoria'}
                  </div>
                  {descricao && (
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '2px' }}>
                      {descricao}
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onClose} style={{
                flex: 1, padding: '14px', borderRadius: '10px',
                background: 'var(--bg-primary)', border: '1.5px solid var(--border)',
                color: 'var(--text-primary)', fontSize: '14px', fontWeight: '500', cursor: 'pointer',
                transition: 'all 0.15s'
              }}>
                Cancelar
              </button>
              <button onClick={handleSubmit} disabled={saving || !nome.trim()} style={{
                flex: 1, padding: '14px', borderRadius: '10px',
                background: '#D4AF37', border: 'none',
                color: '#1a1a1a', fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                opacity: (saving || !nome.trim()) ? 0.7 : 1,
                transition: 'all 0.15s'
              }}>
                {saving ? 'Salvando...' : (categoria ? 'Salvar Alterações' : 'Criar Categoria')}
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    // Configurações Admin
    const AdminConfig = () => {
      const { user, setUser, showToast, themeMode, setThemeMode } = useApp();
      const [showChangePin, setShowChangePin] = useState(false);
      const [uploadingPhoto, setUploadingPhoto] = useState(false);
      const fileInputRef = React.useRef(null);
      
      const handleLogout = () => {
        Storage.remove('authToken');
        Storage.remove('user');
        setUser(null);
        window.location.reload();
      };
      
      const handlePhotoChange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        // Validar tamanho (máx 2MB)
        if (file.size > 2 * 1024 * 1024) {
          showToast('Imagem muito grande (máx 2MB)', 'error');
          return;
        }
        
        setUploadingPhoto(true);
        try {
          // Converter para base64
          const reader = new FileReader();
          reader.onload = async (event) => {
            const base64 = event.target.result;
            
            // Salvar no servidor (se API suportar)
            try {
              await API.updateProfile({ foto_perfil: base64 });
              
              // Atualizar estado local
              const updatedUser = { ...user, foto_perfil: base64 };
              setUser(updatedUser);
              Storage.set('user', updatedUser);
              showToast('Foto atualizada com sucesso!');
            } catch (err) {
              // Se API não suportar, salva localmente
              const updatedUser = { ...user, foto_perfil: base64 };
              setUser(updatedUser);
              Storage.set('user', updatedUser);
              showToast('Foto atualizada!');
            }
            setUploadingPhoto(false);
          };
          reader.readAsDataURL(file);
        } catch (err) {
          showToast('Erro ao processar imagem', 'error');
          setUploadingPhoto(false);
        }
      };
      
      const handleRemovePhoto = () => {
        const updatedUser = { ...user, foto_perfil: null };
        setUser(updatedUser);
        Storage.set('user', updatedUser);
        showToast('Foto removida');
      };
      
      return (
        <div style={{ padding: '32px', maxWidth: '600px', margin: '0 auto', fontFamily: 'Outfit, sans-serif' }}>
          <h1 style={{ fontSize: '24px', fontWeight: '700', marginBottom: '24px', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '10px' }}>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Configurações
          </h1>
          
          {/* Seção Foto de Perfil */}
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)',
            padding: '20px', marginBottom: '20px', border: '1px solid var(--border)'
          }}>
            <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '8px' }}>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              Foto de Perfil
            </h3>
            
            <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
              {/* Avatar atual */}
              <div style={{
                width: '80px',
                height: '80px',
                borderRadius: '50%',
                background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
                padding: '3px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 4px 12px rgba(212, 175, 55, 0.3)',
                flexShrink: 0
              }}>
                <div style={{
                  width: '100%',
                  height: '100%',
                  borderRadius: '50%',
                  background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '28px',
                  color: '#F4E4BC',
                  fontWeight: '600',
                  overflow: 'hidden'
                }}>
                  {user?.foto_perfil ? (
                    <img src={user.foto_perfil} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                  ) : (
                    user?.name?.charAt(0) || 'A'
                  )}
                </div>
              </div>
              
              {/* Botões */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                <input 
                  type="file" 
                  ref={fileInputRef} 
                  accept="image/*" 
                  onChange={handlePhotoChange}
                  style={{ display: 'none' }}
                />
                <button 
                  onClick={() => fileInputRef.current?.click()}
                  disabled={uploadingPhoto}
                  style={{
                    padding: '10px 20px', borderRadius: 'var(--radius-sm)',
                    background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                    border: 'none',
                    color: '#F4E4BC', fontSize: '14px', fontWeight: '500', cursor: 'pointer',
                    fontFamily: 'Outfit, sans-serif',
                    opacity: uploadingPhoto ? 0.6 : 1
                  }}
                >
                  {uploadingPhoto ? 'Enviando...' : (
                    <>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ marginRight: '6px' }}>
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                      </svg>
                      Alterar Foto
                    </>
                  )}
                </button>
                {user?.foto_perfil && (
                  <button 
                    onClick={handleRemovePhoto}
                    style={{
                      padding: '8px 16px', borderRadius: 'var(--radius-sm)',
                      background: 'transparent',
                      border: '1px solid var(--border)',
                      color: 'var(--text-secondary)', fontSize: '13px', cursor: 'pointer',
                      fontFamily: 'Outfit, sans-serif'
                    }}
                  >
                    Remover Foto
                  </button>
                )}
              </div>
            </div>
            <p style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '12px', fontFamily: 'Outfit, sans-serif' }}>
              Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 2MB
            </p>
          </div>
          
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)',
            padding: '20px', marginBottom: '20px', border: '1px solid var(--border)'
          }}>
            <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '8px' }}>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              Conta Admin
            </h3>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '12px' }}>
              <div>
                <div style={{ color: 'var(--text-primary)', marginBottom: '4px', fontFamily: 'Outfit, sans-serif' }}>Usuário: <strong>{user?.username}</strong></div>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontFamily: 'Outfit, sans-serif' }}>{user?.name}</div>
              </div>
              <button onClick={() => setShowChangePin(true)} style={{
                padding: '10px 20px', borderRadius: 'var(--radius-sm)',
                background: 'var(--bg-primary)', border: '1px solid var(--border)',
                color: 'var(--text-primary)', fontSize: '14px', cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif'
              }}>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ marginRight: '6px' }}>
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                Alterar PIN
              </button>
            </div>
          </div>
          
          <div style={{
            background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)',
            padding: '20px', marginBottom: '20px', border: '1px solid var(--border)'
          }}>
            <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '12px', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif', display: 'flex', alignItems: 'center', gap: '8px' }}>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              Sobre
            </h3>
            <div style={{ fontSize: '14px', color: 'var(--text-secondary)', lineHeight: '1.6', fontFamily: 'Outfit, sans-serif' }}>
              <p><strong>Acervo Digital</strong> v1.8.1</p>
              <p>Sociedade Filarmônica 25 de Março</p>
              <p>Fundada em 1868 - Feira de Santana, BA</p>
            </div>
          </div>
          
          <button onClick={handleLogout} style={{
            width: '100%', padding: '14px', borderRadius: 'var(--radius-sm)',
            background: '#e74c3c', border: 'none',
            color: '#fff', fontSize: '14px', fontWeight: '500', cursor: 'pointer',
            fontFamily: 'Outfit, sans-serif',
            display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'
          }}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16 17 21 12 16 7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            Sair do Painel Admin
          </button>
          
          {showChangePin && <ChangePinModal isOpen={showChangePin} onClose={() => setShowChangePin(false)} />}
        </div>
      );
    };
    
    // Admin App Principal
    const AdminApp = () => {
      const [activeSection, setActiveSection] = useState('dashboard');
      const [stats, setStats] = useState({});
      const [loading, setLoading] = useState(true);
      const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
      const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
      const { user, theme, themeMode, setThemeMode, showToast } = useApp();
      
      // Detecta mudança de tamanho da tela
      useEffect(() => {
        const handleResize = () => {
          const mobile = window.innerWidth < 768;
          setIsMobile(mobile);
          if (!mobile) setMobileMenuOpen(false);
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      const loadStats = async () => {
        try {
          const data = await API.getEstatisticasAdmin();
          setStats(data || {});
        } catch (e) {
          console.error('Erro ao carregar estatísticas:', e);
        }
        setLoading(false);
      };
      
      useEffect(() => { loadStats(); }, []);
      
      // Navigation helper
      window.adminNav = (section, action) => {
        setActiveSection(section);
        setMobileMenuOpen(false);
        if (action) {
          setTimeout(() => {
            window.dispatchEvent(new CustomEvent(`admin-${section}-action`, { detail: action }));
          }, 100);
        }
      };
      
      const menuItems = [
        { id: 'dashboard', icon: 'dashboard', label: 'Dashboard' },
        { id: 'musicos', icon: 'users', label: 'Músicos' },
        { id: 'partituras', icon: 'music', label: 'Partituras' },
        { id: 'categorias', icon: 'folder', label: 'Categorias' },
        { id: 'config', icon: 'settings', label: 'Configurações' },
      ];
      
      // Ícones do menu como SVG
      const MenuIcon = ({ type, active }) => {
        const color = active ? '#D4AF37' : 'var(--text-secondary)';
        const icons = {
          dashboard: (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
            </svg>
          ),
          users: (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          ),
          music: (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 18V5l12-2v13"/>
              <circle cx="6" cy="18" r="3"/>
              <circle cx="18" cy="16" r="3"/>
            </svg>
          ),
          folder: (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </svg>
          ),
          settings: (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
          )
        };
        return icons[type] || icons.music;
      };
      
      const renderContent = () => {
        switch (activeSection) {
          case 'dashboard': return <AdminDashboard />;
          case 'musicos': return <AdminMusicos />;
          case 'partituras': return <AdminPartituras />;
          case 'categorias': return <AdminCategorias />;
          case 'config': return <AdminConfig />;
          default: return <AdminDashboard />;
        }
      };
      
      // Ícones de tema
      const ThemeIcon = ({ mode }) => {
        if (mode === 'light') return <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>;
        if (mode === 'dark') return <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>;
        return <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>;
      };
      
      const cycleTheme = () => {
        const modes = ['system', 'light', 'dark'];
        const currentIndex = modes.indexOf(themeMode);
        const nextIndex = (currentIndex + 1) % modes.length;
        setThemeMode(modes[nextIndex]);
      };
      
      return (
        <AdminContext.Provider value={{ stats, loading, refreshData: loadStats }}>
          <div style={{ display: 'flex', minHeight: '100vh', background: 'var(--bg-primary)', fontFamily: 'Outfit, sans-serif' }}>
            
            {/* Header Mobile */}
            {isMobile && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                height: '60px',
                background: 'var(--bg-secondary)',
                borderBottom: '1px solid var(--border)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '0 16px',
                zIndex: 1000
              }}>
                {/* Menu Hamburguer */}
                <button
                  onClick={() => setMobileMenuOpen(true)}
                  style={{
                    width: '40px',
                    height: '40px',
                    borderRadius: 'var(--radius-sm)',
                    border: 'none',
                    background: 'transparent',
                    color: 'var(--text-primary)',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                  </svg>
                </button>
                
                {/* Título */}
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <div style={{
                    width: '32px',
                    height: '32px',
                    borderRadius: '50%',
                    background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
                    padding: '2px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <div style={{
                      width: '100%',
                      height: '100%',
                      borderRadius: '50%',
                      background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      overflow: 'hidden'
                    }}>
                      <img src="/assets/images/ui/brasao-256x256.png" alt="Brasão" style={{ width: '75%', height: '75%', objectFit: 'contain' }} />
                    </div>
                  </div>
                  <span style={{ fontWeight: '600', color: 'var(--text-primary)', fontSize: '14px' }}>Painel Admin</span>
                </div>
                
                {/* Botão de Tema */}
                <button
                  onClick={cycleTheme}
                  style={{
                    width: '40px',
                    height: '40px',
                    borderRadius: '50%',
                    border: '1px solid var(--border)',
                    background: 'var(--bg-primary)',
                    color: 'var(--text-primary)',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  <ThemeIcon mode={themeMode} />
                </button>
              </div>
            )}
            
            {/* Overlay Mobile Menu */}
            {isMobile && mobileMenuOpen && (
              <div 
                onClick={() => setMobileMenuOpen(false)}
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0,0,0,0.5)',
                  zIndex: 1001
                }}
              />
            )}
            
            {/* Sidebar - Desktop sempre visível, Mobile como drawer */}
            <div style={{
              width: isMobile ? '280px' : (sidebarCollapsed ? '72px' : '260px'),
              background: 'var(--bg-secondary)',
              borderRight: '1px solid var(--border)',
              display: 'flex',
              flexDirection: 'column',
              transition: isMobile ? 'transform 0.3s ease' : 'width 0.3s ease',
              ...(isMobile ? {
                position: 'fixed',
                top: 0,
                left: 0,
                bottom: 0,
                zIndex: 1002,
                transform: mobileMenuOpen ? 'translateX(0)' : 'translateX(-100%)'
              } : {})
            }}>
              {/* Header com Logo e botão recolher/fechar */}
              <div style={{ padding: sidebarCollapsed && !isMobile ? '16px 12px' : '16px 20px', borderBottom: '1px solid var(--border)' }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', justifyContent: sidebarCollapsed && !isMobile ? 'center' : 'flex-start', flex: 1 }}>
                    {/* Ícone com círculo dourado */}
                    <div style={{
                      width: '40px',
                      height: '40px',
                      borderRadius: '50%',
                      background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
                      padding: '2px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      boxShadow: '0 2px 8px rgba(212, 175, 55, 0.3)',
                      flexShrink: 0
                    }}>
                      <div style={{
                        width: '100%',
                        height: '100%',
                        borderRadius: '50%',
                        background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        overflow: 'hidden'
                      }}>
                        <img src="/assets/images/ui/brasao-256x256.png" alt="Brasão" style={{ width: '75%', height: '75%', objectFit: 'contain' }} />
                      </div>
                    </div>
                    {(!sidebarCollapsed || isMobile) && (
                      <div>
                        <div style={{ fontWeight: '700', color: 'var(--text-primary)', fontSize: '14px', fontFamily: 'Outfit, sans-serif' }}>Acervo Digital</div>
                        <div style={{ fontSize: '11px', color: 'var(--accent)', fontFamily: 'Outfit, sans-serif' }}>Painel Admin</div>
                      </div>
                    )}
                  </div>
                  {/* Botão Fechar (mobile) ou Recolher (desktop) */}
                  {isMobile ? (
                    <button
                      onClick={() => setMobileMenuOpen(false)}
                      style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: 'var(--radius-sm)',
                        border: 'none',
                        background: 'transparent',
                        color: 'var(--text-secondary)',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}
                    >
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </button>
                  ) : !sidebarCollapsed && (
                    <button
                      onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                      title="Recolher menu"
                      style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: 'var(--radius-sm)',
                        border: '1px solid var(--border)',
                        background: 'var(--bg-primary)',
                        color: 'var(--text-secondary)',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.2s'
                      }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/>
                      </svg>
                    </button>
                  )}
                </div>
                {/* Botão expandir quando colapsado (apenas desktop) */}
                {!isMobile && sidebarCollapsed && (
                  <button
                    onClick={() => setSidebarCollapsed(false)}
                    title="Expandir menu"
                    style={{
                      width: '100%',
                      marginTop: '12px',
                      padding: '8px',
                      borderRadius: 'var(--radius-sm)',
                      border: '1px solid var(--border)',
                      background: 'var(--bg-primary)',
                      color: 'var(--text-secondary)',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ transform: 'rotate(180deg)' }}>
                      <path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/>
                    </svg>
                  </button>
                )}
              </div>
              
              {/* User Info - Clicável para ir às configurações */}
              <button 
                onClick={() => { setActiveSection('config'); if (isMobile) setMobileMenuOpen(false); }}
                style={{ 
                  width: '100%',
                  padding: sidebarCollapsed && !isMobile ? '12px' : '16px 20px', 
                  borderBottom: '1px solid var(--border)',
                  background: 'transparent',
                  border: 'none',
                  cursor: 'pointer',
                  transition: 'background 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(212, 175, 55, 0.08)'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                title="Ir para configurações"
              >
                <div style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '10px',
                  justifyContent: sidebarCollapsed && !isMobile ? 'center' : 'flex-start'
                }}>
                  {/* Avatar com círculo dourado estilo brasão */}
                  <div style={{
                    width: '42px',
                    height: '42px',
                    borderRadius: '50%',
                    background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
                    padding: '2px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    boxShadow: '0 2px 6px rgba(212, 175, 55, 0.3)',
                    flexShrink: 0
                  }}>
                    <div style={{
                      width: '100%',
                      height: '100%',
                      borderRadius: '50%',
                      background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '14px',
                      color: '#F4E4BC',
                      fontWeight: '600',
                      fontFamily: 'Outfit, sans-serif',
                      overflow: 'hidden'
                    }}>
                      {user?.foto_perfil ? (
                        <img src={user.foto_perfil} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                      ) : (
                        user?.name?.charAt(0) || 'A'
                      )}
                    </div>
                  </div>
                  {(!sidebarCollapsed || isMobile) && (
                    <div style={{ textAlign: 'left' }}>
                      <div style={{ fontSize: '13px', fontWeight: '500', color: 'var(--text-primary)', fontFamily: 'Outfit, sans-serif' }}>{user?.name}</div>
                      <div style={{ fontSize: '11px', color: 'var(--text-secondary)', fontFamily: 'Outfit, sans-serif' }}>Administrador</div>
                    </div>
                  )}
                </div>
              </button>
              
              {/* Menu */}
              <nav style={{ flex: 1, padding: '12px', overflowY: 'auto' }}>
                {menuItems.map(item => {
                  const isActive = activeSection === item.id;
                  return (
                    <button
                      key={item.id}
                      onClick={() => { setActiveSection(item.id); if (isMobile) setMobileMenuOpen(false); }}
                      title={sidebarCollapsed && !isMobile ? item.label : ''}
                      style={{
                        width: '100%',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        padding: sidebarCollapsed && !isMobile ? '12px' : '12px 16px',
                        borderRadius: 'var(--radius-sm)',
                        border: isActive ? '1px solid var(--accent)' : 'none',
                        background: isActive ? 'rgba(212, 175, 55, 0.15)' : 'transparent',
                        color: isActive ? 'var(--accent)' : 'var(--text-primary)',
                        fontSize: '14px',
                        fontWeight: isActive ? '600' : '400',
                        cursor: 'pointer',
                        marginBottom: '4px',
                        textAlign: 'left',
                        justifyContent: sidebarCollapsed && !isMobile ? 'center' : 'flex-start',
                        fontFamily: 'Outfit, sans-serif',
                        transition: 'all 0.2s'
                      }}
                    >
                      <MenuIcon type={item.icon} active={isActive} />
                      {(!sidebarCollapsed || isMobile) && <span>{item.label}</span>}
                    </button>
                  );
                })}
              </nav>
              
            </div>
            
            {/* Content */}
            <div style={{ 
              flex: 1, 
              overflow: 'auto', 
              position: 'relative',
              ...(isMobile ? { paddingTop: '60px' } : {})
            }}>
              {/* Botão de tema no canto superior direito - apenas desktop */}
              {!isMobile && (
                <button
                  onClick={cycleTheme}
                  title={`Tema: ${themeMode === 'system' ? 'Sistema' : themeMode === 'light' ? 'Claro' : 'Escuro'}`}
                  style={{
                    position: 'fixed',
                    top: '20px',
                    right: '24px',
                    width: '44px',
                    height: '44px',
                    borderRadius: '50%',
                    border: '1px solid var(--border)',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-primary)',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'all 0.2s',
                    zIndex: 100,
                    boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                  }}
                >
                  <ThemeIcon mode={themeMode} />
                </button>
              )}
              {renderContent()}
            </div>
          </div>
        </AdminContext.Provider>
      );
    };

    // Main App
    const App = () => {
      const [activeTab, setActiveTab] = useState('home');
      const [selectedCategory, setSelectedCategory] = useState(null);
      const [selectedComposer, setSelectedComposer] = useState(null);
      const [selectedSheet, setSelectedSheet] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [sheets, setSheets] = useState(() => Storage.get('sheets', generateSampleData()));
      const [user, setUser] = useState(() => Storage.get('user', null));
      const [themeMode, setThemeMode] = useState(() => Storage.get('themeMode', 'system')); // 'light', 'dark', 'system'
      const [favorites, setFavorites] = useState(() => Storage.get('favorites', []));
      const [toast, setToast] = useState(null);
      const [notifications, setNotifications] = useState(() => Storage.get('notifications', generateInitialNotifications()));
      const [showNotifications, setShowNotifications] = useState(false);
      const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
      const [isLoading, setIsLoading] = useState(true);
      const [apiOnline, setApiOnline] = useState(false);
      
      // Carrega dados da API ao iniciar
      useEffect(() => {
        const loadFromAPI = async () => {
          if (!USE_API) {
            setIsLoading(false);
            return;
          }
          
          try {
            // Verifica se API está online
            const isOnline = await API.healthCheck();
            setApiOnline(isOnline);
            
            if (isOnline) {
              // Carrega partituras da API
              const partituras = await API.getPartituras();
              if (partituras && partituras.length > 0) {
                // Mapeia campos da API para o formato do app
                const mappedSheets = partituras.map(p => ({
                  id: String(p.id),
                  title: p.titulo,
                  composer: p.compositor,
                  category: p.categoria_id,
                  year: p.ano,
                  downloads: p.downloads || 0,
                  featured: p.destaque === 1,
                  hasFile: !!p.arquivo_nome,
                  apiId: p.id // Guarda ID original da API
                }));
                setSheets(mappedSheets);
                Storage.set('sheets', mappedSheets);
                console.log('✅ Partituras carregadas da API:', mappedSheets.length);
              }
              
              // Carrega favoritos da API se usuário estiver logado
              const token = Storage.get('authToken', null);
              if (token) {
                try {
                  const favoritosIds = await API.getFavoritosIds();
                  if (favoritosIds && Array.isArray(favoritosIds)) {
                    const favoritosStr = favoritosIds.map(id => String(id));
                    setFavorites(favoritosStr);
                    Storage.set('favorites', favoritosStr);
                    console.log('✅ Favoritos carregados da API:', favoritosStr.length);
                  }
                } catch (e) {
                  console.log('⚠️ Erro ao carregar favoritos:', e);
                }
              }
            } else {
              console.log('⚠️ API offline, usando dados locais');
            }
          } catch (error) {
            console.error('Erro ao carregar da API:', error);
          } finally {
            setIsLoading(false);
          }
        };
        
        loadFromAPI();
      }, []);
      
      // Calcula o tema efetivo (light ou dark) baseado no themeMode
      const getEffectiveTheme = useCallback(() => {
        if (themeMode === 'system') {
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        return themeMode;
      }, [themeMode]);
      
      const [theme, setTheme] = useState(getEffectiveTheme);
      
      // Atualiza tema quando themeMode muda ou quando preferência do sistema muda
      useEffect(() => {
        const updateTheme = () => setTheme(getEffectiveTheme());
        updateTheme();
        
        // Escuta mudanças na preferência do sistema
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', updateTheme);
        return () => mediaQuery.removeEventListener('change', updateTheme);
      }, [themeMode, getEffectiveTheme]);
      
      // Gera notificações iniciais baseadas nas partituras
      function generateInitialNotifications() {
        const now = new Date();
        return [
          { id: '1', type: 'new_sheet', sheetId: '1', title: 'Cisne Branco', message: 'Nova partitura adicionada', date: new Date(now - 2 * 24 * 60 * 60 * 1000).toISOString(), read: false },
          { id: '2', type: 'new_sheet', sheetId: '3', title: 'Saudades', message: 'Nova partitura adicionada', date: new Date(now - 5 * 24 * 60 * 60 * 1000).toISOString(), read: false },
          { id: '3', type: 'new_sheet', sheetId: '6', title: 'Danúbio Azul', message: 'Nova partitura adicionada', date: new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString(), read: true },
        ];
      }
      
      useEffect(() => { document.documentElement.setAttribute('data-theme', theme); }, [theme]);
      useEffect(() => { Storage.set('themeMode', themeMode); }, [themeMode]);
      useEffect(() => { Storage.set('sheets', sheets); }, [sheets]);
      useEffect(() => { Storage.set('user', user); }, [user]);
      useEffect(() => { Storage.set('favorites', favorites); }, [favorites]);
      useEffect(() => { Storage.set('notifications', notifications); }, [notifications]);
      
      const addSheet = useCallback((sheet) => {
        setSheets(prev => [...prev, sheet]);
        // Adiciona notificação quando nova partitura é adicionada
        const newNotification = {
          id: Date.now().toString(),
          type: 'new_sheet',
          sheetId: sheet.id,
          title: sheet.title,
          message: 'Nova partitura adicionada',
          date: new Date().toISOString(),
          read: false
        };
        setNotifications(prev => [newNotification, ...prev]);
      }, []);
      
      const markNotificationAsRead = useCallback((id) => {
        setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
      }, []);
      
      const markAllNotificationsAsRead = useCallback(() => {
        setNotifications(prev => prev.map(n => ({ ...n, read: true })));
      }, []);
      
      const unreadCount = useMemo(() => notifications.filter(n => !n.read).length, [notifications]);
      
      const showToast = useCallback((message, type = 'success') => setToast({ message, type }), []);
      
      const toggleFavorite = useCallback(async (id) => {
        const isFavorito = favorites.includes(id);
        
        // Atualiza localmente primeiro (otimistic update)
        setFavorites(prev => isFavorito ? prev.filter(f => f !== id) : [...prev, id]);
        
        // Sincroniza com API se estiver online e logado
        const token = Storage.get('authToken', null);
        if (USE_API && token) {
          try {
            if (isFavorito) {
              await API.removeFavorito(id);
            } else {
              await API.addFavorito(id);
            }
          } catch (error) {
            // Reverte se der erro
            setFavorites(prev => isFavorito ? [...prev, id] : prev.filter(f => f !== id));
            console.error('Erro ao sincronizar favorito:', error);
          }
        }
      }, [favorites]);
      
      const contextValue = useMemo(() => ({
        activeTab, setActiveTab, selectedCategory, setSelectedCategory, selectedComposer, setSelectedComposer, selectedSheet, setSelectedSheet, searchQuery, setSearchQuery,
        sheets, setSheets, addSheet, user, setUser, theme, themeMode, setThemeMode, showToast, favorites, setFavorites, toggleFavorite,
        notifications, showNotifications, setShowNotifications, markNotificationAsRead, markAllNotificationsAsRead, unreadCount,
        sidebarCollapsed, setSidebarCollapsed, apiOnline, isLoading
      }), [activeTab, selectedCategory, selectedComposer, selectedSheet, searchQuery, sheets, user, theme, themeMode, favorites, notifications, showNotifications, unreadCount, sidebarCollapsed, addSheet, showToast, toggleFavorite, markNotificationAsRead, markAllNotificationsAsRead, apiOnline, isLoading]);
      
      const renderScreen = () => {
        switch (activeTab) {
          case 'home': return <HomeScreen />;
          case 'library': return <LibraryScreen />;
          case 'search': return <SearchScreen />;
          case 'favorites': return <FavoritesScreen />;
          case 'profile': return <ProfileScreen />;
          case 'genres': return <GenresScreen />;
          case 'composers': return <ComposersScreen />;
          default: return <HomeScreen />;
        }
      };
      
      const handleTabChange = (tab) => {
        setActiveTab(tab);
        if (tab !== 'library') setSelectedCategory(null);
      };
      
      // Tela de loading inicial
      if (isLoading) {
        return (
          <div style={{
            position: 'fixed',
            inset: 0,
            background: 'var(--bg-primary)',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '16px'
          }}>
            <div style={{
              width: '72px',
              height: '72px',
              borderRadius: '50%',
              background: 'linear-gradient(145deg, #D4AF37 0%, #B8860B 100%)',
              padding: '3px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              boxShadow: '0 4px 16px rgba(212, 175, 55, 0.3)'
            }}>
              <div style={{
                width: '100%',
                height: '100%',
                borderRadius: '50%',
                background: 'linear-gradient(145deg, #722F37 0%, #5C1A1B 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                overflow: 'hidden',
                padding: '8px'
              }}>
                <img 
                  src="/assets/images/ui/brasao-256x256.png" 
                  alt="Brasão"
                  style={{ width: '100%', height: '100%', objectFit: 'contain' }}
                />
              </div>
            </div>
            <div style={{
              width: '32px',
              height: '32px',
              border: '3px solid var(--border)',
              borderTopColor: 'var(--primary)',
              borderRadius: '50%',
              animation: 'spin 0.8s linear infinite'
            }} />
            <p style={{ color: 'var(--text-muted)', fontSize: '14px' }}>Carregando acervo...</p>
            <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
          </div>
        );
      }
      
      return (
        <AppContext.Provider value={contextValue}>
          <GlobalStyles />
          {/* Se não há usuário logado, mostra tela de login obrigatória */}
          {!user ? (
            <LoginScreen required />
          ) : user.isAdmin ? (
            /* Se usuário é admin, mostra o painel administrativo */
            <AdminApp />
          ) : (
            /* Se usuário comum, mostra o app normal */
            <>
              <DesktopLayout activeTab={activeTab} onTabChange={handleTabChange}>
                {renderScreen()}
              </DesktopLayout>
              <NotificationsPanel />
              <SheetDetailModal />
              <BottomNav activeTab={activeTab} onTabChange={handleTabChange} />
            </>
          )}
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
        </AppContext.Provider>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
